<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TierMaster</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/tiers.css">
    <link rel="stylesheet" href="css/items.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/forced-styles.css">
    <link rel="icon" href="icon/favicon.svg" type="image/svg+xml">
    <!-- åŠ è½½å¤–éƒ¨åº“å’Œæ¨¡å— -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- åŠ è½½è‡ªå®šä¹‰æ¨¡å— -->
    <script src="js/i18n.js" type="module"></script>
    
    <style>
        /* æ·»åŠ å¼ºåˆ¶æ˜¾ç¤ºé€‰æ‹©ä¿¡æ¯å…ƒç´ çš„æ ·å¼ */
        .selection-info.forced-selection-info {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* ç¡®ä¿items-countå…ƒç´ å§‹ç»ˆå¯è§ */
        .items-count {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        /* åœ¨éæ‰‹æœºå±å¹•ä¸‹çš„item-previewæµ®åŠ¨å®šä½ */
        @media screen and (min-width: 768px) {
            .main-container {
                position: relative; /* Keep for potential absolute children if any, but flex mainly for tier-list-container now */
                display: flex; /* Can still be flex to manage tier-list-container */
                align-items: flex-start;
                min-height: 500px; /* This will now primarily affect tier-list-container's environment */
            }
            
            .tier-list-container {
                flex: 1; /* Takes up available space */
                overflow-y: visible;
                /* Add margin to the right to make space for the fixed item-preview */
                margin-right: 320px; /* item-preview width (300px) + gap (e.g., 20px) */
            }
            
            .item-preview {
                position: fixed; /* CHANGED from sticky */
                /* top will be set by JS, transform is still useful */
                transform: translateY(-50%);
                width: 300px; /* Keep existing width */
                max-height: 90vh;
                overflow-y: auto;
                z-index: 5;
                /* flex-shrink: 0; REMOVED as it's no longer a flex item */
                /* left will be set by JS */
            }
        }

        /* åˆ†äº«æ¨¡æ€æ¡†æ ·å¼ */
        .tierlist-preview-container {
            width: 100%;
            max-width: 800px;
            margin: 10px auto;
            background-color: #222;
            border-radius: 8px;
            overflow: hidden;
        }

        .tierlist-preview {
            width: 100%;
            height: 300px;
            overflow: auto;
            position: relative;
            background-color: #2c2c2c;
            display: flex;
            align-items: flex-start; /* æ”¹ä¸ºflex-startï¼Œä½¿å†…å®¹ä»é¡¶éƒ¨å¼€å§‹æ˜¾ç¤º */
            justify-content: center;
            padding-top: 10px; /* æ·»åŠ é¡¶éƒ¨å†…è¾¹è· */
        }

        .preview-content {
            width: 100%;
            position: relative; /* ç¡®ä¿æ°´å°å®šä½æ­£ç¡® */
            padding: 15px;
            background-color: #1a1a1a;
        }

        .social-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .social-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #444;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .social-btn:hover {
            background-color: #555;
        }

        .social-icon {
            font-size: 18px;
        }

        .share-action-buttons {
            margin: 15px 0;
            text-align: center;
        }

        .share-link-container {
            display: flex;
            gap: 10px;
            margin: 10px 0 20px 0;
        }

        .share-modal-input {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #333;
            color: white;
        }

        /* æ°´å°æ ·å¼ */
        .watermark {
            position: absolute;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }
        
        .watermark-bottom {
            bottom: 10px;
            right: 10px;
        }
        
        .watermark-top {
            top: 10px;
            right: 10px;
        }

        /* è¯„è®ºåŒºæ ·å¼ */
        .comment-section {
            margin-top: 0px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            width: calc(100% - 30px);
        }

        .comment-header {
            margin-bottom: 10px;
        }

        .comment-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
        }

        .comment-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
            font-size: 14px;
            transition: border-color 0.3s;
            resize: none;
            word-wrap: break-word;
            word-break: break-all;
        }

        .comment-input:focus {
            border-color: #666;
            outline: none;
        }

        .comment-input::placeholder {
            color: #888;
        }

        .comment-input[disabled] {
            background-color: #222;
            cursor: not-allowed;
        }

        /* è¯„è®ºæ˜¾ç¤ºæ ·å¼ */
        .comment-display {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #333;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-all;
            white-space: pre-wrap;
            cursor: pointer;
        }

        .comment-display:hover {
            background-color: #444;
        }

        .comment-display.editing {
            display: none;
        }

        /* åœ¨é¢„è§ˆå›¾ç‰‡ä¸­æ˜¾ç¤ºè¯„è®ºçš„æ ·å¼ */
        .preview-comments {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .preview-comment-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .preview-comment-thumbnail {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            border-radius: 4px;
            overflow: hidden;
        }

        .preview-comment-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-comment-content {
            flex: 1;
        }

        .preview-comment-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
        }

        .preview-comment-text {
            color: #ddd;
            word-wrap: break-word;
            word-break: break-all;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="site-name">TierMaster</div>
        <div class="header-buttons">
            <div class="language-selector">
                <button class="language-btn" id="language-btn">
                    <i class="lang-icon">ğŸŒ</i>
                </button>
                <div class="language-dropdown" id="language-dropdown">
                    <div class="language-option" data-lang="en">English</div>
                    <div class="language-option" data-lang="zh">ä¸­æ–‡</div>
                    <div class="language-option" data-lang="ja">æ—¥æœ¬èª</div>
                    <div class="language-option" data-lang="ko">í•œêµ­ì–´</div>
                    <div class="language-option" data-lang="es">EspaÃ±ol</div>
                    <div class="language-option" data-lang="fr">FranÃ§ais</div>
                    <div class="language-option" data-lang="de">Deutsch</div>
                    <div class="language-option" data-lang="it">Italiano</div>
                    <div class="language-more">More languages coming soon</div>
                </div>
            </div>
            <button class="btn btn-primary" id="buy-coffee-btn" data-i18n="buyCoffee">Buy Me a Coffee</button>
            <button class="btn btn-secondary" id="contact-btn" data-i18n="contact">Contact</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="title-section">
            <h1 id="main-title">Title</h1>
            <div class="stats">Public - 100 Participants - 1000 Votes</div>
            <div class="stats">10000 View - 1000 Like - 1000 Share</div>
        </div>
        
        <div class="action-buttons">
            <div class="action-btn tooltip" id="your-list-btn" data-i18n="yourList">
                Your List â–¼
            </div>
            <div class="action-btn tooltip" id="setting-btn" data-i18n="settings">
                Settings
            </div>
            <div class="action-btn tooltip" id="share-btn" data-i18n="share">
                Share
            </div>
        </div>
        
        <div class="main-container">
            <div class="tier-list-container">
                <!-- åŠ¨æ€ç”Ÿæˆ tier-row -->
            </div>
            
            <div class="item-preview">
                <h2 class="item-title" data-i18n="noTitle">Item-title</h2>
                <img alt="cover" class="item-image">
                <div class="tier-colors">
                    <!-- åŠ¨æ€ç”Ÿæˆ color-box -->
                </div>
                <div class="preview-buttons">
                    <button class="skip-btn" data-i18n="skip">Skip</button>
                    <!-- next-btn åŠ¨æ€æ’å…¥è¿™é‡Œ -->
                    <button id="delete-preview-btn" class="btn delete-preview-btn" data-i18n="delete">
                        Delete
                    </button>
                </div>
                
                <div class="comment-section">
                    <div class="comment-header">
                        <div class="comment-title" data-i18n="comments">
                            Comments
                        </div>
                    </div>
                    <input id="comment-input" type="text" class="comment-input" placeholder="Write a comment..." data-i18n-placeholder="writeComment">
                </div>
            </div>
        </div>
        
        <div class="items-container">
            <div class="category-header">
                <h2 class="category-title" data-i18n="itemsTitle">Items</h2>
                <div class="action-btn tooltip" id="setting-btn2" data-i18n="settings">
                    Settings
                </div>
                <div class="action-btn tooltip" id="reset-btn" data-i18n="reset">
                    Reset
                </div>
                <div class="action-btn tooltip" id="download-btn" data-i18n="download">
                    Download
                </div>
            </div>
            
            <div class="items-grid">
                <!-- æ¸¸æˆå°é¢å›¾ - ä½¿ç”¨å ä½å›¾ -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay"></div>
    <div id="your-list-modal" class="modal">
        <h2 data-i18n="yourList">Your List</h2>
        <p data-i18n="voteSummary">Most Votes / Average Vote</p>
        <button class="btn btn-secondary" onclick="closeModal()" data-i18n="close">Close</button>
    </div>
    <div id="setting-modal" class="modal">
        <h2 data-i18n="settings">Settings</h2>
        
        <div class="setting-section">
            <h3 data-i18n="basicSettings">Basic Settings</h3>
            <div>
                <label data-i18n="yourName">Your Name</label>
                <input id="creator-name-input" type="text" class="setting-input" placeholder="Your name here">
            </div>
            
            <div>
                <label data-i18n="titleSetting">Title</label>
                <input id="title-input" type="text" class="setting-input" value="Title">
            </div>
        </div>
        
        <div class="setting-section">
            <h3 data-i18n="tierManagement">Tier Management</h3>
            
            <div class="tier-settings-container">
                <table class="tier-settings-table">
                    <thead>
                        <tr>
                            <th data-i18n="move">Move</th>
                            <th data-i18n="tier">Tier</th>
                            <th data-i18n="tierName">Title</th>
                            <th data-i18n="tierLimit">Limit</th>
                            <th data-i18n="delete">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="tier-settings-body">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
                
                <div class="tier-actions">
                    <button id="add-tier-btn" class="btn btn-secondary" data-i18n="addTier">Add Tier</button>
                    <button id="reset-tiers-btn" class="btn btn-secondary" data-i18n="resetTiers">Reset to Default</button>
                </div>
            </div>
        </div>
        
        <div class="setting-section">
            <h3 data-i18n="itemsManagement">Items Management</h3>
            
            <div>
                <label data-i18n="imageSetting">Image Ratio</label>
                <select id="image-ratio-select" class="setting-select">
                    <option value="portrait" data-i18n="imagePortrait">Portrait (2:3)</option>
                    <option value="square" data-i18n="imageSquare">Square (1:1)</option>
                    <option value="landscape" data-i18n="imageLandscape">Landscape (3:2)</option>
                    <option value="round" data-i18n="imageRound">Round</option>
                </select>
            </div>
            
            <div>
                <label data-i18n="items">Items</label>
                <div class="file-selection">
                    <button id="choose-files-btn" class="btn btn-secondary" data-i18n="chooseFiles">
                        Choose Files
                    </button>
                    <span class="selection-info forced-selection-info"></span>
                </div>
                <div class="file-selection file-selection-alt">
                    <button id="type-texts-btn" class="btn btn-secondary" data-i18n="enterText">
                        Type Texts
                    </button>
                </div>
                <div class="clear-items">
                    <button id="clear-items-btn" class="btn btn-secondary clear-btn" data-i18n="clear">
                        Clear
                    </button>
                </div>
                <input type="file" id="file-input" accept="image/*" multiple class="file-input-hidden">
            </div>
        </div>
        
        
        <div class="modal-actions">
            <button id="save-settings-btn" class="btn btn-primary" data-i18n="ok">OK</button>
        </div>
    </div>
    <div id="share-modal" class="modal">
        <h2 data-i18n="shareTitle">Share</h2>
        
        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="tierlist-preview-container">
            <div id="tierlist-preview" class="tierlist-preview">
                <p data-i18n="previewLoading">Loading preview...</p>
            </div>
        </div>
        
        <!-- ä¸‹è½½ä¸ºå›¾ç‰‡æŒ‰é’® -->
        <div class="share-action-buttons">
            <button id="download-image-btn" class="btn btn-primary" data-i18n="downloadAsImage">Download as Image</button>
        </div>
        
        <!-- åˆ†äº«åˆ°ç¤¾äº¤åª’ä½“ -->
        <p data-i18n="shareToSocial">Share to social media:</p>
        <div class="social-buttons">
            <button class="social-btn" data-platform="wechat"><i class="social-icon">ğŸ“±</i> WeChat</button>
            <button class="social-btn" data-platform="twitter"><i class="social-icon">ğŸ¦</i> Twitter/X</button>
            <button class="social-btn" data-platform="reddit"><i class="social-icon">ğŸ‘½</i> Reddit</button>
            <button class="social-btn" data-platform="facebook"><i class="social-icon">ğŸ‘</i> Facebook</button>
            <button class="social-btn" data-platform="weibo"><i class="social-icon">ğŸ“</i> Weibo</button>
        </div>
        
        <!-- åˆ†äº«é“¾æ¥ -->
        <p data-i18n="shareLinkDesc">Copy link and share:</p>
        <div class="share-link-container">
            <input type="text" id="share-link-input" value="https://your-tierlist.com" readonly class="share-modal-input">
            <button id="copy-link-btn" class="btn btn-primary" data-i18n="copy">Copy</button>
        </div>
        
        <button class="btn btn-secondary close-share-modal" data-i18n="close">Close</button>
    </div>
    
    <!-- æ–‡æœ¬è¾“å…¥æ¨¡æ€çª—å£ -->
    <div id="text-input-modal" class="modal">
        <h2 id="text-modal-title" data-i18n="createItemsFromText">Create Items from Text</h2>
        <p id="text-modal-guide" data-i18n="textInputGuide">æ¯è¡Œä»£è¡¨ä¸€ä¸ªitemï¼Œå°†è‡ªåŠ¨åˆ›å»ºå¡ç‰‡</p>
        
        <textarea id="text-input-area" rows="10" class="setting-input"></textarea>
        
        <div class="modal-actions">
            <button id="cancel-text-btn" class="btn btn-secondary" data-i18n="cancel">å–æ¶ˆ</button>
            <button id="generate-cards-btn" class="btn btn-primary" data-i18n="generateCards">ç”Ÿæˆå¡ç‰‡</button>
        </div>
    </div>

    <!-- åœ¨å…¶ä»–æ¨¡æ€çª—å£åé¢æ·»åŠ é‡ç½®ç¡®è®¤å¼¹çª— -->
    <div id="reset-confirm-modal" class="modal">
        <h2 data-i18n="resetConfirmTitle">ç¡®è®¤é‡ç½®</h2>
        <p class="reset-confirm-message" data-i18n="resetConfirmMessage">æ‚¨ç¡®å®šè¦é‡ç½®æ‰€æœ‰åˆ†ç±»å—ï¼Ÿè¿™å°†ä¼šæŠŠæ‰€æœ‰é¡¹ç›®ç§»å›æœªåˆ†ç±»åŒºåŸŸå¹¶æ¸…é™¤æ‰€æœ‰è·³è¿‡çŠ¶æ€ã€‚</p>
        <div class="modal-actions">
            <button id="cancel-reset-btn" class="btn btn-secondary" data-i18n="cancel">å–æ¶ˆ</button>
            <button id="confirm-reset-btn" class="btn btn-primary btn-danger">ç¡®è®¤é‡ç½®</button>
        </div>
    </div>

    <script type="module">
        // ç§»é™¤ items.js å¯¼å…¥
        // import { items } from './items.js';
        // ç§»é™¤ tiers.js å¯¼å…¥
        // import { TierManager } from './tiers.js';
        import i18n from './js/i18n.js';
        import { tierManager } from './js/tierManager.js';
        import { dbManager } from './js/dbManager.js';
        
        // åˆå§‹åŒ–æ—¶è¾“å‡ºtierManagerå¯¹è±¡ï¼Œç¡®è®¤å…¶çŠ¶æ€
        console.log('æ¨¡å—å¯¼å…¥çš„tierManager:', tierManager);

        // ä¸å†éœ€è¦åˆ›å»ºTierManagerå®ä¾‹ï¼Œå› ä¸ºtierManager.jså·²ç»åˆ›å»ºäº†å…¨å±€å®ä¾‹
        // const tierManager = new TierManager();

        // ä¸éœ€è¦ä»localStorageæ¢å¤tierManageré…ç½®ï¼ŒtierManager.jsä¸­å·²ç»å¤„ç†
        // try {
        //     const storedTiers = localStorage.getItem('tiermaker-tiers');
        //     if (storedTiers) {
        //         const tiersData = JSON.parse(storedTiers);
        //         // æ¢å¤tiersæ•°ç»„
        //         if (tiersData.tiers && Array.isArray(tiersData.tiers)) {
        //             tierManager.tiers = tiersData.tiers;
        //         }
        //         // æ¢å¤tieråç§°
        //         if (tiersData.tierNames) {
        //             tierManager.tierNames = tiersData.tierNames;
        //         }
        //         // æ¢å¤tieré™åˆ¶
        //         if (tiersData.tierLimits) {
        //             tierManager.tierLimits = tiersData.tierLimits;
        //         }
        //         console.log('å·²ä»localStorageæ¢å¤tierè®¾ç½®');
        //     }
        // } catch (e) {
        //     console.error('æ¢å¤tierè®¾ç½®æ—¶å‡ºé”™:', e);
        // }
        
        // æ•°æ®ç»“æ„ - ä½¿ç”¨ç©ºæ•°ç»„æ›¿ä»£å¯¼å…¥çš„ items
        let items = []; // åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
        let unclassifiedItems = []; // åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
        let classifiedItems = []; // {id, tier, order}
        let skippedItems = new Set(); // å­˜å‚¨è¢«è·³è¿‡çš„item id

        // äº¤äº’çŠ¶æ€
        let previewSelectedTier = null; // å•å‡»é«˜äº®çš„tier
        let previewConfirmTier = null; // äºŒæ¬¡ç¡®è®¤ç”¨
        let isClassifying = false;

        // é¢„è§ˆç´¢å¼•å’Œæ¨¡å¼
        let previewMode = 'unclassified'; // 'unclassified' or 'classified'
        let previewIdx = 0;

        // è‡ªå®šä¹‰itemsç®¡ç†
        let currentImageRatio = 'portrait'; // é»˜è®¤ä¸ºportrait
        let localItems = []; // å­˜å‚¨æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡
        let imageCache = {}; // å…¨å±€å›¾ç‰‡ç¼“å­˜ï¼Œé¿å…å¼•ç”¨é”™è¯¯

        // åˆå§‹åŒ–è¯„è®ºå­˜å‚¨
        let itemComments = {};

        // ä»localStorageåŠ è½½è¯„è®º
        function loadComments() {
            try {
                const savedComments = localStorage.getItem('tiermaker-comments');
                if (savedComments) {
                    itemComments = JSON.parse(savedComments);
                    console.log('å·²åŠ è½½è¯„è®º:', itemComments);
                }

                // åŒæ—¶ä»IndexedDBåŠ è½½è¯„è®º
                dbManager.loadSettings(['item-comments']).then(settings => {
                    if (settings['item-comments']) {
                        // åˆå¹¶ä»IndexedDBåŠ è½½çš„è¯„è®º
                        itemComments = { ...itemComments, ...settings['item-comments'] };
                        console.log('ä»IndexedDBåŠ è½½è¯„è®º:', settings['item-comments']);
                        // æ›´æ–°æ˜¾ç¤º
                        const { previewId } = getPreviewInfo();
                        if (previewId) {
                            updateCommentDisplay(previewId);
                        }
                    }
                }).catch(error => {
                    console.error('ä»IndexedDBåŠ è½½è¯„è®ºå¤±è´¥:', error);
                });
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                itemComments = {};
            }
        }

        // ä¿å­˜è¯„è®ºåˆ°localStorageå’ŒIndexedDB
        function saveComments() {
            try {
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('tiermaker-comments', JSON.stringify(itemComments));
                console.log('å·²ä¿å­˜è¯„è®ºåˆ°localStorage:', itemComments);

                // ä¿å­˜åˆ°IndexedDB
                dbManager.saveSettings({
                    'item-comments': itemComments
                }).then(() => {
                    console.log('å·²ä¿å­˜è¯„è®ºåˆ°IndexedDB');
                }).catch(error => {
                    console.error('ä¿å­˜è¯„è®ºåˆ°IndexedDBå¤±è´¥:', error);
                });
            } catch (error) {
                console.error('ä¿å­˜è¯„è®ºå¤±è´¥:', error);
            }
        }

        // è®¾ç½®è¯„è®ºè¾“å…¥äº‹ä»¶
        function setupCommentInput() {
            const commentInput = document.getElementById('comment-input');
            if (!commentInput) return;

            // ç¦ç”¨è¯„è®ºè¾“å…¥æ¡†ï¼Œç›´åˆ°æœ‰itemè¢«é€‰ä¸­
            commentInput.disabled = true;

            // ä¿å­˜è¯„è®ºçš„å‡½æ•°
            function saveComment() {
                const { previewId } = getPreviewInfo();
                if (!previewId) return;

                const comment = commentInput.value.trim();
                if (comment) {
                    // ä¿å­˜è¯„è®º
                    itemComments[previewId] = comment;
                    saveComments();
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateCommentDisplay(previewId);
                }
                commentInput.value = '';
            }

            // å¤„ç†å›è½¦é”®ç¡®è®¤
            commentInput.addEventListener('keydown', function(e) {
                const { previewId } = getPreviewInfo();
                if (!previewId) {
                    e.preventDefault();
                    return;
                }

                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveComment();
                }
            });

            // å¤„ç†ç‚¹å‡»å¤–éƒ¨åŒºåŸŸç¡®è®¤
            function handleClickOutside(e) {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¯„è®ºè¾“å…¥æ¡†ï¼Œä¸”è¾“å…¥æ¡†æœ‰å€¼ï¼Œåˆ™ä¿å­˜è¯„è®º
                if (!commentInput.contains(e.target) && commentInput.value.trim()) {
                    saveComment();
                }
            }

            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨åŒºåŸŸçš„äº‹ä»¶ç›‘å¬
            document.addEventListener('click', handleClickOutside);

            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            commentInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // é˜²æ­¢ç‚¹å‡»è¾“å…¥æ¡†æ—¶è§¦å‘å¤–éƒ¨ç‚¹å‡»äº‹ä»¶
            commentInput.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // æ›´æ–°è¯„è®ºæ˜¾ç¤º
        function updateCommentDisplay(itemId) {
            const commentSection = document.querySelector('.comment-section');
            const commentInput = document.getElementById('comment-input');
            
            if (!commentSection || !commentInput) return;

            // ç§»é™¤ç°æœ‰çš„è¯„è®ºæ˜¾ç¤ºï¼ˆåªç§»é™¤.comment-displayï¼Œä¸åŠ¨è¾“å…¥æ¡†ï¼‰
            const existingDisplay = commentSection.querySelector('.comment-display');
            if (existingDisplay) {
                existingDisplay.remove();
            }

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„itemï¼Œç¦ç”¨è¾“å…¥
            if (!itemId) {
                commentInput.disabled = true;
                commentInput.placeholder = i18n.t('selectItemFirst') || 'Select an item to comment';
                commentInput.value = '';
                commentInput.style.display = '';
                return;
            }

            // è·å–è¯„è®ºå†…å®¹
            const comment = itemComments[itemId];
            if (comment) {
                // æœ‰è¯„è®ºæ—¶ï¼Œæ˜¾ç¤ºè¯„è®ºå†…å®¹ï¼Œä¸æ˜¾ç¤ºè¾“å…¥æ¡†
                commentInput.style.display = 'none';
                const displayDiv = document.createElement('div');
                displayDiv.className = 'comment-display';
                displayDiv.textContent = comment;
                // åŒå‡»ç¼–è¾‘
                displayDiv.addEventListener('dblclick', function() {
                    commentInput.value = comment;
                    commentInput.focus();
                    displayDiv.classList.add('editing');
                    commentInput.style.display = '';
                    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                    commentInput.style.height = 'auto';
                    commentInput.style.height = (commentInput.scrollHeight) + 'px';
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å¤–éƒ¨ç‚¹å‡»äº‹ä»¶
                    displayDiv.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                });
                commentSection.insertBefore(displayDiv, commentInput);
            } else {
                // æ²¡æœ‰è¯„è®ºæ—¶ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
                commentInput.style.display = '';
                commentInput.disabled = false;
                commentInput.placeholder = i18n.t('writeComment') || 'Write a comment...';
                commentInput.value = '';
            }
        }

        // ä¿®æ”¹renderItemPreviewå‡½æ•°ï¼Œæ·»åŠ è¯„è®ºç›¸å…³åŠŸèƒ½
        const originalRenderItemPreview = renderItemPreview;
        renderItemPreview = function() {
            originalRenderItemPreview();
            
            const { previewId } = getPreviewInfo();
            updateCommentDisplay(previewId);
        };

        // ä¿®æ”¹downloadTierListAsImageå‡½æ•°ï¼Œæ·»åŠ è¯„è®ºæ˜¾ç¤º
        const originalDownloadTierListAsImage = downloadTierListAsImage;
        downloadTierListAsImage = async function() {
            try {
                showLoadingIndicator('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...');
                
                // è·å–é¢„è§ˆå†…å®¹
                const previewContent = document.querySelector('.preview-content');
                if (!previewContent) {
                    console.error('Preview content not found');
                    hideLoadingIndicator();
                    return;
                }

                // ç§»é™¤å·²æœ‰çš„è¯„è®ºéƒ¨åˆ†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingComments = previewContent.querySelector('.preview-comments');
                if (existingComments) {
                    existingComments.remove();
                }

                // æ·»åŠ è¯„è®ºéƒ¨åˆ† - åœ¨tier listä¹‹å
                const commentsWithItems = Object.entries(itemComments).filter(([id, comment]) => comment.trim());
                const commentElements = [];

                if (commentsWithItems.length > 0) {
                    commentsWithItems.forEach(([id, comment]) => {
                        const item = items.find(i => String(i.id) === String(id));
                        if (!item) return; // Skip if item not found for this comment

                        const commentItem = document.createElement('div');
                        commentItem.className = 'preview-comment-item';
                        
                        // æ·»åŠ ç¼©ç•¥å›¾
                        const thumbnail = document.createElement('div');
                        thumbnail.className = 'preview-comment-thumbnail';
                        const thumbnailImg = document.createElement('img');
                        thumbnailImg.src = item.img;
                        thumbnailImg.alt = item.title || 'Untitled';
                        thumbnail.appendChild(thumbnailImg);
                        
                        // æ·»åŠ è¯„è®ºå†…å®¹å®¹å™¨
                        const content = document.createElement('div');
                        content.className = 'preview-comment-content';
                        
                        const title = document.createElement('div');
                        title.className = 'preview-comment-title';
                        title.textContent = item.title || 'Untitled';
                        
                        const text = document.createElement('div');
                        text.className = 'preview-comment-text';
                        text.textContent = comment;

                        content.appendChild(title);
                        content.appendChild(text);
                        
                        commentItem.appendChild(thumbnail);
                        commentItem.appendChild(content);
                        commentElements.push(commentItem);
                    });
                }

                if (commentElements.length > 0) { // Only add section if there are actual elements
                    const commentsSection = document.createElement('div');
                    commentsSection.className = 'preview-comments';
                    
                    const commentsTitle = document.createElement('h3');
                    commentsTitle.textContent = i18n.t('comments') || 'Comments';
                    commentsTitle.style.color = '#fff';
                    commentsTitle.style.marginBottom = '15px';
                    commentsSection.appendChild(commentsTitle);

                    commentElements.forEach(el => commentsSection.appendChild(el));
                    
                    previewContent.appendChild(commentsSection);
                }

                // ä½¿ç”¨html2canvasåº“è½¬æ¢ä¸ºCanvas
                if (typeof html2canvas !== 'function') {
                    await loadHtml2Canvas();
                }

                const canvas = await html2canvas(previewContent, {
                    backgroundColor: '#1a1a1a',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                // å¦‚æœæ·»åŠ äº†è¯„è®ºéƒ¨åˆ†ï¼Œç°åœ¨ç§»é™¤å®ƒ
                const addedCommentsSection = previewContent.querySelector('.preview-comments');
                if (addedCommentsSection) {
                    previewContent.removeChild(addedCommentsSection);
                }

                // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
                const imgData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = imgData;
                link.download = `TierList_${document.getElementById('main-title').textContent.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5]/g, '_')}_${new Date().toISOString().slice(0,10)}.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                hideLoadingIndicator();
                showSuccessMessage(i18n.t('downloadSuccess') || 'Image downloaded successfully');
            } catch (error) {
                console.error('Error downloading image:', error);
                hideLoadingIndicator();
                alert('Error generating image. Please try again.');
            }
        };

        // åœ¨initå‡½æ•°ä¸­æ·»åŠ è¯„è®ºåŠŸèƒ½åˆå§‹åŒ–
        const initWithComments = init;
        init = function() {
            initWithComments();
            loadComments();
            setupCommentInput();
        };

        function getGlobalPreviewOrder() {
            // å…ˆè¿”å›æ‰€æœ‰æœªåˆ†ç±»é¡¹ç›®ï¼ˆåŒ…æ‹¬è¢«è·³è¿‡çš„é¡¹ç›®ï¼ŒæŒ‰åŸå§‹é¡ºåºï¼‰
            const unclassified = items.map(i => i.id)
                .filter(id => unclassifiedItems.includes(id));
            // ç„¶åè¿”å›æ‰€æœ‰å·²åˆ†ç±»çš„é¡¹ç›®ï¼ˆæŒ‰tieré¡ºåºï¼‰
            const classified = [];
            tierManager.getTiers().forEach(tier => {
                const arr = classifiedItems.filter(ci => ci.tier === tier)
                    .sort((a, b) => a.order - b.order);
                classified.push(...arr.map(ci => ci.id));
            });
            // åˆå¹¶ä¸¤ä¸ªæ•°ç»„
            return [...unclassified, ...classified];
        }

        // è·å–è¿‡æ»¤æ‰è·³è¿‡é¡¹ç›®çš„é¢„è§ˆé¡ºåº - ç”¨äºå†³å®šä¸‹ä¸€ä¸ªè¦æ˜¾ç¤ºçš„é¡¹ç›®
        function getFilteredPreviewOrder() {
            // å…ˆè¿”å›æ‰€æœ‰æœªåˆ†ç±»ä¸”æœªè·³è¿‡çš„é¡¹ç›®ï¼ˆæŒ‰åŸå§‹é¡ºåºï¼‰
            const unclassified = items.map(i => i.id)
                .filter(id => unclassifiedItems.includes(id) && !skippedItems.has(id));
            // ç„¶åè¿”å›æ‰€æœ‰å·²åˆ†ç±»çš„é¡¹ç›®ï¼ˆæŒ‰tieré¡ºåºï¼‰
            const classified = [];
            tierManager.getTiers().forEach(tier => {
                const arr = classifiedItems.filter(ci => ci.tier === tier)
                    .sort((a, b) => a.order - b.order);
                classified.push(...arr.map(ci => ci.id));
            });
            // åˆå¹¶ä¸¤ä¸ªæ•°ç»„
            return [...unclassified, ...classified];
        }

        function getPreviewInfo() {
            const orderArr = getGlobalPreviewOrder();
            const id = orderArr[previewIdx % orderArr.length];
            // ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒç¡®ä¿æ­£ç¡®åŒ¹é…
            const ci = classifiedItems.find(ci => String(ci.id) === String(id));
            const isUnclassified = unclassifiedItems.includes(id) || unclassifiedItems.some(uid => String(uid) === String(id));
            return {
                previewId: id || null,
                previewTier: ci?.tier || null,
                isUnclassified,
                previewMode: isUnclassified ? 'unclassified' : 'classified'
            };
        }

        function disableColorBoxes() {
            document.querySelectorAll('.color-box').forEach(box => {
                box.style.pointerEvents = 'none';
                box.style.opacity = '0.6';
            });
        }
        function enableColorBoxes() {
            document.querySelectorAll('.color-box').forEach(box => {
                if (box.getAttribute('data-disabled') === 'true') return;
                box.style.pointerEvents = 'auto';
                box.style.opacity = '1';
            });
        }

        // ä¿å­˜skippedItemsåˆ°localStorage
        function saveSkippedItems() {
            try {
                localStorage.setItem('tiermaker-skipped-items', JSON.stringify(Array.from(skippedItems)));
                console.log('ä¿å­˜è·³è¿‡é¡¹ç›®:', Array.from(skippedItems));
            } catch (error) {
                console.error('ä¿å­˜è·³è¿‡é¡¹ç›®å¤±è´¥:', error);
            }
        }

        // ä»localStorageåŠ è½½skippedItems
        function loadSkippedItems() {
            try {
                const savedSkippedItems = localStorage.getItem('tiermaker-skipped-items');
                if (savedSkippedItems) {
                    skippedItems = new Set(JSON.parse(savedSkippedItems));
                    console.log('åŠ è½½è·³è¿‡é¡¹ç›®:', Array.from(skippedItems));
                }
            } catch (error) {
                console.error('åŠ è½½è·³è¿‡é¡¹ç›®å¤±è´¥:', error);
                skippedItems = new Set();
            }
        }

        // ä¿®æ”¹gotoNextPreviewå‡½æ•°ï¼Œåœ¨æ ‡è®°ä¸ºè·³è¿‡åä¿å­˜çŠ¶æ€
        function gotoNextPreview(skip = false) {
            console.log('gotoNextPreview called, skip:', skip);
            isClassifying = true;
            disableColorBoxes();
            
            // è·å–å½“å‰é¢„è§ˆçš„é¡¹ç›®
            const { previewId } = getPreviewInfo(); 
            const currentPreviewMode = getPreviewInfo().previewMode;
            console.log('å½“å‰é¢„è§ˆé¡¹ç›®ID:', previewId, 'æ¨¡å¼:', currentPreviewMode);
            
            // å¦‚æœæ˜¯è·³è¿‡æ“ä½œï¼Œå°†å½“å‰é¡¹ç›®æ ‡è®°ä¸ºå·²è·³è¿‡
            if (skip && previewId) {
                console.log('å°†é¡¹ç›®æ ‡è®°ä¸ºå·²è·³è¿‡:', previewId);
                skippedItems.add(previewId);
                saveSkippedItems(); // ä¿å­˜è·³è¿‡çŠ¶æ€
                // åŒæ—¶å°†è·³è¿‡çŠ¶æ€ä¿å­˜åˆ°IndexedDB
                dbManager.saveSettings({
                    'skipped-items': Array.from(skippedItems)
                }).catch(error => {
                    console.error('ä¿å­˜è·³è¿‡çŠ¶æ€åˆ°IndexedDBå¤±è´¥:', error);
                });
                console.log('è·³è¿‡åçš„skippedItems:', Array.from(skippedItems));
            }
            
            // è·å–è¿‡æ»¤åçš„é¡ºåº(ä¸åŒ…æ‹¬è·³è¿‡çš„é¡¹ç›®)
            const filteredOrderArr = getFilteredPreviewOrder();
            console.log('è¿‡æ»¤åçš„å…¨å±€é¡ºåº:', filteredOrderArr);
            
            if (filteredOrderArr.length === 0) {
                // æ²¡æœ‰æœªè·³è¿‡ä¸”æœªåˆ†ç±»çš„é¡¹ç›®ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®å·²åˆ†ç±»
                previewIdx = 0;
                previewMode = 'completed'; // Now updating the global variable, not a constant
                console.log('æ²¡æœ‰æœªè·³è¿‡ä¸”æœªåˆ†ç±»çš„é¡¹ç›®ï¼Œæ˜¾ç¤ºå®ŒæˆçŠ¶æ€');
            } else {
                // æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºï¼šæœªåˆ†ç±»ä¸”æœªè·³è¿‡çš„é¡¹ç›® > å·²åˆ†ç±»é¡¹ç›®
                
                // è·å–æ‰€æœ‰æœªåˆ†ç±»ä¸”æœªè·³è¿‡çš„é¡¹ç›®
                const unclassifiedUnskipped = unclassifiedItems.filter(id => !skippedItems.has(id));
                console.log('æœªåˆ†ç±»ä¸”æœªè·³è¿‡çš„é¡¹ç›®:', unclassifiedUnskipped);
                
                if (unclassifiedUnskipped.length > 0) {
                    // å¦‚æœè¿˜æœ‰æœªåˆ†ç±»ä¸”æœªè·³è¿‡çš„é¡¹ç›®ï¼Œä¼˜å…ˆæ˜¾ç¤ºå®ƒä»¬
                    const nextUnclassified = unclassifiedUnskipped[0]; // å–ç¬¬ä¸€ä¸ª
                    const globalOrder = getGlobalPreviewOrder();
                    previewIdx = globalOrder.indexOf(nextUnclassified);
                    console.log('ä¸‹ä¸€ä¸ªæ˜¾ç¤ºæœªåˆ†ç±»ä¸”æœªè·³è¿‡çš„é¡¹ç›®:', nextUnclassified, 'ç´¢å¼•:', previewIdx);
                } else {
                    // å…³é”®ä¿®æ”¹ï¼šæ‰€æœ‰æœªåˆ†ç±»çš„é¡¹ç›®éƒ½å·²è¢«è·³è¿‡æˆ–åˆ†ç±»å®Œæˆ
                    // åœ¨åˆšåˆšè·³è¿‡æœ€åä¸€ä¸ªé¡¹ç›®çš„æƒ…å†µä¸‹(skip === true)ï¼Œåº”è¯¥æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                    if (skip) {
                        previewMode = 'completed';
                        previewIdx = 0;
                        console.log('åˆšåˆšè·³è¿‡æœ€åä¸€ä¸ªé¡¹ç›®ï¼Œæ˜¾ç¤ºå®ŒæˆçŠ¶æ€');
                    }
                    // åªåœ¨éè·³è¿‡æ“ä½œä¸”å­˜åœ¨å·²åˆ†ç±»é¡¹ç›®çš„æƒ…å†µä¸‹æ˜¾ç¤ºå·²åˆ†ç±»é¡¹ç›®
                    else if (classifiedItems.length > 0) {
                        // è·å–ä¸‹ä¸€ä¸ªå·²åˆ†ç±»é¡¹ç›®
                        const globalOrder = getGlobalPreviewOrder();
                        // æ‰¾åˆ°å½“å‰é¢„è§ˆé¡¹ç›®çš„åä¸€ä¸ªé¡¹ç›®
                        if (previewId) {
                            const currentIdx = globalOrder.indexOf(previewId);
                            if (currentIdx >= 0 && currentIdx < globalOrder.length - 1) {
                                // å­˜åœ¨åä¸€ä¸ªé¡¹ç›®
                                previewIdx = currentIdx + 1;
                            } else {
                                // å¾ªç¯åˆ°ç¬¬ä¸€ä¸ªå·²åˆ†ç±»é¡¹ç›®
                                const firstClassifiedIndex = globalOrder.findIndex(id => 
                                    classifiedItems.some(ci => String(ci.id) === String(id)));
                                previewIdx = firstClassifiedIndex >= 0 ? firstClassifiedIndex : 0;
                            }
                        } else {
                            // ä»ç¬¬ä¸€ä¸ªå·²åˆ†ç±»é¡¹ç›®å¼€å§‹
                            const firstClassifiedIndex = globalOrder.findIndex(id => 
                                classifiedItems.some(ci => String(ci.id) === String(id)));
                            previewIdx = firstClassifiedIndex >= 0 ? firstClassifiedIndex : 0;
                        }
                        console.log('æ˜¾ç¤ºå·²åˆ†ç±»é¡¹ç›®ï¼Œç´¢å¼•:', previewIdx);
                    } else {
                        // æ²¡æœ‰å·²åˆ†ç±»é¡¹ç›®ä¸”æ‰€æœ‰æœªåˆ†ç±»é¡¹ç›®éƒ½è¢«è·³è¿‡ï¼Œæ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                        previewMode = 'completed';
                        previewIdx = 0;
                        console.log('æ‰€æœ‰é¡¹ç›®éƒ½å·²è¢«è·³è¿‡ï¼Œæ˜¾ç¤ºå®ŒæˆçŠ¶æ€');
                    }
                }
            }
            
            console.log('æ–°çš„é¢„è§ˆç´¢å¼•:', previewIdx);
            
            previewSelectedTier = null;
            previewConfirmTier = null;
            
            // å…ˆè®°å½•å½“å‰çš„skippedItemsçŠ¶æ€
            const currentSkipped = new Set(skippedItems);
            
            // é‡æ–°æ¸²æŸ“
            rerenderAll();
            
            // æ£€æŸ¥æ¸²æŸ“åçš„skippedItemsæ˜¯å¦å‘ç”Ÿå˜åŒ–
            setTimeout(() => {
                console.log('æ¸²æŸ“åçš„skippedItems:', Array.from(skippedItems));
                if (currentSkipped.size !== skippedItems.size) {
                    console.log('è­¦å‘Š: skippedItemsåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿäº†å˜åŒ–!');
                }
                isClassifying = false;
                enableColorBoxes();
            }, 0);
        }

        function classifyCurrentItem(tier) {
            const { previewId } = getPreviewInfo();
            console.log('classifyCurrentItem called, previewId:', previewId, 'tier:', tier);
            if (!previewId) return;
            
            // Check tier limit first
            const tierItems = classifiedItems.filter(ci => ci.tier === tier);
            const tierLimit = tierManager.getTierLimit(tier);
            if (tierLimit !== null && tierItems.length >= tierLimit) {
                // Highlight the tier label to show it's at limit
                highlightTierLimitReached(tier);
                return false;
            }
            
            classifiedItems.push({ id: previewId, tier, order: getTierMaxOrder(tier) + 1 });
            
            // ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒä¿®æ”¹æœªåˆ†ç±»åˆ—è¡¨
            unclassifiedItems = unclassifiedItems.filter(id => String(id) !== String(previewId));
            
            // ä¸å†è‡ªåŠ¨é‡ç½®è·³è¿‡çŠ¶æ€ï¼Œé™¤éæ˜¯æ‰‹åŠ¨ç‚¹å‡»é¡¹ç›®
            // skippedItems.delete(previewId);
            
            if (unclassifiedItems.length === 0 && classifiedItems.length > 0) {
                previewMode = 'classified';
                previewIdx = 0;
            } else if (previewIdx >= unclassifiedItems.length) {
                previewIdx = unclassifiedItems.length - 1;
            }
            previewSelectedTier = null;
            previewConfirmTier = null;
            
            // ä¿å­˜çŠ¶æ€
            saveItemsToLocalStorage();
            
            gotoNextPreview();
            return true;
        }
        
        function unclassifyCurrentItem() {
            const { previewId } = getPreviewInfo();
            console.log('unclassifyCurrentItem called, previewId:', previewId);
            if (!previewId) return;
            
            // è·å–åŸå§‹ç´¢å¼•å¹¶åœ¨æ­£ç¡®ä½ç½®æ’å…¥ï¼Œåœ¨ä»classifiedItemsä¸­ç§»é™¤ä¹‹å‰
            const originalItem = items.find(i => String(i.id) === String(previewId));
            // ä½¿ç”¨findIndexè€Œä¸æ˜¯indexOfï¼Œç¡®ä¿ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
            const originalIndex = originalItem ? items.findIndex(i => String(i.id) === String(previewId)) : -1;
            
            // ä»classifiedItemsä¸­ç§»é™¤
            classifiedItems = classifiedItems.filter(ci => String(ci.id) !== String(previewId));
            
            // æ¸…é™¤é¡¹ç›®çš„è·³è¿‡çŠ¶æ€
            skippedItems.delete(previewId);
            saveSkippedItems(); // ä¿å­˜è·³è¿‡çŠ¶æ€æ›´æ–°
            console.log(`å–æ¶ˆåˆ†ç±»é¡¹ç›®å¹¶æ¸…é™¤è·³è¿‡çŠ¶æ€: ID=${previewId}`);
            
            // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹é¡¹ç›®ï¼Œæ·»åŠ åˆ°æœªåˆ†ç±»åˆ—è¡¨æœ«å°¾
            if (originalIndex === -1) {
                unclassifiedItems.push(previewId);
                console.log(`æ‰¾ä¸åˆ°åŸå§‹é¡¹ç›®ç´¢å¼•ï¼Œæ·»åŠ é¡¹ç›®åˆ°æœªåˆ†ç±»åˆ—è¡¨æœ«å°¾: ID=${previewId}`);
                previewMode = 'unclassified';
                previewIdx = unclassifiedItems.indexOf(previewId);
                previewSelectedTier = null;
                previewConfirmTier = null;
                
                // é‡è¦ï¼šä¿å­˜çŠ¶æ€åˆ°æ•°æ®åº“å’ŒlocalStorage
                saveItemsToLocalStorage();
                
                // ç„¶åç»§ç»­é¢„è§ˆ
                gotoNextPreview();
                return;
            }
            
            // å¯»æ‰¾æ­£ç¡®çš„æ’å…¥ä½ç½®
            let insertIndex = 0;
            for (let i = 0; i < unclassifiedItems.length; i++) {
                const currId = unclassifiedItems[i];
                const currItem = items.find(i => String(i.id) === String(currId));
                if (!currItem) continue;
                
                const currIndex = items.findIndex(i => String(i.id) === String(currId));
                
                if (currIndex > originalIndex) {
                    insertIndex = i;
                    break;
                }
                
                if (i === unclassifiedItems.length - 1) {
                    insertIndex = unclassifiedItems.length;
                }
            }
            
            // å½“æœªæ‰¾åˆ°åˆé€‚ä½ç½®æ—¶ï¼Œæ·»åŠ åˆ°æœ€å
            if (insertIndex === 0 && unclassifiedItems.length > 0) {
                const firstIndex = items.findIndex(i => String(i.id) === String(unclassifiedItems[0]));
                if (firstIndex > originalIndex) {
                    insertIndex = 0;
                } else {
                    insertIndex = unclassifiedItems.length;
                }
            }
            
            // åœ¨æ­£ç¡®ä½ç½®æ’å…¥
            if (unclassifiedItems.length === 0) {
                unclassifiedItems.push(previewId);
            } else {
                unclassifiedItems.splice(insertIndex, 0, previewId);
            }
            
            previewMode = 'unclassified';
            previewIdx = unclassifiedItems.indexOf(previewId);
            previewSelectedTier = null;
            previewConfirmTier = null;
            
            // é‡è¦ï¼šä¿å­˜çŠ¶æ€åˆ°æ•°æ®åº“å’ŒlocalStorageï¼Œç¡®ä¿å–æ¶ˆåˆ†ç±»æ“ä½œæŒä¹…åŒ–
            saveItemsToLocalStorage();
            
            // æ‰“å°æ—¥å¿—ï¼Œç¡®è®¤ä¿å­˜çŠ¶æ€
            console.log(`å–æ¶ˆåˆ†ç±»å®Œæˆï¼Œå·²ä¿å­˜çŠ¶æ€: item ID=${previewId}, æ’å…¥ä½ç½®=${insertIndex}, æœªåˆ†ç±»é¡¹ç›®æ•°=${unclassifiedItems.length}`);
            
            // ç»§ç»­é¢„è§ˆ
            gotoNextPreview();
        }
        
        function changeCurrentItemTier(tier) {
            const { previewId, previewTier } = getPreviewInfo();
            console.log('changeCurrentItemTier called, previewId:', previewId, 'tier:', tier);
            if (!previewId) return;
            
            // Skip the limit check if the item is already in this tier
            const currentItem = classifiedItems.find(ci => String(ci.id) === String(previewId));
            if (currentItem && currentItem.tier === tier) {
                // Item is already in this tier, no need to check limits
                gotoNextPreview();
                return true;
            }
            
            // Check tier limit
            const tierItems = classifiedItems.filter(ci => ci.tier === tier);
            const tierLimit = tierManager.getTierLimit(tier);
            if (tierLimit !== null && tierItems.length >= tierLimit) {
                // Highlight the tier label to show it's at limit
                highlightTierLimitReached(tier);
                return false;
            }
            
            const ci = classifiedItems.find(ci => String(ci.id) === String(previewId));
            if (ci) {
                ci.tier = tier;
                ci.order = getTierMaxOrder(tier) + 1;
                reindexTierOrder();
            }
            previewSelectedTier = null;
            previewConfirmTier = null;
            
            // ä¿å­˜çŠ¶æ€
            saveItemsToLocalStorage();
            
            gotoNextPreview();
            return true;
        }
        
        // Function to highlight a tier label when limit is reached
        function highlightTierLimitReached(tier) {
            // Find the tier label
            const tierLabel = document.querySelector(`.tier-label[data-tier="${tier}"]`);
            if (tierLabel) {
                // Find the percent element
                const percentEl = tierLabel.querySelector('.tier-percent');
                if (percentEl) {
                    // Add a highlight animation
                    percentEl.classList.add('highlight-animation');
                    // Remove the animation class after it completes
                    setTimeout(() => {
                        percentEl.classList.remove('highlight-animation');
                    }, 2000);
                }
            }
        }

        // æ¸²æŸ“items-grid
        function renderItemsGrid() {
            const itemsGrid = document.querySelector('.items-grid');
            itemsGrid.innerHTML = '';
            
            unclassifiedItems.forEach(id => {
                const item = items.find(i => String(i.id) === String(id));
                if (!item) {
                    console.warn(`æ¸²æŸ“items-grid: æ‰¾ä¸åˆ°IDä¸º${id}çš„é¡¹ç›®`);
                    return; // è·³è¿‡ä¸å­˜åœ¨çš„item
                }
                
                // åˆ›å»ºå¡ç‰‡
                const card = document.createElement('div');
                card.className = `item-card ratio-${currentImageRatio}`;
                card.setAttribute('data-id', id);
                card.style.overflow = 'hidden';
                
                // æ£€æŸ¥æ˜¯å¦è¢«è·³è¿‡ - ä½¿ç”¨ä¸¥æ ¼çš„å­—ç¬¦ä¸²æ¯”è¾ƒ
                const isSkipped = Array.from(skippedItems).some(skippedId => String(skippedId) === String(id));
                
                // å¦‚æœè¢«è·³è¿‡ï¼Œæ·»åŠ skippedç±»
                if (isSkipped) {
                    card.classList.add('skipped');
                    console.log(`é¡¹ç›®å·²è¢«è·³è¿‡: ID=${id}, æ ‡é¢˜="${item.title}"`);
                }
                
                // åˆ›å»ºå¹¶æ·»åŠ å›¾ç‰‡
                const img = createImageElement(item.img, id, {
                    className: `item-image ratio-${currentImageRatio}`,
                    alt: item.title
                });
                
                card.appendChild(img);
                
                // å¦‚æœè¢«è·³è¿‡ï¼Œæ·»åŠ æ ‡è®°
                if (isSkipped) {
                    card.appendChild(createSkippedBadge());
                }
                
                itemsGrid.appendChild(card);
            });
            
            // æ›´æ–°Itemsè®¡æ•°
            const categoryTitle = document.querySelector('.category-title');
            if (categoryTitle) {
                // è®¡ç®—æœ‰æ•ˆçš„æœªåˆ†ç±»items (æ’é™¤è¢«è·³è¿‡çš„)
                const validUnclassifiedCount = unclassifiedItems.filter(id => !skippedItems.has(id)).length;
                
                // åˆ›å»ºæˆ–æ›´æ–°items-countå…ƒç´ 
                let countSpan = categoryTitle.querySelector('.items-count');
                if (!countSpan) {
                    countSpan = document.createElement('span');
                    countSpan.className = 'items-count';
                    categoryTitle.appendChild(document.createTextNode(' '));
                    categoryTitle.appendChild(countSpan);
                }
                
                // è®¾ç½®æ ·å¼ç¡®ä¿å¯è§
                countSpan.style.display = 'inline-block';
                countSpan.style.visibility = 'visible';
                countSpan.style.opacity = '1';
                
                // æ›´æ–°æ–‡æœ¬å†…å®¹
                countSpan.textContent = `(${validUnclassifiedCount}/${items.length})`;
                
                // ç¡®ä¿categoryTitleçš„åŸºæœ¬æ–‡æœ¬æ˜¯æ­£ç¡®çš„
                const titleText = categoryTitle.childNodes[0];
                if (titleText && titleText.nodeType === Node.TEXT_NODE) {
                    titleText.textContent = i18n.t('itemsTitle') + ' ';
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°æ–‡æœ¬èŠ‚ç‚¹ï¼Œå…ˆæ¸…ç©ºç°æœ‰å†…å®¹å†é‡æ–°åˆ›å»º
                    const currentCount = countSpan.cloneNode(true);
                    categoryTitle.innerHTML = '';
                    categoryTitle.appendChild(document.createTextNode(i18n.t('itemsTitle') + ' '));
                    categoryTitle.appendChild(currentCount);
                }
            }
        }

        // æ¸²æŸ“tiers-list
        function renderTiersList() {
            // æ¸…ç©ºå®¹å™¨
            const tierListContainer = document.querySelector('.tier-list-container');
            tierListContainer.innerHTML = '';
            
            // è°ƒè¯•ä»£ç ï¼šæ£€æŸ¥tierManagerå¯¹è±¡
            console.log('tierManagerå¯¹è±¡:', tierManager);
            console.log('tierManager.getTiersç±»å‹:', typeof tierManager.getTiers);
            
            // å®‰å…¨è·å–tiersæ•°ç»„
            let tiers = [];
            try {
                const tiersResult = tierManager.getTiers();
                console.log('getTiers()ç»“æœ:', tiersResult);
                
                // æ£€æŸ¥ç»“æœæ˜¯å¦ä¸ºæ•°ç»„
                if (Array.isArray(tiersResult)) {
                    tiers = tiersResult;
                } else if (tiersResult && typeof tiersResult === 'object') {
                    // å°è¯•ä»è¿”å›ç»“æœä¸­æå–æ•°æ®
                    console.log('å°è¯•ä»ç»“æœä¸­æå–tiersæ•°ç»„');
                    if (tiersResult.tiers && Array.isArray(tiersResult.tiers)) {
                        tiers = tiersResult.tiers;
                    } else {
                        // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨é»˜è®¤tiers
                        console.warn('ä½¿ç”¨é»˜è®¤tiersæ•°ç»„');
                        tiers = ['S', 'A', 'B', 'C', 'D', 'F'];
                    }
                }
            } catch (error) {
                console.error('è·å–tiersæ—¶å‡ºé”™:', error);
                // ä½¿ç”¨é»˜è®¤å€¼
                tiers = ['S', 'A', 'B', 'C', 'D', 'F'];
            }
            
            // éå†æ‰€æœ‰tier
            tiers.forEach(tier => {
                // åˆ›å»º tier-row
                const row = document.createElement('div');
                row.className = 'tier-row';
                
                // åˆ›å»º tier-label
                const label = document.createElement('div');
                label.className = 'tier-label';
                label.textContent = tierManager.getTierName(tier);
                label.setAttribute('data-tier', tier);
                label.setAttribute('data-original-name', tierManager.getTierName(tier)); // ä¿å­˜åŸå§‹åç§°
                label.style.backgroundColor = tierManager.getTierColor(tier);
                label.style.color = '#333';
                
                // ä½¿æ ‡ç­¾å¯ç¼–è¾‘
                label.setAttribute('title', 'åŒå‡»ç¼–è¾‘');
                label.style.cursor = 'pointer';
                
                // è·å–è¯¥tierä¸‹çš„items
                const tierItems = classifiedItems
                    .filter(ci => ci.tier === tier)
                    .sort((a, b) => a.order - b.order);
                
                // ç™¾åˆ†æ¯”å’Œé™åˆ¶ä¿¡æ¯
                const percent = document.createElement('div');
                percent.className = 'tier-percent';
                const tierLimit = tierManager.getTierLimit(tier);
                if (tierLimit !== null) {
                    percent.textContent = `${tierItems.length}/${tierLimit}`;
                    // å¦‚æœå¿«è¾¾åˆ°æˆ–å·²ç»è¾¾åˆ°é™åˆ¶ï¼Œæ”¹å˜é¢œè‰²
                    if (tierItems.length >= tierLimit) {
                        percent.style.color = 'rgba(255, 0, 0, 0.7)';
                    } else if (tierItems.length >= tierLimit * 0.8) {
                        percent.style.color = 'rgba(255, 165, 0, 0.7)';
                    }
                } else {
                    percent.textContent = `${tierItems.length}`;
                }
                label.appendChild(percent);
                row.appendChild(label);
                
                // tier-content
                const content = document.createElement('div');
                content.className = 'tier-content';
                content.setAttribute('data-tier', tier);
                
                // æ’å…¥è¯¥tierä¸‹çš„item cards
                tierItems.forEach(ci => {
                    // ä»åŸå§‹æ•°ç»„ä¸­æ‰¾åˆ°å®Œæ•´çš„item
                    const originalItem = items.find(i => i.id === ci.id);
                    if (!originalItem) return; // è·³è¿‡ä¸å­˜åœ¨çš„item
                    
                    // åˆ›å»ºä¸€ä¸ªæç®€çš„å¡ç‰‡
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.setAttribute('data-id', ci.id);
                    card.style.overflow = 'hidden';
                    
                    // æ ¹æ®å½“å‰å›¾ç‰‡æ¯”ä¾‹è®¾ç½®å¡ç‰‡å°ºå¯¸
                    const dimensions = getCardDimensionsByRatio(currentImageRatio);
                    card.style.width = dimensions.width;
                    card.style.height = dimensions.height;
                    card.style.display = 'inline-block';
                    card.style.margin = '2px';
                    card.style.position = 'relative';
                    card.style.backgroundColor = '#333'; // æ·»åŠ èƒŒæ™¯è‰²ï¼Œä¾¿äºè¯†åˆ«åŠ è½½çŠ¶æ€
                    
                    // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                    const img = createImageElement(originalItem.img, ci.id, {
                        onLoad: function() {
                            card.style.backgroundColor = ''; // ç§»é™¤èƒŒæ™¯è‰²è¡¨ç¤ºåŠ è½½å®Œæˆ
                        }
                    });
                    
                    // å°†å›¾ç‰‡æ·»åŠ åˆ°å¡ç‰‡
                    card.appendChild(img);
                    
                    // æ·»åŠ å¡ç‰‡åˆ°container
                    content.appendChild(card);
                });
                
                row.appendChild(content);
                tierListContainer.appendChild(row);
            });
            
            // ç”¨setTimeoutç¡®ä¿å›¾ç‰‡æœ‰æœºä¼šåŠ è½½
            setTimeout(() => {
                document.querySelectorAll('.tier-content .item-card img').forEach(img => {
                    if (!img.complete) {
                        img.src = img.src; // é‡æ–°è§¦å‘åŠ è½½
                    }
                });
            }, 50);
            
            // è®¾ç½®tieræ ‡ç­¾çš„åŒå‡»ç¼–è¾‘äº‹ä»¶
            setupTierLabelEditEvents();
        }

        // è®¾ç½®tieræ ‡ç­¾åŒå‡»ç¼–è¾‘äº‹ä»¶
        function setupTierLabelEditEvents() {
            document.querySelectorAll('.tier-label').forEach(label => {
                // ç§»é™¤ç°æœ‰çš„åŒå‡»äº‹ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
                label.removeEventListener('dblclick', handleTierLabelDblClick);
                
                // æ·»åŠ åŒå‡»äº‹ä»¶
                label.addEventListener('dblclick', handleTierLabelDblClick);
            });
        }

        // å¤„ç†tieræ ‡ç­¾çš„åŒå‡»äº‹ä»¶
        function handleTierLabelDblClick(event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            event.stopPropagation();
            
            const label = this;
            const tier = label.getAttribute('data-tier');
            if (!tier) return;
            
            // å¦‚æœæ­£åœ¨æ‹–æ‹½æˆ–åˆ†ç±»ä¸­ï¼Œä¸å…è®¸ç¼–è¾‘
            if (isClassifying) return;
            
            // ä¿å­˜åˆå§‹å†…å®¹ï¼Œç”¨äºå–æ¶ˆç¼–è¾‘
            const originalText = label.getAttribute('data-original-name') || tierManager.getTierName(tier);
            
            // æ’é™¤ç‚¹å‡»åˆ°ç™¾åˆ†æ¯”æ ‡ç­¾çš„æƒ…å†µ
            if (event.target.classList.contains('tier-percent')) return;
            
            // åˆ›å»ºä¸€ä¸ªè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalText;
            input.className = 'tier-edit-input';
            input.style.width = '80%';
            input.style.height = '30px';
            input.style.fontSize = '16px';
            input.style.textAlign = 'center';
            input.style.border = 'none';
            input.style.outline = 'none';
            input.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
            input.style.color = '#333';
            input.style.borderRadius = '4px';
            input.style.margin = '5px auto';
            input.style.display = 'block';
            
            // ä¿å­˜åŸå§‹å†…å®¹
            const percent = label.querySelector('.tier-percent');
            const originalContent = label.innerHTML;
            
            // æ¸…ç©ºæ ‡ç­¾å¹¶æ·»åŠ è¾“å…¥æ¡†
            label.innerHTML = '';
            label.appendChild(input);
            
            // è‡ªåŠ¨èšç„¦
            input.focus();
            input.select();
            
            // ä¿å­˜æ›´æ”¹
            const saveChanges = () => {
                const newName = input.value.trim();
                if (newName && newName !== originalText) {
                    // æ›´æ–°tierManagerä¸­çš„åç§°
                    tierManager.setTierName(tier, newName);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    label.textContent = newName;
                    label.setAttribute('data-original-name', newName);
                    
                    // é‡æ–°æ·»åŠ ç™¾åˆ†æ¯”ä¿¡æ¯
                    if (percent) {
                        label.appendChild(percent);
                    }
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('tiermaker-tiers', JSON.stringify({
                        tiers: tierManager.getTiers(),
                        tierNames: tierManager.tierNames,
                        tierLimits: tierManager.tierLimits
                    }));
                    
                    console.log(`Tieråç§°å·²æ›´æ–°: ${tier} => "${newName}"`);
                } else {
                    // æ¢å¤åŸå§‹å†…å®¹
                    label.innerHTML = originalContent;
                }
            };
            
            // å¤„ç†æŒ‰é”®äº‹ä»¶
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveChanges();
                    input.blur();
                } else if (e.key === 'Escape') {
                    // å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸå§‹å†…å®¹
                    label.innerHTML = originalContent;
                    input.blur();
                }
            });
            
            // å¤„ç†å¤±ç„¦äº‹ä»¶
            input.addEventListener('blur', () => {
                saveChanges();
            });
        }

        // æ¸²æŸ“ItemPreview
        function renderItemPreview() {
            const { previewId, previewMode, previewTier } = getPreviewInfo();
            const previewTitle = document.querySelector('.item-title');
            const skipBtn = document.querySelector('.skip-btn');
            const previewBtns = document.querySelector('.preview-buttons');
            const deleteBtn = document.getElementById('delete-preview-btn');
            
            // æ¸…ç†é¢„è§ˆå®¹å™¨ä¸­çš„æ‰€æœ‰å›¾ç‰‡å…ƒç´ 
            const previewContainer = document.querySelector('.item-preview');
            clearImages(previewContainer);
            
            // åˆ›å»ºæ–°çš„é¢„è§ˆå›¾ç‰‡å…ƒç´ 
            const newImg = document.createElement('img');
            newImg.className = 'item-image';
            
            // åŠ¨æ€ç”Ÿæˆ color-box
            const colorBoxContainer = document.querySelector('.tier-colors');
            colorBoxContainer.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªåˆ†ç±»ä¸”æœªè·³è¿‡çš„é¡¹ç›®
            const unclassifiedUnskippedItems = unclassifiedItems.filter(id => !skippedItems.has(id));
            const hasUnclassifiedUnskippedItems = unclassifiedUnskippedItems.length > 0;
            
            // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºå®ŒæˆçŠ¶æ€ï¼š
            const shouldShowCompleted = (!hasUnclassifiedUnskippedItems && previewMode !== 'classified' && !previewId) || 
                              (items.length > 0 && unclassifiedUnskippedItems.length === 0 && !previewId && previewMode === 'completed');
            
            // Create a grid of color boxes, max 6 per row
            const tiers = tierManager.getTiers();
            
            tiers.forEach((tier, index) => {
                const box = document.createElement('div');
                box.className = 'color-box';
                // Get tier name or custom name
                const displayName = tierManager.getTierName(tier);
                box.title = displayName + ' ' + i18n.t('tierLevel');
                box.style.backgroundColor = tierManager.getTierColor(tier);
                
                // Check if tier is at limit and disable it
                const tierItems = classifiedItems.filter(ci => ci.tier === tier);
                const tierLimit = tierManager.getTierLimit(tier);
                if (tierLimit !== null && tierItems.length >= tierLimit) {
                    if (previewMode !== 'classified' || previewTier !== tier) {
                        box.style.opacity = '0.5';
                        box.title += ' (' + i18n.t('tierLimitReached') + ')';
                        box.setAttribute('data-disabled', 'true');
                    }
                }
                colorBoxContainer.appendChild(box);
            });
            
            // å¤„ç†å›¾ç‰‡å’Œæ ‡é¢˜
            if (previewId && !shouldShowCompleted) {
                const item = items.find(i => String(i.id) === String(previewId));
                if (!item) {
                    console.error(`é¢„è§ˆé”™è¯¯: æ‰¾ä¸åˆ°IDä¸º${previewId}çš„é¡¹ç›®`);
                    newImg.src = generateTextCardImage(i18n.t('errorItemNotFound'));
                    previewTitle.textContent = i18n.t('itemNotExist');
                    deleteBtn.style.display = 'none';
                } else {
                    previewTitle.textContent = item.title || i18n.t('noTitle');
                    deleteBtn.style.display = 'inline-block';
                    const dimensions = getPreviewDimensionsByRatio(currentImageRatio);
                    newImg.style.width = dimensions.width;
                    newImg.style.height = dimensions.height;
                    newImg.style.objectFit = 'cover';
                    if (currentImageRatio === 'round') {
                        newImg.style.borderRadius = '50%';
                    }
                    if (item.isTextGenerated) {
                        if (!item.img || item.img.indexOf('dummyimage.com') > -1) {
                            item.img = generateTextCardImage(item.title || i18n.t('noTitle'));
                            imageCache[item.id] = item.img;
                        }
                        newImg.src = item.img;
                    } else {
                        newImg.src = imageCache[item.id] || item.img;
                    }
                    newImg.onerror = function() {
                        console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ID=${item.id}, URL=${newImg.src}`);
                        newImg.src = generateTextCardImage(i18n.t('imageLoadError'));
                    };
                    if (previewMode === 'classified') {
                        newImg.style.border = `6px solid ${tierManager.getTierColor(previewTier)}`;
                    } else {
                        newImg.style.border = 'none';
                    }
                    console.log(`é¢„è§ˆå›¾ç‰‡: ID=${item.id}, æ ‡é¢˜="${item.title}", å›¾ç‰‡ç±»å‹=${item.isTextGenerated ? 'Canvasæ–‡æœ¬å›¾ç‰‡' : 'æ™®é€šå›¾ç‰‡'}`);
                }
            } else {
                newImg.src = generateTextCardImage(i18n.t('allItemsClassified'));
                previewTitle.textContent = i18n.t('completed');
                deleteBtn.style.display = 'none';
                newImg.style.border = 'none';
                const dimensions = getPreviewDimensionsByRatio(currentImageRatio);
                newImg.style.width = dimensions.width;
                newImg.style.height = dimensions.height;
                newImg.style.objectFit = 'cover';
                if (currentImageRatio === 'round') {
                    newImg.style.borderRadius = '50%';
                } else {
                    newImg.style.borderRadius = '';
                }
            }
            if (colorBoxContainer) {
                previewContainer.insertBefore(newImg, colorBoxContainer);
            } else {
                previewContainer.insertBefore(newImg, previewContainer.firstChild);
            }
            if (previewMode === 'classified' && previewId && !shouldShowCompleted) {
                skipBtn.textContent = i18n.t('cancel');
                if (!document.querySelector('.next-btn')) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'skip-btn next-btn';
                    nextBtn.textContent = i18n.t('next');
                    nextBtn.style.marginLeft = '10px';
                    previewBtns.insertBefore(nextBtn, deleteBtn);
                    nextBtn.onclick = () => gotoNextPreview();
                }
            } else {
                skipBtn.textContent = i18n.t('skip');
                const nextBtn = document.querySelector('.next-btn');
                if (nextBtn) nextBtn.remove();
            }
            document.querySelectorAll('.color-box').forEach((box, idx) => {
                const tier = tierManager.getTiers()[idx % tierManager.getTiers().length];
                if (box.getAttribute('data-disabled') === 'true') return;
                box.style.outline = '';
                if (previewMode === 'classified' && previewTier === tier) {
                    box.style.outline = '3px solid #fff';
                } else if (previewMode === 'unclassified' && previewSelectedTier === tier) {
                    box.style.outline = '3px solid #fff';
                }
            });
            setTimeout(() => {
                isClassifying = false;
                setupColorBoxEvents();
                setupSkipBtn();
                setupDeletePreviewBtn();
                setupItemTitleEditEvent();
                // åªåœ¨è¿™é‡Œè°ƒç”¨ updateCommentDisplayï¼Œç¡®ä¿åªæ›´æ–°è¯„è®ºæ˜¾ç¤ºï¼Œä¸æ’å…¥è¾“å…¥æ¡†
                const { previewId } = getPreviewInfo();
                updateCommentDisplay(previewId);
            }, 0);
        }

        // è®¾ç½®åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function setupDeletePreviewBtn() {
            const deleteBtn = document.getElementById('delete-preview-btn');
            if (deleteBtn) {
                deleteBtn.onclick = () => {
                    const { previewId } = getPreviewInfo();
                    if (!previewId) return;
                    
                    // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å¤„äºç¡®è®¤çŠ¶æ€
                    if (deleteBtn.getAttribute('data-confirm') === 'true') {
                        // å·²ç»åœ¨ç¡®è®¤çŠ¶æ€ï¼Œæ‰§è¡Œåˆ é™¤æ“ä½œ
                        deleteItem(previewId);
                        
                        // æ“ä½œå®Œæˆåæ¢å¤æŒ‰é’®çŠ¶æ€
                        deleteBtn.textContent = i18n.t('delete');
                        deleteBtn.style.background = '#333';
                        deleteBtn.removeAttribute('data-confirm');
                    } else {
                        // è¿›å…¥ç¡®è®¤çŠ¶æ€
                        deleteBtn.textContent = i18n.t('confirm');
                        deleteBtn.style.background = '#ff0000';
                        deleteBtn.setAttribute('data-confirm', 'true');
                        
                        // ç‚¹å‡»å…¶ä»–åŒºåŸŸå–æ¶ˆç¡®è®¤çŠ¶æ€
                        const cancelConfirm = (e) => {
                            if (e.target !== deleteBtn) {
                                deleteBtn.textContent = i18n.t('delete');
                                deleteBtn.style.background = '#333';
                                deleteBtn.removeAttribute('data-confirm');
                                document.removeEventListener('click', cancelConfirm);
                            }
                        };
                        
                        // å»¶è¿Ÿä¸€ä¸‹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
                        setTimeout(() => {
                            document.addEventListener('click', cancelConfirm);
                        }, 10);
                    }
                };
            }
        }

        // é‡å†™æ‹–æ”¾åŠŸèƒ½
        function setupMainDragDrop() {
            // æ¸…é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å’Œæ ·å¼
            const clearEventListeners = (selector, events) => {
                document.querySelectorAll(selector).forEach(element => {
                    events.forEach(event => {
                        element.removeAttribute(`on${event}`);
                        element[`on${event}`] = null;
                    });
                });
            };
            
            // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬
            clearEventListeners('.item-card', ['dragstart', 'dragend', 'dragover', 'dragleave', 'drop']);
            clearEventListeners('.tier-content', ['dragover', 'dragleave', 'drop']);
            
            // ç§»é™¤æ‰€æœ‰æŒ‡ç¤ºå™¨
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            
            // ç¡®ä¿æ‰€æœ‰å¡ç‰‡æ¢å¤æ­£å¸¸æ ·å¼
            document.querySelectorAll('.item-card').forEach(card => {
                card.style.opacity = '1';
                card.classList.remove('drag-highlight');
            });
            
            // é‡ç½®tier-contentèƒŒæ™¯
            document.querySelectorAll('.tier-content').forEach(content => {
                content.style.background = '';
            });
            
            // è®¾ç½®å…¨å±€æ‹–æ”¾å¯¹è±¡
            const dragData = {
                dragging: false,
                itemId: null,
                sourceTier: null,
                indicators: {}
            };
            
            // ä¸ºæ¯ä¸ªtier-contentåˆ›å»ºä¸€ä¸ªä¸“å±æŒ‡ç¤ºå™¨
            document.querySelectorAll('.tier-row').forEach(row => {
                const tierLabel = row.querySelector('.tier-label');
                if (!tierLabel) return;
                
                const tier = tierLabel.getAttribute('data-tier');
                const tierContent = row.querySelector('.tier-content');
                if (!tierContent) return;
                
                // åˆ›å»ºå”¯ä¸€çš„æŒ‡ç¤ºå™¨
                const indicator = document.createElement('div');
                indicator.className = 'drop-indicator';
                indicator.style.display = 'none';
                indicator.setAttribute('data-tier', tier);
                tierContent.appendChild(indicator);
                
                // å­˜å‚¨æŒ‡ç¤ºå™¨å¼•ç”¨
                dragData.indicators[tier] = indicator;
            });
            
            // ä½¿items-gridä¸­çš„å¡ç‰‡å¯æ‹–æ‹½
            document.querySelectorAll('.items-grid .item-card').forEach(card => {
                card.setAttribute('draggable', 'true');
                
                card.ondragstart = (e) => {
                    // è·å–å¡ç‰‡ID - ç›´æ¥ä½¿ç”¨å±æ€§å€¼ï¼Œä¸è¿›è¡Œç±»å‹è½¬æ¢
                    const id = card.getAttribute('data-id');
                    
                    // ä¿å­˜æ‹–æ‹½æ•°æ®åˆ°dataTransfer
                    e.dataTransfer.setData('text/plain', id);
                    e.dataTransfer.effectAllowed = 'move';
                    
                    // é™ä½é€æ˜åº¦
                    card.style.opacity = '0.1';
                    
                    // åŒæ—¶ä¿å­˜åˆ°å…¨å±€å˜é‡
                    dragData.dragging = true;
                    dragData.itemId = id;
                    dragData.sourceTier = null;
                };
                
                card.ondragend = (e) => {
                    card.style.opacity = '1';
                    dragData.dragging = false;
                    dragData.itemId = null;
                    
                    // éšè—æ‰€æœ‰æŒ‡ç¤ºå™¨
                    Object.values(dragData.indicators).forEach(ind => {
                        ind.style.display = 'none';
                    });
                    
                    // ç§»é™¤æ‰€æœ‰é«˜äº®
                    document.querySelectorAll('.drag-highlight').forEach(el => {
                        el.classList.remove('drag-highlight');
                    });
                    
                    // é‡ç½®tierèƒŒæ™¯
                    document.querySelectorAll('.tier-content').forEach(content => {
                        content.style.background = '';
                    });
                };
            });
            
            // ä½¿tier-contentä¸­çš„å¡ç‰‡å¯æ‹–æ‹½
            document.querySelectorAll('.tier-content .item-card').forEach(card => {
                card.setAttribute('draggable', 'true');
                
                card.ondragstart = (e) => {
                    // è·å–å¡ç‰‡ID - ç›´æ¥ä½¿ç”¨å±æ€§å€¼ï¼Œä¸è¿›è¡Œç±»å‹è½¬æ¢
                    const id = card.getAttribute('data-id');
                    
                    // è·å–æºtier
                    const tierContent = card.closest('.tier-content');
                    const tierRow = tierContent.closest('.tier-row');
                    const tierLabel = tierRow.querySelector('.tier-label');
                    const tier = tierLabel.getAttribute('data-tier');
                    
                    // ä¿å­˜æ‹–æ‹½æ•°æ®åˆ°dataTransfer
                    e.dataTransfer.setData('text/plain', id);
                    e.dataTransfer.setData('sourceTier', tier);
                    e.dataTransfer.effectAllowed = 'move';
                    
                    // é™ä½é€æ˜åº¦ - æ›´é€æ˜
                    card.style.opacity = '0.2';
                    
                    // åŒæ—¶ä¿å­˜åˆ°å…¨å±€å˜é‡
                    dragData.dragging = true;
                    dragData.itemId = id;
                    dragData.sourceTier = tier;
                };
                
                card.ondragend = (e) => {
                    card.style.opacity = '1';
                    dragData.dragging = false;
                    dragData.itemId = null;
                    dragData.sourceTier = null;
                    
                    // éšè—æ‰€æœ‰æŒ‡ç¤ºå™¨
                    Object.values(dragData.indicators).forEach(ind => {
                        ind.style.display = 'none';
                    });
                    
                    // ç§»é™¤æ‰€æœ‰é«˜äº®
                    document.querySelectorAll('.drag-highlight').forEach(el => {
                        el.classList.remove('drag-highlight');
                    });
                    
                    // é‡ç½®tierèƒŒæ™¯
                    document.querySelectorAll('.tier-content').forEach(content => {
                        content.style.background = '';
                    });
                };
            });
            
            // å¤„ç†tier-contentçš„æ‹–æ”¾äº‹ä»¶
            document.querySelectorAll('.tier-content').forEach(content => {
                const tierRow = content.closest('.tier-row');
                const tierLabel = tierRow.querySelector('.tier-label');
                const tier = tierLabel.getAttribute('data-tier');
                const indicator = dragData.indicators[tier];
                
                content.ondragover = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (!dragData.dragging && !e.dataTransfer.getData('text/plain')) return;
                    
                    // åŸºæœ¬æ ·å¼
                    content.style.background = 'rgba(255,255,255,0.05)';
                    
                    // ç¡®ä¿æŒ‡ç¤ºå™¨å­˜åœ¨
                    let indicator = dragData.indicators[tier];
                    if (!indicator) {
                        indicator = document.createElement('div');
                        indicator.className = 'drop-indicator';
                        indicator.setAttribute('data-tier', tier);
                        content.appendChild(indicator);
                        dragData.indicators[tier] = indicator;
                    }
                    
                    // è·å–æ‹–æ‹½æ•°æ® - ä¼˜å…ˆä½¿ç”¨å…¨å±€å˜é‡
                    const id = dragData.itemId || e.dataTransfer.getData('text/plain');
                    const sourceTier = dragData.sourceTier || e.dataTransfer.getData('sourceTier');
                    const source = sourceTier ? 'tier-content' : 'items-grid';
                    
                    // æ£€æŸ¥tieré™åˆ¶
                    const tierItems = classifiedItems.filter(ci => ci.tier === tier);
                    const tierLimit = tierManager.getTierLimit(tier);
                    
                    // æ˜¯å¦æ¥è‡ªåŒä¸€tieræˆ–å·²åœ¨è¯¥tier
                    const isFromSameTier = sourceTier === tier;
                    const isAlreadyInTier = classifiedItems.some(ci => String(ci.id) === String(id) && ci.tier === tier);
                    
                    // æ£€æŸ¥tieré™åˆ¶
                    if (!isFromSameTier && !isAlreadyInTier && tierLimit !== null && tierItems.length >= tierLimit) {
                        // è¾¾åˆ°é™åˆ¶ï¼Œæ˜¾ç¤ºçº¢è‰²èƒŒæ™¯
                        content.style.background = 'rgba(255,0,0,0.2)';
                        indicator.style.display = 'none';
                        return;
                    }
                    
                    // è·å–æ‰€æœ‰å¡ç‰‡
                    let items = Array.from(content.querySelectorAll('.item-card'));
                    
                    // æ’é™¤è¢«æ‹–æ‹½çš„å¡ç‰‡
                    if (isFromSameTier) {
                        items = items.filter(item => item.getAttribute('data-id') !== id);
                    }
                    
                    // æ˜¾ç¤ºæ”¾ç½®æŒ‡ç¤ºå™¨
                    const dropInfo = calculateDropPosition(e, content, items);
                    
                    // æ˜¾ç¤ºæŒ‡ç¤ºå™¨
                    indicator.style.display = 'block';
                    indicator.style.left = dropInfo.indicatorX + 'px';
                    
                    // å§‹ç»ˆè®¾ç½®ç²¾ç¡®çš„é«˜åº¦å’Œä½ç½®
                    indicator.style.height = dropInfo.indicatorHeight + 'px';
                    indicator.style.top = dropInfo.indicatorY + 'px';
                    
                    // ç§»é™¤å…¶ä»–é«˜äº®
                    items.forEach(item => item.classList.remove('drag-highlight'));
                    
                    // å¦‚æœæœ‰ç›®æ ‡itemï¼Œé«˜äº®å®ƒ
                    if (dropInfo.targetItem) {
                        dropInfo.targetItem.classList.add('drag-highlight');
                    }
                };
                
                content.ondragleave = (e) => {
                    content.style.background = '';
                    indicator.style.display = 'none';
                    
                    // ç§»é™¤æ‰€æœ‰é«˜äº®
                    content.querySelectorAll('.drag-highlight').forEach(item => {
                        item.classList.remove('drag-highlight');
                    });
                };
                
                content.ondrop = (e) => {
                    e.preventDefault();
                    content.style.background = '';
                    indicator.style.display = 'none';
                    
                    // ç§»é™¤æ‰€æœ‰é«˜äº®
                    content.querySelectorAll('.drag-highlight').forEach(item => {
                        item.classList.remove('drag-highlight');
                    });
                    
                    // è§£ææ‹–æ‹½æ•°æ® - ä»å…¨å±€å˜é‡è·å–ï¼Œæ›´å¯é 
                    const id = dragData.itemId;
                    const sourceTier = dragData.sourceTier;
                    const sourceType = sourceTier ? 'tier' : 'grid';
                    
                    if (!id) return;
                    
                    // è·å–æ”¾ç½®ä½ç½®
                    const items = Array.from(content.querySelectorAll('.item-card'));
                    const dropPosition = calculateDropPosition(e, content, items.filter(item => item.getAttribute('data-id') !== id));
                    
                    // æ„å»ºæ‹–æ”¾æ•°æ®å¯¹è±¡
                    const dropData = {
                        id: id,
                        sourceType: sourceType, 
                        targetType: 'tier',
                        sourceTier: sourceTier, 
                        targetTier: tier,
                        dropIndex: dropPosition.dropIndex
                    };
                    
                    // ä½¿ç”¨é€šç”¨å‡½æ•°å¤„ç†æ‹–æ”¾
                    handleDragDrop(dropData);
                };
            });

            // æ¸…ç†æ‹–åŠ¨ç»“æŸäº‹ä»¶
            document.querySelectorAll('.item-card').forEach(card => {
                const existingDragend = card.ondragend;
                card.ondragend = (e) => {
                    // è°ƒç”¨åŸæ¥çš„å¤„ç†å‡½æ•°
                    if (existingDragend) existingDragend.call(card, e);
                    
                    // éšè—æ‰€æœ‰åŒºåŸŸæŒ‡ç¤ºå™¨
                    if (dragData.areaIndicators) {
                        Object.values(dragData.areaIndicators).forEach(ind => {
                            if (ind) ind.style.display = 'none';
                        });
                    }
                };
            });
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            bindItemClickEvents();
        }

        // å¤„ç†items-gridåˆ°tierçš„æ‹–æ”¾
        function handleGridToTier(id, tier, dropIndex) {
            console.log('å¤„ç†ä»gridåˆ°tierçš„æ‹–æ”¾:', id, tier, dropIndex);
            
            // æŸ¥æ‰¾å®Œæ•´çš„itemæ•°æ®
            const originalItem = items.find(i => String(i.id) === String(id));
            if (!originalItem) {
                console.error(`æ‹–æ”¾é”™è¯¯: æ‰¾ä¸åˆ°IDä¸º${id}çš„é¡¹ç›®`);
                return;
            }
            
            console.log(`æ‹–æ”¾é¡¹ç›®: ID=${id}, Title=${originalItem.title}`);
            
            // è®¡ç®—orderå€¼
            const order = getOrderForPosition(tier, dropIndex);
            
            // æ·»åŠ åˆ°classifiedItems
            classifiedItems.push({ id, tier, order });
            
            // ä»unclassifiedItemsä¸­ç§»é™¤ - ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
            unclassifiedItems = unclassifiedItems.filter(i => String(i) !== String(id));
            
            // æ‰‹åŠ¨æ‹–æ‹½åˆ†ç±»æ—¶é‡ç½®è·³è¿‡çŠ¶æ€
            skippedItems.delete(id);
            saveSkippedItems(); // ä¿å­˜è·³è¿‡çŠ¶æ€æ›´æ–°
            
            // é‡æ–°ç´¢å¼•è¯¥tierä¸­çš„items
            reindexTierItems(tier);
            
            // ä¿å­˜åˆ°localStorageç¡®ä¿æŒä¹…åŒ–
            saveItemsToLocalStorage();
            
            // æ¸…é™¤é¢„è§ˆå›¾ç‰‡
            const previewContainer = document.querySelector('.item-preview');
            const oldImages = previewContainer.querySelectorAll('.item-image');
            oldImages.forEach(img => img.remove());
            
            // é‡æ–°æ¸²æŸ“
            rerenderAll();
        }

        // å¤„ç†åŒä¸€tierå†…çš„æ’åº
        function handleSameTierSort(id, tier, dropIndex) {
            console.log('å¤„ç†åŒä¸€tierå†…æ’åº:', id, tier, dropIndex);
            
            // æŸ¥æ‰¾å®Œæ•´çš„itemæ•°æ®
            const originalItem = items.find(i => i.id === id);
            if (!originalItem) {
                console.error(`æ’åºé”™è¯¯: æ‰¾ä¸åˆ°IDä¸º${id}çš„é¡¹ç›®`);
                        return;
                    }
            
            console.log(`æ’åºé¡¹ç›®: ID=${id}, Title=${originalItem.title}`);
            
            // è·å–è¯¥tierä¸­çš„æ‰€æœ‰items
            const tierItems = classifiedItems
                .filter(ci => ci.tier === tier)
                .sort((a, b) => a.order - b.order);
            
            // æ‰¾åˆ°è¢«æ‹–æ‹½çš„item
            const draggedItem = tierItems.find(ti => ti.id === id);
            if (!draggedItem) return;
            
            // å½“å‰ä½ç½®
            const oldIndex = tierItems.indexOf(draggedItem);
            
            // å¦‚æœä½ç½®æ²¡å˜ï¼Œä¸åšä»»ä½•æ“ä½œ
            if (oldIndex === dropIndex) return;
            
            // ç§»åŠ¨item
            tierItems.splice(oldIndex, 1);
            tierItems.splice(dropIndex, 0, draggedItem);
            
            // é‡æ–°è®¾ç½®order
            tierItems.forEach((item, index) => {
                item.order = index + 1;
            });
            
            // ä¿å­˜åˆ°localStorageç¡®ä¿æŒä¹…åŒ–
            saveItemsToLocalStorage();
            
            // æ¸…é™¤é¢„è§ˆå›¾ç‰‡
            const previewContainer = document.querySelector('.item-preview');
            const oldImages = previewContainer.querySelectorAll('.item-image');
            oldImages.forEach(img => img.remove());
            
            // é‡æ–°æ¸²æŸ“
                        rerenderAll();
        }

        // å¤„ç†ä»ä¸€ä¸ªtieråˆ°å¦ä¸€ä¸ªtierçš„æ‹–æ”¾
        function handleTierToTier(id, sourceTier, targetTier, dropIndex) {
            console.log('å¤„ç†ä»tieråˆ°tierçš„æ‹–æ”¾:', id, sourceTier, targetTier, dropIndex);
            
            // æŸ¥æ‰¾å®Œæ•´çš„itemæ•°æ®
            const originalItem = items.find(i => i.id === id);
            if (!originalItem) {
                console.error(`æ‹–æ”¾é”™è¯¯: æ‰¾ä¸åˆ°IDä¸º${id}çš„é¡¹ç›®`);
                        return;
                    }
            
            console.log(`Tieré—´æ‹–æ”¾é¡¹ç›®: ID=${id}, Title=${originalItem.title}`);
            
            // æ‰¾åˆ°è¢«æ‹–æ‹½çš„item
            const item = classifiedItems.find(ci => ci.id === id);
            if (!item) return;
            
            // æ›´æ–°tier
            item.tier = targetTier;
            
            // è®¡ç®—æ–°çš„order
            item.order = getOrderForPosition(targetTier, dropIndex);
            
            // é‡æ–°ç´¢å¼•ä¸¤ä¸ªtierçš„items
            reindexTierItems(sourceTier);
            reindexTierItems(targetTier);
            
            // ä¿å­˜åˆ°localStorageç¡®ä¿æŒä¹…åŒ–
            saveItemsToLocalStorage();
            
            // æ¸…é™¤é¢„è§ˆå›¾ç‰‡
            const previewContainer = document.querySelector('.item-preview');
            const oldImages = previewContainer.querySelectorAll('.item-image');
            oldImages.forEach(img => img.remove());
            
            // é‡æ–°æ¸²æŸ“
            rerenderAll();
        }

        // éªŒè¯æ‰€æœ‰å¡ç‰‡å›¾ç‰‡æ˜¯å¦æ­£ç¡®
        function verifyCardImages() {
            document.querySelectorAll('.item-card').forEach(card => {
                const cardId = card.getAttribute('data-id');
                const img = card.querySelector('img');
                if (img && cardId) {
                    const cardItem = items.find(i => String(i.id) === String(cardId));
                    if (cardItem && img.src !== cardItem.img && !img.src.includes('Error')) {
                        console.warn(`æ£€æµ‹åˆ°å›¾ç‰‡æºä¸åŒ¹é…: å¡ç‰‡ID=${cardId}, å›¾ç‰‡æº=${img.src}, åº”ä¸º=${cardItem.img}`);
                        // å¼ºåˆ¶é‡ç½®å›¾ç‰‡æº
                        img.src = cardItem.img;
                    }
                }
            });
        }

        // æ˜¾ç¤ºæ”¾ç½®æŒ‡ç¤ºå™¨
        function showDropIndicator(e, container, items, indicator) {
            // è®¡ç®—æ”¾ç½®ä½ç½®
            const dropInfo = calculateDropPosition(e, container, items);
            
            // æ˜¾ç¤ºæŒ‡ç¤ºå™¨
            indicator.style.display = 'block';
            indicator.style.left = dropInfo.indicatorX + 'px';
            indicator.style.height = '90%';
            indicator.style.top = '5%';
            
            // ç§»é™¤å…¶ä»–é«˜äº®
            items.forEach(item => item.classList.remove('drag-highlight'));
            
            // å¦‚æœæœ‰ç›®æ ‡itemï¼Œé«˜äº®å®ƒ
            if (dropInfo.targetItem) {
                dropInfo.targetItem.classList.add('drag-highlight');
            }
        }

        // æ·»åŠ ä¸€ä¸ªå…¨å±€UIä¸€è‡´æ€§æ£€æŸ¥å‡½æ•°
        function ensureUIConsistency() {
            // ç®€åŒ–ç‰ˆ - åªåšæœ€å¿…è¦çš„æ›´æ–°
            try {
                // æ›´æ–°é¡¹ç›®è®¡æ•° - ä½¿ç”¨æ›´è½»é‡çš„æ–¹æ³•
                const itemsCountEl = document.getElementById('items-count');
                if (itemsCountEl) {
                    itemsCountEl.textContent = items.length.toString();
                }
                
                // æ›´æ–°selection-infoå…ƒç´  - ç®€åŒ–å¤„ç†
                const selectionInfo = document.querySelector('.selection-info');
                if (selectionInfo) {
                    const selectedItemsText = i18n.t('selectedItems');
                    selectionInfo.innerHTML = `${selectedItemsText} (${items.length})`;
                    selectionInfo.style.display = 'inline-block';
                }
                
                // æ›´æ–°é¢„è§ˆæ ‡é¢˜ - åªåœ¨å¿…è¦æ—¶æ›´æ–°
                const { previewId } = getPreviewInfo();
                if (previewId) {
                    const item = items.find(i => String(i.id) === String(previewId));
                    if (item) {
                        const previewTitle = document.querySelector('.item-title');
                        if (previewTitle) {
                            previewTitle.textContent = item.title || i18n.t('noTitle');
                        }
                    }
                }
            } catch (e) {
                // æ•è·ä»»ä½•é”™è¯¯ï¼Œé˜²æ­¢å‡½æ•°å¤±è´¥å½±å“æ•´ä¸ªé¡µé¢
                console.error('Error in ensureUIConsistency:', e);
            }
        }

        // é‡æ–°æ¸²æŸ“æ‰€æœ‰å†…å®¹
        function rerenderAll() {
            // æ¸²æŸ“tieråˆ—è¡¨
            renderTiersList();
            // æ¸²æŸ“itemç½‘æ ¼
            renderItemsGrid();
            // æ¸²æŸ“itemé¢„è§ˆ
            renderItemPreview();
            // é‡ç½®æ‰€æœ‰å›¾ç‰‡
            resetAllImages();
            // è®¾ç½®æ‹–æ”¾
            setupMainDragDrop();
            // è®¾ç½®é¢œè‰²é€‰æ‹©å™¨äº‹ä»¶
            setupColorBoxEvents();
            // è®¾ç½®è·³è¿‡æŒ‰é’®äº‹ä»¶
            setupSkipBtn();
            
            // ç¡®ä¿UIä¸€è‡´æ€§
            setTimeout(ensureUIConsistency, 50);
        }

        // ç»‘å®šitemç‚¹å‡»äº‹ä»¶
        function bindItemClickEvents() {
            // items-gridç‚¹å‡»åˆ‡æ¢é¢„è§ˆ
            document.querySelectorAll('.items-grid .item-card').forEach(card => {
                card.onclick = () => {
                    // è·å–å¡ç‰‡ID
                    const id = card.getAttribute('data-id');
                    console.log('ç‚¹å‡»å¡ç‰‡ï¼ŒID:', id);
                    
                    // ç¡®ä¿IDå­˜åœ¨äºitemsæ•°ç»„ä¸­
                    const cardItem = items.find(item => String(item.id) === String(id));
                    if (!cardItem) {
                        console.error('æ‰¾ä¸åˆ°IDä¸º', id, 'çš„é¡¹ç›®');
                        return;
                    }
                    
                    // æ‰‹åŠ¨è®¾ç½®é¢„è§ˆçŠ¶æ€
                    previewIdx = 0; // ä¸´æ—¶è®¾ç½®ä¸º0ï¼Œä¹‹åä¼šæ›´æ–°
                    previewMode = 'unclassified';
                    isClassifying = false; // è§£é”
                    
                    // å¦‚æœæ˜¯ä»gridä¸­ç‚¹å‡»ï¼Œæ¸…é™¤è·³è¿‡çŠ¶æ€
                    skippedItems.delete(id);
                    console.log(`ä»items-gridç‚¹å‡»ï¼Œé‡ç½®è·³è¿‡çŠ¶æ€ï¼ŒID: ${id}`);
                    
                    // æ‰¾åˆ°é¡¹ç›®åœ¨å…¨å±€é¡ºåºä¸­çš„ä½ç½®
                    const orderArr = getGlobalPreviewOrder();
                    const itemIndex = orderArr.findIndex(itemId => String(itemId) === String(id));
                    
                    if (itemIndex !== -1) {
                        previewIdx = itemIndex;
                        console.log('è®¾ç½®é¢„è§ˆç´¢å¼•ä¸º:', previewIdx);
                    } else {
                        console.log('é¡¹ç›®ä¸åœ¨å…¨å±€é¢„è§ˆåºåˆ—ä¸­ï¼Œå°è¯•æ·»åŠ :', id);
                        // å¼ºåˆ¶å°†é¡¹ç›®åŠ å…¥åˆ°æœªåˆ†ç±»åˆ—è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                        if (!unclassifiedItems.includes(id) && !unclassifiedItems.some(uid => String(uid) === String(id))) {
                            unclassifiedItems.push(id);
                            console.log('å°†é¡¹ç›®æ·»åŠ åˆ°æœªåˆ†ç±»åˆ—è¡¨:', id);
                        }
                        
                        // é‡æ–°è®¡ç®—é¢„è§ˆç´¢å¼•
                        const newOrderArr = getGlobalPreviewOrder();
                        const newIndex = newOrderArr.findIndex(itemId => String(itemId) === String(id));
                        
                        if (newIndex !== -1) {
                            previewIdx = newIndex;
                            console.log('é‡æ–°è®¡ç®—åçš„é¢„è§ˆç´¢å¼•:', previewIdx);
                        } else {
                            console.error('ä¸¥é‡é”™è¯¯ï¼šå³ä½¿æ·»åŠ åˆ°æœªåˆ†ç±»åˆ—è¡¨åä»æ‰¾ä¸åˆ°é¡¹ç›®:', id);
                            previewIdx = 0;
                        }
                    }
                    
                    // æ¸…é™¤é¢„è§ˆåŒºåŸŸä¸­çš„æ‰€æœ‰ç°æœ‰å›¾ç‰‡
                    clearImages('.item-preview');
                    
                    // é‡æ–°æ¸²æŸ“é¢„è§ˆ
                    renderItemPreview();
                    setupColorBoxEvents();
                    setupSkipBtn();
                    
                    console.log('é¢„è§ˆä¿¡æ¯:', getPreviewInfo());
                };
            });
            
            // tiers-listç‚¹å‡»åˆ‡æ¢é¢„è§ˆ
            document.querySelectorAll('.tier-content .item-card').forEach(card => {
                card.onclick = () => {
                    // è·å–å¡ç‰‡ID
                    const id = card.getAttribute('data-id');
                    console.log('ç‚¹å‡»tierä¸­çš„å¡ç‰‡ï¼ŒID:', id);
                    
                    // ç¡®ä¿IDå­˜åœ¨äºitemsæ•°ç»„ä¸­
                    const cardItem = items.find(item => String(item.id) === String(id));
                    if (!cardItem) {
                        console.error('æ‰¾ä¸åˆ°IDä¸º', id, 'çš„é¡¹ç›®');
                        return;
                    }
                    
                    // è·å–tierä¿¡æ¯
                    const tierContent = card.closest('.tier-content');
                    const tier = tierContent ? tierContent.getAttribute('data-tier') : null;
                    
                    // æ‰‹åŠ¨è®¾ç½®é¢„è§ˆçŠ¶æ€
                    previewIdx = 0; // ä¸´æ—¶è®¾ç½®ä¸º0ï¼Œä¹‹åä¼šæ›´æ–°
                    previewMode = 'classified';
                    isClassifying = false; // è§£é”
                    
                    // æ³¨æ„ï¼šä¸åƒitems-gridçš„ç‚¹å‡»äº‹ä»¶ï¼Œè¿™é‡Œä¸æ¸…é™¤è·³è¿‡çŠ¶æ€
                    // skippedItems.delete(id); - è¿™è¡Œè¢«ç§»é™¤ï¼Œä¿ç•™è·³è¿‡çŠ¶æ€
                    
                    // æ‰¾åˆ°é¡¹ç›®åœ¨å…¨å±€é¡ºåºä¸­çš„ä½ç½® - ä½¿ç”¨getGlobalPreviewOrderè€Œä¸æ˜¯getFilteredPreviewOrder
                    // å³ä½¿æ˜¯è·³è¿‡çš„é¡¹ç›®ä¹Ÿåº”è¯¥èƒ½åœ¨å…¨å±€é¡ºåºä¸­æ‰¾åˆ°
                    const orderArr = getGlobalPreviewOrder();
                    const itemIndex = orderArr.findIndex(itemId => String(itemId) === String(id));
                    
                    if (itemIndex !== -1) {
                        previewIdx = itemIndex;
                        console.log('è®¾ç½®é¢„è§ˆç´¢å¼•ä¸º:', previewIdx);
                    } else {
                        console.log('é¡¹ç›®ä¸åœ¨å…¨å±€é¢„è§ˆåºåˆ—ä¸­ï¼Œå°è¯•ä¿®å¤:', id);
                        // ç¡®ä¿é¡¹ç›®åœ¨classifiedItemsä¸­
                        const existingItem = classifiedItems.find(ci => String(ci.id) === String(id));
                        if (!existingItem && tier) {
                            classifiedItems.push({ 
                                id,
                                tier, 
                                order: getTierMaxOrder(tier) + 1 
                            });
                            console.log('å°†é¡¹ç›®æ·»åŠ åˆ°å·²åˆ†ç±»åˆ—è¡¨:', id, 'çº§åˆ«:', tier);
                        }
                        
                        // ç¡®ä¿é¡¹ç›®ä¸åœ¨æœªåˆ†ç±»åˆ—è¡¨ä¸­
                        unclassifiedItems = unclassifiedItems.filter(itemId => String(itemId) !== String(id));
                        
                        // é‡æ–°è®¡ç®—é¢„è§ˆç´¢å¼•
                        const newOrderArr = getGlobalPreviewOrder();
                        const newIndex = newOrderArr.findIndex(itemId => String(itemId) === String(id));
                        
                        if (newIndex !== -1) {
                            previewIdx = newIndex;
                            console.log('é‡æ–°è®¡ç®—åçš„é¢„è§ˆç´¢å¼•:', previewIdx);
                        } else {
                            console.error('ä¸¥é‡é”™è¯¯ï¼šå³ä½¿æ·»åŠ åˆ°å·²åˆ†ç±»åˆ—è¡¨åä»æ‰¾ä¸åˆ°é¡¹ç›®:', id);
                            previewIdx = 0;
                        }
                    }
                    
                    // æ¸…é™¤é¢„è§ˆåŒºåŸŸä¸­çš„æ‰€æœ‰ç°æœ‰å›¾ç‰‡
                    clearImages('.item-preview');
                    
                    // é‡æ–°æ¸²æŸ“é¢„è§ˆ
                    renderItemPreview();
                    setupColorBoxEvents();
                    setupSkipBtn();
                    
                    console.log('é¢„è§ˆä¿¡æ¯:', getPreviewInfo());
                };
            });
        }

        // æ ¹æ®tierå’Œindexè·å–æ­£ç¡®çš„orderå€¼
        function getOrderForPosition(tier, insertIndex) {
            const tierItems = classifiedItems
                .filter(ci => ci.tier === tier)
                .sort((a, b) => a.order - b.order);
            
            // å¦‚æœtieræ˜¯ç©ºçš„
            if (tierItems.length === 0) {
                return 1;
            }
            
            // å¦‚æœè¦æ”¾åœ¨æœ€å‰é¢
            if (insertIndex === 0) {
                return tierItems[0].order - 1;
            }
            
            // å¦‚æœè¦æ”¾åœ¨æœ€åé¢
            if (insertIndex >= tierItems.length) {
                return tierItems[tierItems.length - 1].order + 1;
            }
            
            // æ”¾åœ¨ä¸­é—´
            const prevOrder = tierItems[insertIndex - 1].order;
            const nextOrder = tierItems[insertIndex].order;
            return (prevOrder + nextOrder) / 2;
        }

        // é‡æ–°ç´¢å¼•æŒ‡å®štierä¸­æ‰€æœ‰itemsçš„order
        function reindexTierItems(tier) {
            const tierItems = classifiedItems
                .filter(ci => ci.tier === tier)
                .sort((a, b) => a.order - b.order);
            
            // é‡æ–°åˆ†é…orderå€¼ï¼Œä»1å¼€å§‹ï¼Œé—´éš”1
            tierItems.forEach((item, index) => {
                item.order = index + 1;
            });
        }

        // é‡æ–°ç´¢å¼•æ‰€æœ‰tierçš„order
        function reindexTierOrder() {
            tierManager.getTiers().forEach(tier => {
                const arr = classifiedItems.filter(ci => ci.tier === tier);
                arr.sort((a, b) => a.order - b.order);
                arr.forEach((ci, idx) => ci.order = idx + 1);
            });
        }

        // è®¡ç®—æ”¾ç½®ä½ç½®
        function calculateDropPosition(e, container, items) {
            const containerRect = container.getBoundingClientRect();
            const mouseX = e.clientX - containerRect.left;
            const mouseY = e.clientY - containerRect.top;
            
            // å¦‚æœæ²¡æœ‰itemsï¼Œè¿”å›é»˜è®¤å€¼æŒ‡ç¤ºæ”¾åœ¨ä¸­é—´
            if (items.length === 0) {
                return {
                    dropIndex: 0,
                    indicatorX: containerRect.width / 2,
                    indicatorY: Math.max(10, mouseY - 30),
                    indicatorHeight: 60,
                    targetItem: null
                };
            }
            
            // è®¡ç®—æ¯ä¸ªitemçš„ä½ç½®å’Œè·ç¦»
            const itemsWithPosition = items.map(item => {
                const rect = item.getBoundingClientRect();
                const centerX = rect.left - containerRect.left + rect.width / 2;
                const centerY = rect.top - containerRect.top + rect.height / 2;
                const distance = Math.sqrt(
                    Math.pow(mouseX - centerX, 2) + 
                    Math.pow(mouseY - centerY, 2)
                );
                return { 
                    item, 
                    rect,
                    centerX, 
                    centerY, 
                    distance,
                    left: rect.left - containerRect.left,
                    right: rect.right - containerRect.left,
                    top: rect.top - containerRect.top,
                    bottom: rect.bottom - containerRect.top,
                    width: rect.width,
                    height: rect.height
                };
            });
            
            // æŒ‰è·ç¦»æ’åº
            itemsWithPosition.sort((a, b) => a.distance - b.distance);
            
            // æ‰¾åˆ°æœ€è¿‘çš„é¡¹ç›®
            const closest = itemsWithPosition[0];
            
            if (!closest) {
                return {
                    dropIndex: 0,
                    indicatorX: 5,
                    indicatorY: Math.max(10, mouseY - 30),
                    indicatorHeight: 60,
                    targetItem: null
                };
            }
            
            // ç¡®å®šé¼ æ ‡ç›¸å¯¹äºæœ€è¿‘itemçš„ä½ç½®
            const isLeft = mouseX < closest.centerX;
            
            // å¯»æ‰¾åŒä¸€è¡Œçš„æ‰€æœ‰é¡¹ç›®
            const ROW_THRESHOLD = closest.height * 0.7;
            const sameRowItems = itemsWithPosition.filter(item => 
                Math.abs(item.centerY - closest.centerY) < ROW_THRESHOLD
            ).sort((a, b) => a.left - b.left);
            
            // æ‰¾å‡ºå½“å‰é¡¹ç›®åœ¨æ’å¥½åºçš„è¡Œä¸­çš„ç´¢å¼•
            const currentIndexInRow = sameRowItems.findIndex(item => item.item === closest.item);
            const currentIndexInItems = Array.from(items).indexOf(closest.item);
            
            // ç¡®å®šæ”¾åœ¨å·¦è¾¹è¿˜æ˜¯å³è¾¹
            if (isLeft) {
                // æ”¾åœ¨å·¦è¾¹
                return {
                    dropIndex: currentIndexInItems,
                    indicatorX: closest.left - 2,
                    indicatorY: closest.top,
                    indicatorHeight: closest.height,
                    targetItem: closest.item
                };
            } else {
                // æ”¾åœ¨å³è¾¹
                return {
                    dropIndex: currentIndexInItems + 1,
                    indicatorX: closest.right + 2,
                    indicatorY: closest.top,
                    indicatorHeight: closest.height,
                    targetItem: closest.item
                };
            }
        }

        // é¦–æ¬¡æ¸²æŸ“
        rerenderAll();

        // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('setting-btn').addEventListener('click', () => {
            // å…ˆæ˜¾ç¤ºæ¨¡æ€çª—å£
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('setting-modal').style.display = 'block';
            
            // æ›´æ–°æ ‡é¢˜è¾“å…¥æ¡†ï¼Œåæ˜ main-titleçš„å½“å‰å€¼
            const mainTitle = document.getElementById('main-title');
            const titleInput = document.getElementById('title-input');
            if (mainTitle && titleInput) {
                // ä»localStorageåŠ è½½ä¿å­˜çš„æ ‡é¢˜
                const savedTitle = localStorage.getItem('tiermaker-custom-title');
                if (savedTitle) {
                    mainTitle.textContent = savedTitle;
                    titleInput.value = savedTitle;
                } else {
                    titleInput.value = mainTitle.textContent.trim();
                }
                
                // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                titleInput.removeEventListener('input', titleInput._titleInputHandler);
                
                // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
                titleInput._titleInputHandler = function(e) {
                    const newTitle = e.target.value;
                    mainTitle.textContent = newTitle;
                    localStorage.setItem('tiermaker-custom-title', newTitle);
                    console.log('Title saved:', newTitle);
                };
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                titleInput.addEventListener('input', titleInput._titleInputHandler);
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åˆ›å»ºè€…åç§°
            const creatorNameInput = document.getElementById('creator-name-input');
            if (creatorNameInput) {
                const savedCreatorName = localStorage.getItem('tiermaker-creator-name') || '';
                creatorNameInput.value = savedCreatorName;

                // æ·»åŠ å®æ—¶ä¿å­˜åŠŸèƒ½
                creatorNameInput.addEventListener('input', function(e) {
                    const newName = e.target.value.trim();
                    localStorage.setItem('tiermaker-creator-name', newName);
                    console.log('Creator name saved:', newName);
                    
                    // ç«‹å³é‡æ–°æ¸²æŸ“é¢„è§ˆä»¥æ›´æ–°æ°´å°
                    if (document.getElementById('share-modal').style.display === 'block') {
                        generateTierListPreview();
                    }
                });
            }
            
            // tierManager.jså·²æä¾›reorderTiersæ–¹æ³•ï¼Œä¸éœ€è¦å†æ·»åŠ 
            // addTierManagerReorderMethod();
            
            // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
            ensureSelectionInfoExists();
            
            // æ¸²æŸ“è®¾ç½®
            renderTierSettings();
            
            // ç¿»è¯‘è®¾ç½®é¢æ¿
            i18n.translateSettingsModal();
            
            // ä¿®å¤æ ‡é¢˜
            fixSettingsLabels();
            
            // å¼ºåˆ¶æ˜¾ç¤ºå…ƒç´ 
            setTimeout(() => {
                forceDisplaySettingsElements();
                forceUpdateItemsCount();
            }, 100);
        });

        document.getElementById('setting-btn2').addEventListener('click', () => {
            // å…ˆæ˜¾ç¤ºæ¨¡æ€çª—å£
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('setting-modal').style.display = 'block';
            
            // æ›´æ–°æ ‡é¢˜è¾“å…¥æ¡†ï¼Œåæ˜ main-titleçš„å½“å‰å€¼
            const mainTitle = document.getElementById('main-title');
            const titleInput = document.getElementById('title-input');
            if (mainTitle && titleInput) {
                // ä»localStorageåŠ è½½ä¿å­˜çš„æ ‡é¢˜
                const savedTitle = localStorage.getItem('tiermaker-custom-title');
                if (savedTitle) {
                    mainTitle.textContent = savedTitle;
                    titleInput.value = savedTitle;
                } else {
                    titleInput.value = mainTitle.textContent.trim();
                }
                
                // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                titleInput.removeEventListener('input', titleInput._titleInputHandler);
                
                // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
                titleInput._titleInputHandler = function(e) {
                    const newTitle = e.target.value;
                    mainTitle.textContent = newTitle;
                    localStorage.setItem('tiermaker-custom-title', newTitle);
                    console.log('Title saved:', newTitle);
                };
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                titleInput.addEventListener('input', titleInput._titleInputHandler);
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åˆ›å»ºè€…åç§°
            const creatorNameInput = document.getElementById('creator-name-input');
            if (creatorNameInput) {
                const savedCreatorName = localStorage.getItem('tiermaker-creator-name') || '';
                creatorNameInput.value = savedCreatorName;
            }
            
            // tierManager.jså·²æä¾›reorderTiersæ–¹æ³•ï¼Œä¸éœ€è¦å†æ·»åŠ 
            // addTierManagerReorderMethod();
            
            // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
            ensureSelectionInfoExists();
            
            // æ¸²æŸ“è®¾ç½®
            renderTierSettings();
            
            // ç¿»è¯‘è®¾ç½®é¢æ¿
            i18n.translateSettingsModal();
            
            // ä¿®å¤æ ‡é¢˜
            fixSettingsLabels();
            
            // å¼ºåˆ¶æ˜¾ç¤ºå…ƒç´ 
            setTimeout(() => {
                forceDisplaySettingsElements();
                forceUpdateItemsCount();
            }, 100);
        });

        document.getElementById('modal-overlay').addEventListener('click', () => {
            // æ›´æ–°itemsè®¡æ•°ï¼Œç¡®ä¿åœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶æ˜¾ç¤ºæ­£ç¡®
            forceUpdateItemsCount();
            
            // å…³é—­æ¨¡æ€çª—å£
            document.getElementById('modal-overlay').style.display = 'none';
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        });

        // æ¸²æŸ“tierè®¾ç½®ï¼Œä¿®å¤åˆ é™¤æŒ‰é’®åŠŸèƒ½åŠé¢œè‰²æ›´æ–°é—®é¢˜
        function renderTierSettings() {
            const tiersTableBody = document.getElementById('tier-settings-body');
            tiersTableBody.innerHTML = '';
            
            // è®¾ç½®è¡¨æ ¼å¯æ’åº
            const sortable = new Sortable(tiersTableBody, {
                handle: '.tier-handle',
                animation: 150,
                onEnd: function(evt) {
                    // è·å–æ–°çš„æ’åºé¡ºåº
            const tiers = tierManager.getTiers();
                    const newTiers = Array.from(tiersTableBody.querySelectorAll('tr')).map(row => {
                        const tierCell = row.querySelector('td:nth-child(2)');
                        const tierName = tierCell.getAttribute('data-tier');
                        return tierName;
                    }).filter(Boolean);
                    
                    // æ›´æ–°tierManagerä¸­çš„é¡ºåº
                    tierManager.reorderTiers(newTiers);
                    
                    // ç«‹å³ä¿å­˜åˆ°localStorage
                    localStorage.setItem('tiermaker-tiers', JSON.stringify({
                        tiers: tierManager.getTiers(),
                        tierNames: tierManager.tierNames,
                        tierLimits: tierManager.tierLimits
                    }));
                    
                    // ç«‹å³é‡æ–°æ¸²æŸ“ä¸»ç•Œé¢
                    rerenderAll();
                    
                    // æ‰‹åŠ¨æ›´æ–°è®¾ç½®é¢æ¿ä¸­æ‰€æœ‰tierçš„é¢œè‰²
                    document.querySelectorAll('#tier-settings-body tr').forEach(row => {
                        const tier = row.getAttribute('data-tier');
                        if (!tier) return;
                        
                        // æ‰¾åˆ°é¢œè‰²é¢„è§ˆå…ƒç´ 
                        const colorPreview = row.querySelector('.tier-color-preview');
                        if (colorPreview) {
                            // æ›´æ–°é¢œè‰²
                            const tierColor = tierManager.getTierColor(tier);
                            colorPreview.style.backgroundColor = tierColor;
                        }
                    });
                }
            });
            
            // ä¸ºæ¯ä¸ªtieråˆ›å»ºå¯¹åº”çš„è¡Œï¼Œå¹¶æŒ‰ç…§å½“å‰é¡ºåºæ˜¾ç¤º
            tierManager.getTiers().forEach((tier, index) => {
                const row = document.createElement('tr');
                row.setAttribute('data-tier', tier);
                
                // æ’åºæ‰‹æŸ„
                const handleCell = document.createElement('td');
                handleCell.innerHTML = '<span style="display: inline-block; font-size: 20px; color: #999; cursor: move;">â‰¡</span>';
                handleCell.className = 'tier-handle';
                handleCell.style.display = 'table-cell'; // å¼ºåˆ¶æ˜¾ç¤º
                handleCell.style.cursor = 'move';
                row.appendChild(handleCell);
                
                // Tier - åªæ˜¾ç¤ºé¢œè‰²ï¼Œä¸æ˜¾ç¤ºå­—æ¯
                const tierCell = document.createElement('td');
                tierCell.setAttribute('data-tier', tier); // å­˜å‚¨tierå€¼åˆ°å±æ€§ä¸­ï¼Œç”¨äºæ’åº
                const colorPreview = document.createElement('span');
                colorPreview.className = 'tier-color-preview';
                
                // æ ¹æ®å½“å‰ä½ç½®è·å–é¢œè‰²ï¼Œè€Œä¸æ˜¯ä½¿ç”¨tieræœ¬èº«çš„é¢œè‰²
                const tierColor = tierManager.getTierColor(tier);
                colorPreview.style.backgroundColor = tierColor;
                colorPreview.style.width = '30px';
                colorPreview.style.height = '30px';
                colorPreview.style.display = 'inline-block';
                
                tierCell.appendChild(colorPreview);
                // ä¸å†æ·»åŠ å­—æ¯æ–‡æœ¬
                // tierCell.appendChild(document.createTextNode(tier));
                row.appendChild(tierCell);
                
                // æ˜¾ç¤ºåç§°
                const nameCell = document.createElement('td');
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'tier-input';
                nameInput.value = tierManager.getTierName(tier);
                nameInput.onchange = e => {
                    // æ›´æ–°tieråç§°
                    tierManager.setTierName(tier, e.target.value);
                    
                    // ç«‹å³ä¿å­˜åˆ°localStorage
                    localStorage.setItem('tiermaker-tiers', JSON.stringify({
                        tiers: tierManager.getTiers(),
                        tierNames: tierManager.tierNames,
                        tierLimits: tierManager.tierLimits
                    }));
                    
                    // ç«‹å³é‡æ–°æ¸²æŸ“ä¸»ç•Œé¢
                    rerenderAll();
                };
                nameCell.appendChild(nameInput);
                row.appendChild(nameCell);
                
                // æ•°é‡é™åˆ¶
                const limitCell = document.createElement('td');
                const limitInput = document.createElement('input');
                limitInput.type = 'number';
                limitInput.className = 'tier-limit-input';
                limitInput.min = '0';
                limitInput.value = tierManager.getTierLimit(tier) || '';
                limitInput.placeholder = 'Infinite';
                limitInput.onchange = e => {
                    const val = e.target.value === '' ? null : parseInt(e.target.value);
                    
                    // æ›´æ–°tieré™åˆ¶
                    tierManager.setTierLimit(tier, val);
                    
                    // ç«‹å³ä¿å­˜åˆ°localStorage
                    localStorage.setItem('tiermaker-tiers', JSON.stringify({
                        tiers: tierManager.getTiers(),
                        tierNames: tierManager.tierNames,
                        tierLimits: tierManager.tierLimits
                    }));
                    
                    // ç«‹å³é‡æ–°æ¸²æŸ“ä¸»ç•Œé¢
                    rerenderAll();
                };
                limitCell.appendChild(limitInput);
                row.appendChild(limitCell);
                
                // åˆ é™¤æŒ‰é’® - ç›´æ¥ä½¿ç”¨æ™®é€šæŒ‰é’®è€Œä¸æ˜¯æ ·å¼æŒ‰é’®
                const actionCell = document.createElement('td');
                actionCell.style.textAlign = 'center';
                if (tierManager.getTiers().length > 1) {
                    // åˆ›å»ºä¸€ä¸ªæ ‡å‡†æŒ‰é’®ï¼Œç¡®ä¿å¯ä»¥è¢«ç‚¹å‡»
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.innerHTML = 'Ã—';
                    deleteBtn.className = 'tier-delete-btn';
                    deleteBtn.style.color = '#ff3333';
                    deleteBtn.style.fontSize = '24px';
                    deleteBtn.style.fontWeight = 'bold';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.style.width = '30px';
                    deleteBtn.style.height = '30px';
                    deleteBtn.style.lineHeight = '20px';
                    deleteBtn.style.textAlign = 'center';
                    deleteBtn.style.padding = '0';
                    deleteBtn.style.background = 'none';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.outline = 'none';
                    
                    // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ä¸éœ€è¦ç¡®è®¤ï¼Œç›´æ¥åˆ é™¤
                    deleteBtn.addEventListener('click', function(e) {
                        // é˜»æ­¢å†’æ³¡
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('åˆ é™¤æŒ‰é’®è¢«ç‚¹å‡»: ç›´æ¥åˆ é™¤tier', tier);
                        
                        // å…ˆæ‰¾å‡ºè¯¥tierä¸­çš„æ‰€æœ‰items
                        const tierItems = classifiedItems.filter(ci => ci.tier === tier);
                        console.log(`æ‰¾åˆ°${tierItems.length}ä¸ªéœ€è¦ç§»å›æœªåˆ†ç±»åŒºåŸŸçš„items`);
                        
                        // è®°å½•è¿™äº›itemsçš„ID
                        const itemsToUnclassify = tierItems.map(item => item.id);
                        
                        // æ‰§è¡Œåˆ é™¤æ“ä½œ
                        if (tierManager.removeTier(tier)) {
                            console.log('tierå·²è¢«æˆåŠŸåˆ é™¤');
                            
                            // å°†tierä¸­çš„æ‰€æœ‰itemsç§»å›åˆ°æœªåˆ†ç±»çŠ¶æ€
                            itemsToUnclassify.forEach(itemId => {
                                // ä»classifiedItemsä¸­ç§»é™¤ - ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
                                classifiedItems = classifiedItems.filter(ci => !(String(ci.id) === String(itemId) && ci.tier === tier));
                                
                                // æ·»åŠ åˆ°æœªåˆ†ç±»åŒºåŸŸ
                                if (!unclassifiedItems.includes(itemId)) {
                                    unclassifiedItems.push(itemId);
                                    console.log(`Item ${itemId} å·²ç§»å›æœªåˆ†ç±»åŒºåŸŸ`);
                                }
                            });
                            
                            // ä¿å­˜åˆ°localStorage
                            localStorage.setItem('tiermaker-tiers', JSON.stringify({
                                tiers: tierManager.getTiers(),
                                tierNames: tierManager.tierNames,
                                tierLimits: tierManager.tierLimits
                            }));
                            
                            // ä¿å­˜itemsçŠ¶æ€åˆ°localStorage
                            saveItemsToLocalStorage();
                            
                            // é‡æ–°æ¸²æŸ“è®¾ç½®é¢æ¿
                            renderTierSettings();
                            
                            // é‡æ–°æ¸²æŸ“æ‰€æœ‰å†…å®¹
                            rerenderAll();
                        } else {
                            console.error('åˆ é™¤tierå¤±è´¥');
                            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€ä¸ªtier');
                        }
                    });
                    
                    actionCell.appendChild(deleteBtn);
                }
                row.appendChild(actionCell);
                
                tiersTableBody.appendChild(row);
            });
        }

        // æ·»åŠ æ–°tier
        document.getElementById('add-tier-btn').addEventListener('click', () => {
            // ç›´æ¥ä½¿ç”¨tierManagerçš„addTieræ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ä¸‹ä¸€ä¸ªtierå­—æ¯
            if (tierManager.addTier()) {
                console.log('æˆåŠŸæ·»åŠ æ–°tier');
                
                // ä¿å­˜åˆ°localStorage - tierManager.addTier()å·²ç»ä¿å­˜ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤
                
                // é‡æ–°æ¸²æŸ“è®¾ç½®é¢æ¿ä¸­çš„tieråˆ—è¡¨
            renderTierSettings();
                
                // é‡æ–°æ¸²æŸ“ä¸»ç•Œé¢ï¼Œä½¿å˜æ›´ç«‹å³ç”Ÿæ•ˆ
                rerenderAll();
                
                // ç§»é™¤ä¸å¿…è¦çš„æˆåŠŸæç¤ºæ¶ˆæ¯
            } else {
                console.error('æ·»åŠ tierå¤±è´¥ï¼Œå¯èƒ½å·²è¾¾åˆ°æœ€å¤§æ•°é‡é™åˆ¶');
            }
        });

        // å¤„ç†ç¡®è®¤å¯¹è¯æ¡†
        function handleConfirmDialog(message, callback) {
            if (confirm(message)) {
                callback();
            }
        }
        
        // é‡ç½®ä¸ºé»˜è®¤tiers - è‡ªå®šä¹‰é‡ç½®é€»è¾‘
        document.getElementById('reset-tiers-btn').addEventListener('click', () => {
            console.log('é‡ç½®tiersæŒ‰é’®è¢«ç‚¹å‡» - ä½¿ç”¨è‡ªå®šä¹‰é‡ç½®é€»è¾‘');
            
            // é»˜è®¤çš„6ä¸ªtiers
            const defaultTiers = ['S', 'A', 'B', 'C', 'D', 'F'];
            
            // è·å–å½“å‰æ‰€æœ‰tiers
            const currentTiers = tierManager.getTiers();
            console.log('å½“å‰tiers:', currentTiers);
            
            // æ‰¾å‡ºè¦ç§»é™¤çš„tiersï¼ˆè¶…è¿‡6ä¸ªçš„éƒ¨åˆ†ï¼‰
            const tiersToRemove = currentTiers.length > 6 ? currentTiers.slice(6) : [];
            console.log('è¦ç§»é™¤çš„tiers:', tiersToRemove);
            
            // æ”¶é›†æ‰€æœ‰è¦ç§»é™¤çš„tiersä¸­çš„items
            const itemsToUnclassify = [];
            tiersToRemove.forEach(tier => {
                const tierItems = classifiedItems.filter(ci => ci.tier === tier);
                const tierItemIds = tierItems.map(item => item.id);
                itemsToUnclassify.push(...tierItemIds);
                console.log(`Tier ${tier} ä¸­æ‰¾åˆ° ${tierItemIds.length} ä¸ªè¦ç§»å›æœªåˆ†ç±»åŒºåŸŸçš„items`);
            });
            
            // ç§»é™¤å¤šä½™çš„tiers
            tiersToRemove.forEach(tier => {
                tierManager.removeTier(tier);
                console.log(`å·²ç§»é™¤tier: ${tier}`);
            });
            
            // ä¿ç•™å‰6ä¸ªtiersï¼Œå¹¶æŒ‰é¡ºåºé‡å‘½åä¸ºé»˜è®¤åç§°
            const tiersToKeep = currentTiers.slice(0, Math.min(6, currentTiers.length));
            console.log('ä¿ç•™çš„tiers:', tiersToKeep);
            
            // å¦‚æœå½“å‰tierså°‘äº6ä¸ªï¼Œéœ€è¦æ·»åŠ ç¼ºå°‘çš„tiers
            if (tiersToKeep.length < 6) {
                for (let i = tiersToKeep.length; i < 6; i++) {
                    tierManager.addSpecificTier(defaultTiers[i]);
                    console.log(`æ·»åŠ ç¼ºå°‘çš„tier: ${defaultTiers[i]}`);
                }
            }
            
            // é‡æ–°è·å–å½“å‰tiersï¼ˆå¯èƒ½å·²æ·»åŠ äº†ç¼ºå°‘çš„tiersï¼‰
            const updatedTiers = tierManager.getTiers().slice(0, 6);
            
            // é‡æ–°æ’åºå‰6ä¸ªtiersä¸ºé»˜è®¤é¡ºåº
            tierManager.reorderTiers(defaultTiers);
            console.log('å·²é‡æ–°æ’åºtiersä¸ºé»˜è®¤é¡ºåº');
            
            // æ¢å¤é»˜è®¤tieråç§°
            defaultTiers.forEach(tier => {
                tierManager.setTierName(tier, tier);
                console.log(`å·²å°†tier ${tier} çš„åç§°æ¢å¤ä¸ºé»˜è®¤`);
            });
            
            // å°†è¢«ç§»é™¤tiersä¸­çš„itemsç§»å›åˆ°æœªåˆ†ç±»çŠ¶æ€
            itemsToUnclassify.forEach(itemId => {
                // ä»classifiedItemsä¸­ç§»é™¤ - ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
                classifiedItems = classifiedItems.filter(ci => {
                    // åªç§»é™¤åœ¨è¢«åˆ é™¤tierä¸­çš„items
                    return !(String(ci.id) === String(itemId) && tiersToRemove.includes(ci.tier));
                });
                
                // æ·»åŠ åˆ°æœªåˆ†ç±»åŒºåŸŸ
                if (!unclassifiedItems.includes(itemId)) {
                    unclassifiedItems.push(itemId);
                    console.log(`Item ${itemId} å·²ç§»å›æœªåˆ†ç±»åŒºåŸŸ`);
                }
            });
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('tiermaker-tiers', JSON.stringify({
                    tiers: tierManager.getTiers(),
                    tierNames: tierManager.tierNames,
                    tierLimits: tierManager.tierLimits
                }));
                
                // ä¿å­˜itemsçŠ¶æ€åˆ°localStorage
                saveItemsToLocalStorage();
                
                // é‡æ–°æ¸²æŸ“è®¾ç½®
                renderTierSettings();
                
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰å†…å®¹
                rerenderAll();
            
            console.log('è‡ªå®šä¹‰tieré‡ç½®å®Œæˆ');
        });
        
        // æ¸…é™¤æ‰€æœ‰é¡¹ç›®
        function clearAllItems() {
            // æ¸…ç©ºæ•°æ®
            items.length = 0;
            localItems.length = 0;
            unclassifiedItems.length = 0;
            classifiedItems.length = 0;
            skippedItems.clear();
            
            // é‡ç½®é¢„è§ˆç´¢å¼•
            previewIdx = 0;
            previewMode = 'unclassified';
            previewSelectedTier = null;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveItemsToLocalStorage();
            
            // æ›´æ–°è®¡æ•° - ç¡®ä¿å³ä½¿åœ¨è®¾ç½®å¯¹è¯æ¡†ä¸­ä¹Ÿæ›´æ–°
            updateItemsCount();
            forceUpdateItemsCount();
            
            // é‡æ–°æ¸²æŸ“
            rerenderAll();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage(i18n.t('itemsCleared'));
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.textContent = message;
            
            // è®¾ç½®æ ·å¼
            successMessage.style.position = 'fixed';
            successMessage.style.bottom = '20px';
            successMessage.style.left = '50%';
            successMessage.style.transform = 'translateX(-50%)';
            successMessage.style.backgroundColor = '#4CAF50';
            successMessage.style.color = 'white';
            successMessage.style.padding = '10px 20px';
            successMessage.style.borderRadius = '4px';
            successMessage.style.zIndex = '1000';
            
            document.body.appendChild(successMessage);
            
            // 3ç§’åæ¶ˆå¤±
            setTimeout(() => {
                successMessage.style.opacity = '0';
                successMessage.style.transition = 'opacity 0.5s ease';
                
                // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    document.body.removeChild(successMessage);
                }, 500);
            }, 3000);
        }

        // ä¿å­˜è®¾ç½®
        document.getElementById('save-settings-btn').addEventListener('click', () => {
            // æ›´æ–°æ ‡é¢˜ - ä¸ä»…æ›´æ–°localStorageï¼Œè¿˜ç›´æ¥æ›´æ–°DOM
            const titleInput = document.getElementById('title-input');
            if (titleInput && titleInput.value) {
                // æ›´æ–°main-titleå…ƒç´ 
                const mainTitle = document.getElementById('main-title');
                if (mainTitle) {
                    mainTitle.textContent = titleInput.value;
                }
                localStorage.setItem('tiermaker-custom-title', titleInput.value);
            }
            
            // åº”ç”¨å›¾ç‰‡æ¯”ä¾‹è®¾ç½®
            const ratioSelect = document.getElementById('image-ratio-select');
            if (ratioSelect) {
                applyImageRatio(ratioSelect.value);
            }
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('setting-modal').style.display = 'none';
            
            // é‡æ–°æ¸²æŸ“å¹¶åº”ç”¨å½“å‰è¯­è¨€
            rerenderAll();
            i18n.applyTranslations();
            
            // ç®€å•ç›´æ¥çš„UIä¸€è‡´æ€§æ£€æŸ¥ - ä¸ä½¿ç”¨MutationObserverå’Œå¤šä¸ªsetTimeout
            ensureUIConsistency();
            
            // å•ä¸ªå»¶è¿Ÿç¡®ä¿UIä¸€è‡´æ€§å’Œæ­£ç¡®æ˜¾ç¤º
            setTimeout(() => {
                // å¼ºåˆ¶æ›´æ–°é¡¹ç›®è®¡æ•°å’Œç¡®ä¿items-countæ˜¾ç¤ºæ­£ç¡®
                updateItemsCount();
                forceUpdateItemsCount();
                
                // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å…ƒç´ å­˜åœ¨ä¸”å¯è§
                const selectionInfo = ensureSelectionInfoExists();
                if (selectionInfo) {
                    selectionInfo.style.display = 'inline-block';
                    selectionInfo.classList.add('forced-selection-info');
                }
                
                // æ›´æ–°category-titleä¸­çš„items-count
                const categoryTitle = document.querySelector('.category-title');
                if (categoryTitle) {
                    const validUnclassifiedCount = unclassifiedItems.filter(id => !skippedItems.has(id)).length;
                    let countSpan = categoryTitle.querySelector('.items-count');
                    if (!countSpan) {
                        countSpan = document.createElement('span');
                        countSpan.className = 'items-count';
                        categoryTitle.appendChild(document.createTextNode(' '));
                        categoryTitle.appendChild(countSpan);
                    }
                    countSpan.textContent = `(${validUnclassifiedCount}/${items.length})`;
                }
                
                // æ¢å¤æ­£ç¡®çš„é¢„è§ˆæ ‡é¢˜
                const { previewId } = getPreviewInfo();
                if (previewId) {
                    const item = items.find(i => String(i.id) === String(previewId));
                    if (item) {
                        const previewTitle = document.querySelector('.item-title');
                        if (previewTitle) {
                            previewTitle.textContent = item.title || i18n.t('noTitle');
                        }
                    }
                }
                
                // é‡æ–°ç»‘å®šå¿…è¦çš„äº‹ä»¶å¤„ç†ç¨‹åº
                bindItemClickEvents();
                setupColorBoxEvents();
                setupSkipBtn();
            }, 200);
        });

        // æ·»åŠ title-inputçš„å®æ—¶åŒæ­¥åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const titleInput = document.getElementById('title-input');
            if (titleInput) {
                titleInput.addEventListener('input', function(e) {
                    const mainTitle = document.getElementById('main-title');
                    if (mainTitle) {
                        mainTitle.textContent = e.target.value;
                    }
                });
            }
        });

        // ç»‘å®šcolor-boxç‚¹å‡»äº‹ä»¶
        function setupColorBoxEvents() {
            document.querySelectorAll('.color-box').forEach((box, idx) => {
                const tier = tierManager.getTiers()[idx % tierManager.getTiers().length];
                
                // Skip disabled boxes
                if (box.getAttribute('data-disabled') === 'true') return;
                
                box.onclick = e => {
                    e.preventDefault();
                    if (isClassifying) return;
                    
                    const { previewId, previewMode, previewTier } = getPreviewInfo();
                    if (!previewId) return;
                    
                    // å¦‚æœæ˜¯å·²åˆ†ç±»é¡¹ç›®ï¼Œç›´æ¥åˆ†ç±»åˆ°æ–°tier
                    if (previewMode === 'classified') {
                        isClassifying = true;
                        disableColorBoxes();
                        const result = changeCurrentItemTier(tier);
                        if (result === false) {
                            isClassifying = false;
                            enableColorBoxes();
                        }
                            return;
                    }
                    
                    // æœªåˆ†ç±»é¡¹ç›®ï¼Œç¬¬ä¸€æ¬¡ç‚¹å‡»é«˜äº®ï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»ç¡®è®¤
                            if (previewSelectedTier === tier) {
                        // ç¬¬äºŒæ¬¡ç‚¹å‡»åŒä¸€ä¸ªtierï¼Œç¡®è®¤åˆ†ç±»
                        isClassifying = true;
                        disableColorBoxes();
                        const result = classifyCurrentItem(tier);
                        previewSelectedTier = null;
                        if (result === false) {
                            isClassifying = false;
                            enableColorBoxes();
                        }
                            } else {
                        // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œæˆ–ç‚¹å‡»äº†ä¸åŒçš„tierï¼Œé«˜äº®å½“å‰é€‰æ‹©
                                previewSelectedTier = tier;
                        // é‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç¤ºé«˜äº®
                                renderItemPreview();
                    }
                };
            });
        }

        // ç»‘å®šskip-btnç‚¹å‡»äº‹ä»¶
        function setupSkipBtn() {
            const skipBtn = document.querySelector('.skip-btn');
            if (skipBtn) {
                skipBtn.onclick = () => {
                    if (isClassifying) return;
                    
                    // è·å–å½“å‰é¢„è§ˆæ¨¡å¼ - æ¯æ¬¡ç‚¹å‡»æ—¶è·å–æœ€æ–°çŠ¶æ€ï¼Œä¸ä½¿ç”¨destructuring
                    const currentPreviewMode = getPreviewInfo().previewMode;
                    
                    console.log('Skip button clicked, previewMode:', currentPreviewMode);
                    isClassifying = true;
                    
                    if (currentPreviewMode === 'classified') {
                        unclassifyCurrentItem(); // è¿™ä¸ªå‡½æ•°å†…éƒ¨å·²ç»æ·»åŠ äº†saveItemsToLocalStorage
                        
                        // å¢åŠ ä¸€ä¸ªé¢å¤–çš„ä¿å­˜æ“ä½œï¼Œç¡®ä¿çŠ¶æ€è¢«ä¿å­˜
                        setTimeout(() => {
                            console.log('é¢å¤–ä¿å­˜æ“ä½œï¼Œä»¥ç¡®ä¿å–æ¶ˆåˆ†ç±»çŠ¶æ€è¢«æ­£ç¡®ä¿å­˜');
                            saveItemsToLocalStorage();
                            
                            // ç«‹å³é‡æ–°æ¸²æŸ“ï¼Œç¡®ä¿UIä¸æ•°æ®çŠ¶æ€ä¸€è‡´
                            rerenderAll();
                        }, 200);
                    } else {
                        gotoNextPreview(true); // trueè¡¨ç¤ºè·³è¿‡
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ²¡æœ‰æœªè·³è¿‡ä¸”æœªåˆ†ç±»çš„é¡¹ç›®ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                    const unclassifiedUnskipped = unclassifiedItems.filter(id => !skippedItems.has(id));
                    if (unclassifiedUnskipped.length === 0) {
                        console.log('æ²¡æœ‰æœªè·³è¿‡ä¸”æœªåˆ†ç±»çš„é¡¹ç›®ï¼Œæ˜¾ç¤ºå®ŒæˆçŠ¶æ€');
                        previewMode = 'completed';
                        renderItemPreview();
                    }
                    
                    // æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸ºå½“å‰è¯­è¨€
                    setTimeout(() => {
                        // é‡æ–°è·å–å½“å‰é¢„è§ˆæ¨¡å¼
                        const { previewMode: updatedPreviewMode } = getPreviewInfo();
                        skipBtn.textContent = updatedPreviewMode === 'classified' ? i18n.t('cancel') : i18n.t('skip');
                    }, 50);
                };
            }
            
            const nextBtn = document.querySelector('.next-btn');
            if (nextBtn) {
                nextBtn.onclick = () => {
                    if (isClassifying) return;
                    isClassifying = true;
                    gotoNextPreview();
                    
                    // æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸ºå½“å‰è¯­è¨€
                    nextBtn.textContent = i18n.t('next');
                };
            }
        }

        // è®¡ç®—æŒ‡å®štierä¸‹çš„æœ€å¤§orderå€¼
        function getTierMaxOrder(tier) {
            const tierItems = classifiedItems.filter(ci => ci.tier === tier);
            if (tierItems.length === 0) return 0;
            
            return Math.max(...tierItems.map(item => item.order || 0));
        }

        // åˆå§‹åŒ–é¡¹ç›®åˆ—è¡¨
        function initItems() {
            // ç¡®ä¿localItemsæ˜¯ä¸€ä¸ªç©ºæ•°ç»„
            localItems = [];
            items = [];
            unclassifiedItems = [];
            classifiedItems = [];
            
            // ä¸è¦åœ¨è¿™é‡Œæ¸…ç©ºskippedItemsï¼Œè€Œæ˜¯ç­‰å¾…ä»localStorageæˆ–IndexedDBåŠ è½½
            // skippedItems = new Set(); // åˆ é™¤è¿™è¡Œä»£ç ï¼Œé˜²æ­¢åˆå§‹åŒ–æ—¶æ¸…ç©ºè·³è¿‡çŠ¶æ€
            console.log('åˆå§‹åŒ–æ—¶ä¿ç•™ç°æœ‰è·³è¿‡çŠ¶æ€:', Array.from(skippedItems));
            
            // é¦–å…ˆå°è¯•ä»IndexedDBåŠ è½½
            console.log('å¼€å§‹ä»IndexedDBåŠ è½½æ•°æ®...');
            
            dbManager.loadItems().then(loadedItems => {
                console.log(`æˆåŠŸä»IndexedDBåŠ è½½äº† ${loadedItems.length} ä¸ªé¡¹ç›®`);
                
                // æ›´æ–°localItemså’Œitems
                localItems = loadedItems;
                items = [...loadedItems];
                
                // åŠ è½½åˆ†ç±»ä¿¡æ¯
                return dbManager.loadSettings(['classified-items', 'unclassified-items', 'skipped-items']);
            }).then(settings => {
                // æ›´æ–°åˆ†ç±»ä¿¡æ¯
                if (settings['classified-items']) {
                    classifiedItems = settings['classified-items'];
                    console.log(`åŠ è½½äº† ${classifiedItems.length} ä¸ªå·²åˆ†ç±»é¡¹ç›®`);
                }
                
                if (settings['unclassified-items']) {
                    unclassifiedItems = settings['unclassified-items'];
                    console.log(`åŠ è½½äº† ${unclassifiedItems.length} ä¸ªæœªåˆ†ç±»é¡¹ç›®`);
                }
                
                if (settings['skipped-items']) {
                    skippedItems = new Set(settings['skipped-items']);
                    console.log(`åŠ è½½äº† ${skippedItems.size} ä¸ªå·²è·³è¿‡é¡¹ç›®`);
                } else {
                    // ä»localStorageå°è¯•åŠ è½½skippedItems
                    loadSkippedItems();
                    console.log(`ä»localStorageåŠ è½½äº† ${skippedItems.size} ä¸ªå·²è·³è¿‡é¡¹ç›®`);
                }
                
                // å¦‚æœæ²¡æœ‰æœªåˆ†ç±»é¡¹ç›®ï¼Œä½†æœ‰é¡¹ç›®ï¼Œåˆå§‹åŒ–æœªåˆ†ç±»åˆ—è¡¨
                if (unclassifiedItems.length === 0 && items.length > 0) {
                    // è·å–å·²åˆ†ç±»é¡¹ç›®çš„IDé›†åˆ
                    const classifiedIds = new Set(classifiedItems.map(ci => ci.id));
                    
                    // æ·»åŠ æœªåœ¨å·²åˆ†ç±»åˆ—è¡¨ä¸­çš„é¡¹ç›®åˆ°æœªåˆ†ç±»åˆ—è¡¨
                    items.forEach(item => {
                        if (!classifiedIds.has(item.id)) {
                            unclassifiedItems.push(item.id);
                        }
                    });
                    console.log(`è‡ªåŠ¨æ·»åŠ  ${unclassifiedItems.length} ä¸ªé¡¹ç›®åˆ°æœªåˆ†ç±»åˆ—è¡¨`);
                }
                
                // ç¡®ä¿previewIdxè®¾ä¸º0ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªé¡¹ç›®
                previewIdx = 0;
                
                // é‡è¦ï¼šæ˜ç¡®è®¾ç½®previewModeä¸ºunclassifiedï¼Œå¦‚æœæœ‰æœªåˆ†ç±»é¡¹ç›®
                if (unclassifiedItems.length > 0) {
                    previewMode = 'unclassified';
                    
                    // è·å–å…¨å±€é¡ºåºï¼Œå¹¶ç¡®ä¿previewIdxæŒ‡å‘ç¬¬ä¸€ä¸ªæœªåˆ†ç±»é¡¹ç›®
                    const globalOrder = getGlobalPreviewOrder();
                    const firstUnclassified = globalOrder.find(id => unclassifiedItems.includes(id));
                    if (firstUnclassified) {
                        previewIdx = globalOrder.indexOf(firstUnclassified);
                        console.log(`åˆå§‹åŒ–: è®¾ç½®é¢„è§ˆç´¢å¼•ä¸º ${previewIdx}ï¼Œå¯¹åº”ç¬¬ä¸€ä¸ªæœªåˆ†ç±»é¡¹ç›®ID: ${firstUnclassified}`);
                    }
                } else {
                    previewMode = 'classified';
                }
                
                // æ£€æŸ¥IndexedDBå­˜å‚¨ç©ºé—´
                return dbManager.checkStorage();
            }).then(storageInfo => {
                // æ˜¾ç¤ºå­˜å‚¨ä½¿ç”¨æƒ…å†µ
                if (storageInfo.quota > 0) {
                    console.log(`IndexedDBå­˜å‚¨ç©ºé—´: ${(storageInfo.usage/1024/1024).toFixed(2)}MB / ${(storageInfo.quota/1024/1024).toFixed(2)}MB (${storageInfo.usedPercentage.toFixed(2)}%)`);
                }
                
                // é‡æ–°æ¸²æŸ“
        rerenderAll();
                updateItemsCount();
            }).catch(error => {
                console.warn('ä»IndexedDBåŠ è½½å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½:', error);
                
                // å›é€€åˆ°localStorageåŠ è½½
                try {
                    // å°è¯•ä»localStorageåŠ è½½items
                    const serializedItems = localStorage.getItem('tiermaker-items');
                    if (serializedItems) {
                        localItems = JSON.parse(serializedItems);
                        items = [...localItems];
                        console.log(`ä»localStorageåŠ è½½äº† ${items.length} ä¸ªé¡¹ç›®`);
                    } else {
                        console.log('localStorageä¸­æ²¡æœ‰ä¿å­˜çš„é¡¹ç›®');
                    }
                    
                    // åŠ è½½åˆ†ç±»çŠ¶æ€
                    const classifiedData = localStorage.getItem('tiermaker-classified-items');
                    if (classifiedData) {
                        classifiedItems = JSON.parse(classifiedData);
                        console.log(`ä»localStorageåŠ è½½äº† ${classifiedItems.length} ä¸ªå·²åˆ†ç±»é¡¹ç›®`);
                    }
                    
                    const unclassifiedData = localStorage.getItem('tiermaker-unclassified-items');
                    if (unclassifiedData) {
                        unclassifiedItems = JSON.parse(unclassifiedData);
                        console.log(`ä»localStorageåŠ è½½äº† ${unclassifiedItems.length} ä¸ªæœªåˆ†ç±»é¡¹ç›®`);
                    }
                    
                    // ä»localStorageåŠ è½½è·³è¿‡çŠ¶æ€
                    loadSkippedItems();
                    console.log(`ä»localStorageåŠ è½½äº† ${skippedItems.size} ä¸ªå·²è·³è¿‡é¡¹ç›®`);
                    
                    // å¦‚æœæ²¡æœ‰æœªåˆ†ç±»é¡¹ç›®ä½†æœ‰é¡¹ç›®ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°æœªåˆ†ç±»åˆ—è¡¨
                    if (unclassifiedItems.length === 0 && items.length > 0) {
                        // è·å–å·²åˆ†ç±»é¡¹ç›®çš„IDé›†åˆ
                        const classifiedIds = new Set(classifiedItems.map(ci => ci.id));
                        
                        // æ·»åŠ æœªåœ¨å·²åˆ†ç±»åˆ—è¡¨ä¸­çš„é¡¹ç›®åˆ°æœªåˆ†ç±»åˆ—è¡¨
                        items.forEach(item => {
                            if (!classifiedIds.has(item.id)) {
                                unclassifiedItems.push(item.id);
                            }
                        });
                        console.log(`è‡ªåŠ¨æ·»åŠ  ${unclassifiedItems.length} ä¸ªé¡¹ç›®åˆ°æœªåˆ†ç±»åˆ—è¡¨`);
                    }
                    
                    // ç¡®ä¿previewIdxè®¾ä¸º0ï¼Œé¢„è§ˆç¬¬ä¸€ä¸ªæœªåˆ†ç±»é¡¹ç›®
                    previewIdx = 0;
                    
                    // é‡è¦ï¼šæ˜ç¡®è®¾ç½®previewModeä¸ºunclassifiedï¼Œå¦‚æœæœ‰æœªåˆ†ç±»é¡¹ç›®
                    if (unclassifiedItems.length > 0) {
                        previewMode = 'unclassified';
                        
                        // è·å–å…¨å±€é¡ºåºï¼Œå¹¶ç¡®ä¿previewIdxæŒ‡å‘ç¬¬ä¸€ä¸ªæœªåˆ†ç±»é¡¹ç›®
                        const globalOrder = getGlobalPreviewOrder();
                        const firstUnclassified = globalOrder.find(id => unclassifiedItems.includes(id));
                        if (firstUnclassified) {
                            previewIdx = globalOrder.indexOf(firstUnclassified);
                            console.log(`åˆå§‹åŒ–: è®¾ç½®é¢„è§ˆç´¢å¼•ä¸º ${previewIdx}ï¼Œå¯¹åº”ç¬¬ä¸€ä¸ªæœªåˆ†ç±»é¡¹ç›®ID: ${firstUnclassified}`);
                        }
                    } else {
                        previewMode = 'classified';
                    }
                    
                    // é‡æ–°æ¸²æŸ“
                rerenderAll();
                    updateItemsCount();
                } catch (e) {
                    console.error('ä»localStorageåŠ è½½é¡¹ç›®æ—¶å‡ºé”™:', e);
                }
            });
        }

        // ä¿å­˜itemsåˆ°æœ¬åœ°å­˜å‚¨
        function saveItemsToLocalStorage() {
            try {
                // é¦–å…ˆä½¿ç”¨IndexedDBä¿å­˜æ•°æ®
                const settings = {
                    'classified-items': classifiedItems,
                    'unclassified-items': unclassifiedItems,
                    'skipped-items': Array.from(skippedItems)
                };
                
                dbManager.saveItems(localItems, settings).then(() => {
                    console.log('æˆåŠŸä½¿ç”¨IndexedDBä¿å­˜æ•°æ®');
                }).catch(error => {
                    console.error('ä½¿ç”¨IndexedDBä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°localStorage:', error);
                    
                    // å›é€€åˆ°localStorageä¿å­˜æ–¹æ³•
                    try {
                        // å°è¯•ä½¿ç”¨æ ‡å‡†æ–¹æ³•ä¿å­˜
                        const serializedItems = JSON.stringify(localItems);
                        
                        try {
                            localStorage.setItem('tiermaker-items', serializedItems);
                        } catch (e) {
                            // å¦‚æœè¶…å‡ºé…é¢ï¼Œæ˜¾ç¤ºè­¦å‘Šä½†ä¸é˜»æ­¢ç¨‹åºè¿è¡Œ
                            console.warn('ä¿å­˜itemsåˆ°localStorageå¤±è´¥ï¼Œå¯èƒ½æ˜¯è¶…å‡ºäº†å­˜å‚¨é™åˆ¶', e);
                            
                            // ä¿å­˜å½“å‰é¡¹ç›®IDå’ŒçŠ¶æ€ï¼Œå³ä½¿å›¾ç‰‡æ•°æ®ä¸¢å¤±
                            saveItemsStateOnly();
                            
                            // å¦‚æœæ˜¯å­˜å‚¨é…é¢é”™è¯¯ï¼Œå‘ç”¨æˆ·æ˜¾ç¤ºæç¤º
                            if (e.name === 'QuotaExceededError') {
                                console.error('localStorageå­˜å‚¨ç©ºé—´å·²æ»¡');
                            }
                        }
                    } catch (e) {
                        console.error('ä¿å­˜itemsæ—¶å‡ºé”™:', e);
                    }
                });
            } catch (e) {
                console.error('ä¿å­˜è¿‡ç¨‹ä¸­å‡ºé”™:', e);
            }
        }
        
        // åªä¿å­˜é¡¹ç›®çŠ¶æ€ï¼Œä¸åŒ…æ‹¬å¤§å‹å›¾ç‰‡æ•°æ®
        function saveItemsStateOnly() {
            try {
                // åˆ›å»ºä¸€ä¸ªç²¾ç®€ç‰ˆçš„itemsæ•°ç»„ï¼ŒåªåŒ…å«idå’Œtitle
                const minimalItems = localItems.map(item => {
                    return {
                        id: item.id,
                        title: item.title
                    };
                });
                
                // ä¿å­˜ç²¾ç®€ç‰ˆæ•°æ®
                localStorage.setItem('tiermaker-items-minimal', JSON.stringify(minimalItems));
                
                // ä¿å­˜åˆ†ç±»å’Œè·³è¿‡çŠ¶æ€
                localStorage.setItem('tiermaker-classified-items', JSON.stringify(classifiedItems));
                localStorage.setItem('tiermaker-unclassified-items', JSON.stringify(unclassifiedItems));
                localStorage.setItem('tiermaker-skipped-items', JSON.stringify(Array.from(skippedItems)));
                
                console.log('å·²ä¿å­˜é¡¹ç›®çŠ¶æ€ï¼ˆä¸å«å›¾ç‰‡æ•°æ®ï¼‰');
            } catch (e) {
                console.error('ä¿å­˜é¡¹ç›®çŠ¶æ€æ—¶å‡ºé”™:', e);
            }
        }

        // æ›´æ–°itemsè®¡æ•°æ˜¾ç¤º
        function updateItemsCount() {
            const itemsCountEl = document.getElementById('items-count');
            if (itemsCountEl) {
                itemsCountEl.textContent = items.length;
            }
            
            // æ›´æ–°æ˜¾ç¤ºè®¡æ•°çš„ä¿¡æ¯
            const selectionInfo = document.querySelector('.selection-info');
            if (selectionInfo) {
                // ä½¿ç”¨ä¸forceUpdateItemsCountç›¸åŒçš„æ ¼å¼æ˜¾ç¤ºé¡¹ç›®æ•°é‡
                const selectedItemsText = i18n.t('selectedItems');
                selectionInfo.innerHTML = `${selectedItemsText} (${items.length})`;
                
                // ç¡®ä¿å…ƒç´ å¯è§
                selectionInfo.style.display = 'inline-block';
                selectionInfo.style.minWidth = '150px';
                selectionInfo.style.marginLeft = '10px'; // æ·»åŠ å·¦è¾¹è·ï¼Œç¡®ä¿åœ¨æŒ‰é’®å³ä¾§æ˜¾ç¤º
                selectionInfo.style.color = 'var(--text-color)'; // ç¡®ä¿æ–‡æœ¬é¢œè‰²æ­£ç¡®
                selectionInfo.style.verticalAlign = 'middle'; // å‚ç›´å¯¹é½
            }
            
            // æ›´æ–°Itemsç±»åˆ«æ ‡é¢˜è®¡æ•°
            const categoryTitle = document.querySelector('.category-title');
            if (categoryTitle) {
                // è®¡ç®—æœ‰æ•ˆçš„æœªåˆ†ç±»items (æ’é™¤è¢«è·³è¿‡çš„)
                const validUnclassifiedCount = unclassifiedItems.filter(id => !skippedItems.has(id)).length;
                categoryTitle.innerHTML = `${i18n.t('itemsTitle')} <span class="items-count">(${validUnclassifiedCount}/${items.length})</span>`;
            }
            
            // å¦‚æœè®¾ç½®å¯¹è¯æ¡†å¯è§ï¼Œç«‹å³æ›´æ–°å…¶ä¸­çš„è®¡æ•°
            updateSettingsItemCount();
        }

        // æ·»åŠ ä¸€ä¸ªå‡½æ•°æ¥åœ¨è®¾ç½®å¯¹è¯æ¡†å¯è§æ—¶å®æ—¶æ›´æ–°è®¡æ•°
        function updateSettingsItemCount() {
            // æ£€æŸ¥è®¾ç½®å¯¹è¯æ¡†æ˜¯å¦å¯è§
            const settingModal = document.getElementById('setting-modal');
            if (settingModal && settingModal.style.display === 'block') {
                // å¦‚æœè®¾ç½®å¯¹è¯æ¡†å¯è§ï¼Œç«‹å³æ›´æ–°è®¡æ•°
                forceUpdateItemsCount();
            }
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleFileUpload(files) {
            console.log('=== handleFileUploadå¼€å§‹æ‰§è¡Œ ===');
            console.log('æ–‡ä»¶æ•°é‡ï¼š', files ? files.length : 0);
            
            if (!files || files.length === 0) {
                console.log('æ²¡æœ‰æ–‡ä»¶ï¼Œå‡½æ•°é€€å‡º');
                return;
            }
            
            // é‡è¦ï¼šç«‹å³å°†FileListå¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„ï¼Œé¿å…å¼‚æ­¥å›è°ƒæ—¶å·²å¤±æ•ˆ
            const filesArray = Array.from(files);
            
            // è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
            filesArray.forEach((file, index) => {
                console.log(`æ–‡ä»¶${index+1}ï¼š${file.name}ï¼Œç±»å‹ï¼š${file.type}ï¼Œå¤§å°ï¼š${Math.round(file.size/1024)}KB`);
            });
            
            // æ–‡ä»¶å¤§å°é™åˆ¶è®¾ç½® - è­¦å‘Šé˜ˆå€¼å’Œæœ€å¤§é˜ˆå€¼
            const WARNING_SIZE = 5 * 1024 * 1024; // 5MB æ˜¾ç¤ºè­¦å‘Š
            const MAX_SIZE = 20 * 1024 * 1024;    // 20MB æ‹’ç»ä¸Šä¼ 
            
            // æ£€æŸ¥å­˜å‚¨ç©ºé—´
            console.log('è°ƒç”¨dbManager.checkStorage()...');
            dbManager.checkStorage().then(storageInfo => {
                console.log('dbManager.checkStorage()æˆåŠŸè¿”å›ï¼š', storageInfo);
                
                if (storageInfo.usedPercentage > 90) {
                    if (!confirm('å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡å·²è¶…è¿‡90%ï¼Œç»§ç»­ä¸Šä¼ å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        return;
                    }
                }
                
                // å¤„ç†æ¯ä¸ªæ–‡ä»¶
                let uploadCount = 0;
                const totalFiles = filesArray.length;
                console.log(`å¼€å§‹å¤„ç†${totalFiles}ä¸ªæ–‡ä»¶...`);
                
                filesArray.forEach(file => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡
                    if (!file.type.startsWith('image/')) {
                        console.warn('è·³è¿‡éå›¾ç‰‡æ–‡ä»¶:', file.name);
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°
                    if (file.size > MAX_SIZE) {
                        alert(`æ–‡ä»¶ "${file.name}" å¤ªå¤§ (${Math.round(file.size/1024/1024*100)/100}MB)ã€‚è¯·ä¸Šä¼ å°äº20MBçš„æ–‡ä»¶ã€‚`);
                        return;
                    }
                    
                    // å¦‚æœæ–‡ä»¶è¾ƒå¤§ï¼Œæ˜¾ç¤ºè­¦å‘Šä½†å…è®¸ä¸Šä¼ 
                    if (file.size > WARNING_SIZE) {
                        console.warn(`æ–‡ä»¶ "${file.name}" è¾ƒå¤§ (${Math.round(file.size/1024/1024*100)/100}MB)ï¼Œå°†è‡ªåŠ¨å‹ç¼©ã€‚`);
                    }
                    
                    console.log(`å‡†å¤‡è¯»å–æ–‡ä»¶: ${file.name}`);
                    // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log(`æ–‡ä»¶è¯»å–æˆåŠŸ: ${file.name}, æ•°æ®é•¿åº¦: ${e.target.result.length}`);
                        // å‹ç¼©å›¾ç‰‡
                        console.log(`å¼€å§‹å‹ç¼©æ–‡ä»¶: ${file.name}`);
                        compressImage(e.target.result, file.name, function(compressedImageUrl) {
                            console.log(`æ–‡ä»¶å‹ç¼©å®Œæˆ: ${file.name}, å‹ç¼©åæ•°æ®é•¿åº¦: ${compressedImageUrl.length}`);
                            try {
                                // åˆ›å»ºæ–°çš„itemå¯¹è±¡
                                const newItem = {
                                    id: Date.now() + Math.floor(Math.random() * 10000), // ä½¿ç”¨æ—¶é—´æˆ³+éšæœºæ•°ç”Ÿæˆå”¯ä¸€ID
                                    title: file.name.split('.')[0], // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºæ ‡é¢˜
                                    img: compressedImageUrl // ä½¿ç”¨å‹ç¼©åçš„Data URL
                                };
                                
                                console.log(`åˆ›å»ºæ–°é¡¹ç›®: ID=${newItem.id}, æ ‡é¢˜="${newItem.title}"`);
                                
                                // æ·»åŠ åˆ°itemså’ŒlocalItems
                                items.push(newItem);
                                localItems.push(newItem);
                                
                                // æ›´æ–°æœªåˆ†ç±»items
                                unclassifiedItems.push(newItem.id);
                                
                                // æ›´æ–°å›¾ç‰‡ç¼“å­˜
                                imageCache[newItem.id] = newItem.img;
                                
                                // æ›´æ–°ä¸Šä¼ è®¡æ•°
                                uploadCount++;
                                console.log(`æˆåŠŸä¸Šä¼  ${uploadCount}/${totalFiles} ä¸ªæ–‡ä»¶`);
                                
                                // å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†å®Œæ¯•ï¼Œä¿å­˜å¹¶æ›´æ–°UI
                                if (uploadCount === totalFiles) {
                                    console.log(`æ‰€æœ‰${totalFiles}ä¸ªæ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¼€å§‹ä¿å­˜åˆ°IndexedDB...`);
                                    // ä¿å­˜åˆ°IndexedDB
                                    saveItemsToLocalStorage();
                                    
                                    // æ›´æ–°è®¡æ•°å’ŒUI
                                    console.log(`æ›´æ–°è®¡æ•°å’ŒUI...`);
                                    updateItemsCount();
                                    forceUpdateItemsCount();
                                    rerenderAll();
                                    
                                    console.log(`æ‰€æœ‰${totalFiles}ä¸ªæ–‡ä»¶ä¸Šä¼ å®Œæˆ! UIå·²æ›´æ–°ã€‚`);
                                }
                            } catch (e) {
                                console.error('æ·»åŠ å›¾ç‰‡æ—¶å‡ºé”™:', e);
                                alert('æ·»åŠ å›¾ç‰‡å¤±è´¥: ' + e.message);
                            }
                        });
                    };
                    
                    reader.onerror = function(error) {
                        console.error(`è¯»å–æ–‡ä»¶å¤±è´¥: "${file.name}"`, error);
                        alert(`æ— æ³•è¯»å–æ–‡ä»¶ "${file.name}"ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåæˆ–æ ¼å¼æ˜¯å¦æ”¯æŒã€‚`);
                    };
                    
                    // ä»¥Data URLå½¢å¼è¯»å–æ–‡ä»¶
                    console.log(`å¼€å§‹è¯»å–æ–‡ä»¶ä¸ºDataURL: ${file.name}`);
                    reader.readAsDataURL(file);
                });
            }).catch(error => {
                console.error('æ£€æŸ¥å­˜å‚¨ç©ºé—´å¤±è´¥:', error);
                // ç»§ç»­ä¸Šä¼ ï¼Œä½†æ˜¾ç¤ºè­¦å‘Š
                alert('æ— æ³•æ£€æŸ¥å­˜å‚¨ç©ºé—´ï¼Œä¸Šä¼ å¤§é‡å›¾ç‰‡å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚');
                
                // ç»§ç»­å¤„ç†ä¸Šä¼ ...
                // ç›´æ¥ä½¿ç”¨ä¿å­˜çš„æ–‡ä»¶æ•°ç»„
                console.log('ç”±äºæ— æ³•æ£€æŸ¥å­˜å‚¨ç©ºé—´ï¼Œå°†ç›´æ¥å¤„ç†æ–‡ä»¶ä¸Šä¼ ...');
                
                // å¤„ç†æ¯ä¸ªæ–‡ä»¶
                let uploadCount = 0;
                const totalFiles = filesArray.length;
                
                filesArray.forEach(file => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡
                    if (!file.type.startsWith('image/')) {
                        console.warn('è·³è¿‡éå›¾ç‰‡æ–‡ä»¶:', file.name);
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°
                    if (file.size > MAX_SIZE) {
                        alert(`æ–‡ä»¶ "${file.name}" å¤ªå¤§ (${Math.round(file.size/1024/1024*100)/100}MB)ã€‚è¯·ä¸Šä¼ å°äº20MBçš„æ–‡ä»¶ã€‚`);
                        return;
                    }
                    
                    // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // å‹ç¼©å›¾ç‰‡
                        compressImage(e.target.result, file.name, function(compressedImageUrl) {
                            try {
                                // åˆ›å»ºæ–°çš„itemå¯¹è±¡
                                const newItem = {
                                    id: Date.now() + Math.floor(Math.random() * 10000),
                                    title: file.name.split('.')[0],
                                    img: compressedImageUrl
                                };
                                
                                // æ·»åŠ åˆ°itemså’ŒlocalItems
                                items.push(newItem);
                                localItems.push(newItem);
                                unclassifiedItems.push(newItem.id);
                                imageCache[newItem.id] = newItem.img;
                                
                                uploadCount++;
                                console.log(`æˆåŠŸä¸Šä¼  ${uploadCount}/${totalFiles} ä¸ªæ–‡ä»¶`);
                                
                                if (uploadCount === totalFiles) {
                                    saveItemsToLocalStorage();
                                    updateItemsCount();
                                    forceUpdateItemsCount();
                                    rerenderAll();
                                    console.log(`æ‰€æœ‰${totalFiles}ä¸ªæ–‡ä»¶ä¸Šä¼ å®Œæˆ`);
                                }
                            } catch (e) {
                                console.error('æ·»åŠ å›¾ç‰‡æ—¶å‡ºé”™:', e);
                                alert('æ·»åŠ å›¾ç‰‡å¤±è´¥: ' + e.message);
                            }
                        });
                    };
                    
                    reader.onerror = function() {
                        console.error(`è¯»å–æ–‡ä»¶å¤±è´¥: "${file.name}"`);
                        alert(`æ— æ³•è¯»å–æ–‡ä»¶ "${file.name}"ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåæˆ–æ ¼å¼æ˜¯å¦æ”¯æŒã€‚`);
                    };
                    
                    reader.readAsDataURL(file);
                });
            });
        }
        
        // å‹ç¼©å›¾ç‰‡å‡½æ•° - è¿”å›å‹ç¼©åçš„Data URL
        function compressImage(sourceDataUrl, fileName, callback) {
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = new Image();
            img.onload = function() {
                console.log(`å‹ç¼©å›¾ç‰‡: "${fileName}", åŸå§‹å°ºå¯¸: ${img.width}x${img.height}`);
                
                // æœ€å¤§å®½åº¦å’Œé«˜åº¦ - æ ¹æ®å›¾ç‰‡å°ºå¯¸æ™ºèƒ½è°ƒæ•´
                let MAX_WIDTH, MAX_HEIGHT;
                
                // ä¼°ç®—åŸå§‹å›¾ç‰‡å¤§å°
                const originalSize = estimateImageSize(sourceDataUrl);
                console.log(`ä¼°è®¡åŸå§‹å›¾ç‰‡å¤§å°: ${(originalSize/1024/1024).toFixed(2)}MB`);
                
                // æ ¹æ®å¤§å°è°ƒæ•´å‹ç¼©ç¨‹åº¦
                if (originalSize > 5 * 1024 * 1024) { // å¤§äº5MB
                    MAX_WIDTH = 600;
                    MAX_HEIGHT = 600;
                } else if (originalSize > 2 * 1024 * 1024) { // å¤§äº2MB
                    MAX_WIDTH = 800;
                    MAX_HEIGHT = 800;
                } else { // å°äº2MB
                    MAX_WIDTH = 1200;
                    MAX_HEIGHT = 1200;
                }
                
                // è®¡ç®—æ–°å°ºå¯¸
                let width = img.width;
                let height = img.height;
                
                // ç­‰æ¯”ä¾‹ç¼©å°
                if (width > MAX_WIDTH) {
                    height = Math.round(height * (MAX_WIDTH / width));
                    width = MAX_WIDTH;
                }
                
                if (height > MAX_HEIGHT) {
                    width = Math.round(width * (MAX_HEIGHT / height));
                    height = MAX_HEIGHT;
                }
                
                console.log(`è°ƒæ•´åå°ºå¯¸: ${width}x${height}`);
                
                // åˆ›å»ºCanvaså…ƒç´ 
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                // ç»˜åˆ¶å›¾ç‰‡
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // ç¡®å®šå‹ç¼©è´¨é‡å’Œè¾“å‡ºæ ¼å¼
                let outputType = 'image/jpeg';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€æ˜åº¦æˆ–æ˜¯PNGæ ¼å¼
                const isPNG = fileName.toLowerCase().endsWith('.png');
                const hasTransparency = checkImageTransparency(ctx, width, height);
                
                if (isPNG || hasTransparency) {
                    outputType = 'image/png';
                }
                
                // é€æ­¥å‹ç¼©ç›´åˆ°æ»¡è¶³å¤§å°è¦æ±‚
                compressWithQuality(canvas, outputType, 0.9, 1024 * 1024, function(result) {
                    console.log(`å‹ç¼©å®Œæˆ: ${fileName}, æœ€ç»ˆå¤§å°: ${(estimateImageSize(result)/1024/1024).toFixed(2)}MB`);
                    callback(result);
                });
            };
            
            // å¤„ç†åŠ è½½é”™è¯¯
            img.onerror = function() {
                console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: "${fileName}"`);
                callback(sourceDataUrl); // å¤±è´¥æ—¶è¿”å›åŸå§‹æ•°æ®
            };
            
            // åŠ è½½å›¾ç‰‡
            img.src = sourceDataUrl;
        }
        
        // ä¼°ç®—å›¾ç‰‡å¤§å° (base64å­—ç¬¦ä¸²)
        function estimateImageSize(dataUrl) {
            // å»æ‰å‰ç¼€ (data:image/jpeg;base64,)
            const base64 = dataUrl.split(',')[1];
            if (!base64) return 0;
            
            // base64ç¼–ç æ¯”å®é™…æ•°æ®å¤§çº¦å¢åŠ 33%çš„å¤§å°
            return Math.ceil(base64.length * 0.75);
        }
        
        // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰é€æ˜é€šé“
        function checkImageTransparency(ctx, width, height) {
            // é‡‡æ ·æ£€æŸ¥é€æ˜åº¦ (ä¸ºäº†æ•ˆç‡ï¼Œåªæ£€æŸ¥å‡ ä¸ªç‚¹)
            const checkPoints = [
                {x: 0, y: 0},                       // å·¦ä¸Š
                {x: width-1, y: 0},                 // å³ä¸Š
                {x: 0, y: height-1},                // å·¦ä¸‹
                {x: width-1, y: height-1},          // å³ä¸‹
                {x: Math.floor(width/2), y: Math.floor(height/2)} // ä¸­å¿ƒ
            ];
            
            for (const point of checkPoints) {
                const pixelData = ctx.getImageData(point.x, point.y, 1, 1).data;
                if (pixelData[3] < 255) { // æœ‰é€æ˜åº¦
                    return true;
                }
            }
            
            return false;
        }
        
        // é€æ­¥å‹ç¼©ï¼Œç›´åˆ°æ»¡è¶³å¤§å°è¦æ±‚
        function compressWithQuality(canvas, outputType, initialQuality, maxSize, callback) {
            let quality = initialQuality;
            let result = canvas.toDataURL(outputType, quality);
            let size = estimateImageSize(result);
            let attempts = 1;
            
            console.log(`å‹ç¼©å¼€å§‹: è´¨é‡=${quality}, å¤§å°=${(size/1024/1024).toFixed(2)}MB`);
            
            // å¦‚æœå·²ç»æ»¡è¶³è¦æ±‚ï¼Œç›´æ¥è¿”å›
            if (size <= maxSize) {
                console.log(`æ— éœ€è¿›ä¸€æ­¥å‹ç¼©ï¼Œå·²æ»¡è¶³å¤§å°è¦æ±‚`);
                callback(result);
                return;
            }
            
            // é€’å½’å‹ç¼©ï¼Œç›´åˆ°å°äºæœ€å¤§å°ºå¯¸
            function compress() {
                // è®¡ç®—æ–°çš„è´¨é‡å€¼ - æ ¹æ®å½“å‰å¤§å°ä¸ç›®æ ‡å¤§å°æ¯”ä¾‹è°ƒæ•´
                quality = Math.max(0.1, quality * (maxSize / size) * 0.9);
                result = canvas.toDataURL(outputType, quality);
                size = estimateImageSize(result);
                attempts++;
                
                console.log(`å‹ç¼©ç¬¬${attempts}æ¬¡: è´¨é‡=${quality.toFixed(2)}, å¤§å°=${(size/1024/1024).toFixed(2)}MB`);
                
                if (size <= maxSize || attempts >= 5 || quality <= 0.2) {
                    // å¦‚æœæ»¡è¶³å¤§å°è¦æ±‚ã€è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°æˆ–è´¨é‡å·²ç»å¾ˆä½ï¼Œè¿”å›ç»“æœ
                    callback(result);
                } else {
                    // ç»§ç»­å‹ç¼©
                    compress();
                }
            }
            
            compress();
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateUniqueId() {
            // æ‰¾åˆ°å½“å‰æœ€å¤§ID
            const maxId = items.length > 0 ? Math.max(...items.map(item => {
                // ç¡®ä¿æ‰€æœ‰IDéƒ½è¢«è§£æä¸ºæ•°å­—
                return typeof item.id === 'number' ? item.id : parseInt(item.id, 10) || 0;
            })) : 0;
            return maxId + 1;
        }

        // åˆ é™¤item
        function deleteItem(id) {
            console.log(`å¼€å§‹åˆ é™¤é¡¹ç›®: ID=${id}`);
            
            // ç¡®ä¿IDæ¯”è¾ƒä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒä»¥é˜²æ­¢ç±»å‹ä¸åŒ¹é…
            const stringId = String(id);
            
            // ä»itemsä¸­ç§»é™¤
            const index = items.findIndex(item => String(item.id) === stringId);
            if (index !== -1) {
                console.log(`ä»itemsä¸­åˆ é™¤é¡¹ç›®: ç´¢å¼•=${index}, ID=${items[index].id}, æ ‡é¢˜="${items[index].title}"`);
                items.splice(index, 1);
                
                // ä»localItemsä¸­ç§»é™¤
                const localIndex = localItems.findIndex(item => String(item.id) === stringId);
                if (localIndex !== -1) {
                    console.log(`ä»localItemsä¸­åˆ é™¤é¡¹ç›®: ç´¢å¼•=${localIndex}`);
                    localItems.splice(localIndex, 1);
                }
                
                // ä»unclassifiedItemsä¸­ç§»é™¤ï¼Œç¡®ä¿IDæ¯”è¾ƒä¸€è‡´
                const unclassifiedIndex = unclassifiedItems.findIndex(itemId => String(itemId) === stringId);
                if (unclassifiedIndex !== -1) {
                    console.log(`ä»unclassifiedItemsä¸­åˆ é™¤é¡¹ç›®: ç´¢å¼•=${unclassifiedIndex}`);
                    unclassifiedItems.splice(unclassifiedIndex, 1);
                } else {
                    console.log(`é¡¹ç›®ä¸åœ¨unclassifiedItemsä¸­`);
                }
                
                // ä»classifiedItemsä¸­ç§»é™¤ï¼Œç¡®ä¿IDæ¯”è¾ƒä¸€è‡´
                const classifiedIndex = classifiedItems.findIndex(ci => String(ci.id) === stringId);
                if (classifiedIndex !== -1) {
                    console.log(`ä»classifiedItemsä¸­åˆ é™¤é¡¹ç›®: ç´¢å¼•=${classifiedIndex}, çº§åˆ«=${classifiedItems[classifiedIndex].tier}`);
                    classifiedItems.splice(classifiedIndex, 1);
                } else {
                    console.log(`é¡¹ç›®ä¸åœ¨classifiedItemsä¸­`);
                }
                
                // é‡ç½®è·³è¿‡çŠ¶æ€
                if (skippedItems.has(id)) {
                    console.log(`ç§»é™¤è·³è¿‡çŠ¶æ€`);
                    skippedItems.delete(id);
                }
                
                // ç«‹å³ä¿å­˜çŠ¶æ€åˆ°localStorage - ç®€åŒ–ä¿å­˜é€»è¾‘
                try {
                    localStorage.setItem('tiermaker-items', JSON.stringify(localItems));
                    localStorage.setItem('tiermaker-classified-items', JSON.stringify(classifiedItems));
                    localStorage.setItem('tiermaker-unclassified-items', JSON.stringify(unclassifiedItems));
                    localStorage.setItem('tiermaker-skipped-items', JSON.stringify(Array.from(skippedItems)));
                    console.log('é¡¹ç›®çŠ¶æ€å·²æˆåŠŸä¿å­˜åˆ°localStorage');
                } catch (e) {
                    console.error('ä¿å­˜åˆ°localStorageå¤±è´¥:', e);
                }
                
                // ä»IndexedDBä¸­åˆ é™¤é¡¹ç›® - å¼‚æ­¥è¿›è¡Œä¸é˜»å¡ç•Œé¢
                setTimeout(() => {
                    dbManager.deleteItem(id).then(() => {
                        console.log(`æˆåŠŸä»IndexedDBä¸­åˆ é™¤é¡¹ç›®: ID=${id}`);
                    }).catch(error => {
                        console.error(`ä»IndexedDBåˆ é™¤é¡¹ç›®å¤±è´¥: ID=${id}`, error);
                    });
                    
                    // ä¿å­˜è®¾ç½®åˆ°IndexedDB
                    dbManager.saveSettings({
                        'classified-items': classifiedItems,
                        'unclassified-items': unclassifiedItems,
                        'skipped-items': Array.from(skippedItems)
                    }).catch(error => {
                        console.error('ä¿å­˜è®¾ç½®åˆ°IndexedDBå¤±è´¥:', error);
                    });
                }, 0);
                
                // æ›´æ–°è®¡æ•°
                updateItemsCount();
                
                // ç§»é™¤å›¾ç‰‡ç¼“å­˜
                if (imageCache[id]) {
                    delete imageCache[id];
                }
                
                // é‡æ–°æ¸²æŸ“
                rerenderAll();
                
                console.log(`é¡¹ç›®åˆ é™¤æˆåŠŸ: ID=${id}`);
                return true;
            } else {
                console.warn(`è¦åˆ é™¤çš„é¡¹ç›®ä¸å­˜åœ¨: ID=${id}`);
                return false;
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveCurrentSettings() {
            // ä¿å­˜å›¾ç‰‡æ¯”ä¾‹è®¾ç½®
            localStorage.setItem('tiermaker-image-ratio', currentImageRatio);
            
            // ä¿å­˜æ ‡é¢˜
            const mainTitle = document.getElementById('main-title').textContent;
            localStorage.setItem('tiermaker-title', mainTitle);
            
            // ä¿å­˜åˆ›å»ºè€…åç§°
            const creatorNameInput = document.getElementById('creator-name-input');
            if (creatorNameInput) {
                localStorage.setItem('tiermaker-creator-name', creatorNameInput.value);
            }
            
            // ä¿å­˜è®¿é—®æƒé™è®¾ç½®
            const accessSelect = document.getElementById('access-select');
            if (accessSelect) {
                localStorage.setItem('tiermaker-access', accessSelect.value);
            }
            
            // ä¿å­˜tierè®¾ç½® - ä½¿ç”¨getTiers()æ–¹æ³•ä»£æ›¿getSettings()
            const tiersData = {
                tiers: tierManager.getTiers(),
                tierNames: {}, // å­˜å‚¨è‡ªå®šä¹‰åç§°
                tierLimits: {} // å­˜å‚¨æ•°é‡é™åˆ¶
            };
            
            // å­˜å‚¨æ¯ä¸ªtierçš„è‡ªå®šä¹‰åç§°å’Œé™åˆ¶
            tierManager.getTiers().forEach(tier => {
                // ä¿å­˜è‡ªå®šä¹‰åç§°
                const name = tierManager.getTierName(tier);
                if (name && name !== tier) {
                    tiersData.tierNames[tier] = name;
                }
                
                // ä¿å­˜é™åˆ¶
                const limit = tierManager.getTierLimit(tier);
                if (limit !== null) {
                    tiersData.tierLimits[tier] = limit;
                }
            });
            
            localStorage.setItem('tiermaker-tiers', JSON.stringify(tiersData));
        }

        // åº”ç”¨å›¾ç‰‡æ¯”ä¾‹è®¾ç½®
        function applyImageRatio(ratio) {
            currentImageRatio = ratio;
            
            // ä¸ºæ‰€æœ‰å¡ç‰‡æ·»åŠ overflow:hidden
            document.querySelectorAll('.item-card').forEach(card => {
                card.style.overflow = 'hidden';
                
                // æ›´æ–°tierä¸­å¡ç‰‡å°ºå¯¸
                if (card.closest('.tier-content')) {
                    const dimensions = getCardDimensionsByRatio(ratio);
                    card.style.width = dimensions.width;
                    card.style.height = dimensions.height;
                }
            });
            
            // æ›´æ–°æ‰€æœ‰å·²å­˜åœ¨çš„é¡¹ç›®å¡ç‰‡å›¾ç‰‡æ ·å¼
            document.querySelectorAll('.item-card img').forEach(img => {
                img.classList.remove('ratio-portrait', 'ratio-square', 'ratio-landscape', 'ratio-round');
                img.classList.add(`ratio-${ratio}`);
                
                // é‡ç½®æ ·å¼ä»¥é˜²æ­¢ç»§æ‰¿æ—§çš„å€¼
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                if (ratio === 'round') {
                    img.style.borderRadius = '50%';
                } else {
                    img.style.borderRadius = '';
                }
            });
            
            // æ›´æ–°é¢„è§ˆå›¾ç‰‡
            const previewImg = document.querySelector('.item-preview .item-image');
            if (previewImg) {
                previewImg.classList.remove('ratio-portrait', 'ratio-square', 'ratio-landscape', 'ratio-round');
                previewImg.classList.add(`ratio-${ratio}`);
                
                const dimensions = getPreviewDimensionsByRatio(ratio);
                previewImg.style.width = dimensions.width;
                previewImg.style.height = dimensions.height;
                previewImg.style.objectFit = 'cover';
                
                if (ratio === 'round') {
                    previewImg.style.borderRadius = '50%';
                } else {
                    previewImg.style.borderRadius = '';
                }
            }
            
            // ä¿å­˜è®¾ç½®
            saveCurrentSettings();
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¡¹ç›®ä»¥ç¡®ä¿æ­£ç¡®åº”ç”¨æ ·å¼
            rerenderAll();
        }

        // åˆå§‹åŒ–å›¾ç‰‡æ¯”ä¾‹è®¾ç½®
        function initImageRatio() {
            // ä»æœ¬åœ°å­˜å‚¨è·å–è®¾ç½®
            const savedRatio = localStorage.getItem('tiermaker-image-ratio');
            if (savedRatio) {
                currentImageRatio = savedRatio;
                // æ›´æ–°é€‰æ‹©æ¡†
                const ratioSelect = document.getElementById('image-ratio-select');
                if (ratioSelect) {
                    ratioSelect.value = savedRatio;
                }
            }
            
            // åº”ç”¨è®¾ç½®
            applyImageRatio(currentImageRatio);
        }

        // æ·»åŠ CSSæ ·å¼å®šä¹‰ä¸åŒçš„å›¾ç‰‡æ¯”ä¾‹
        function addImageRatioStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .ratio-portrait {
                    aspect-ratio: 2/3 !important;
                }
                .ratio-square {
                    aspect-ratio: 1/1 !important;
                }
                .ratio-landscape {
                    aspect-ratio: 3/2 !important;
                }
                .ratio-round {
                    aspect-ratio: 1/1 !important;
                }
                .ratio-round img {
                    border-radius: 50% !important;
                    object-fit: cover;
                }
            `;
            document.head.appendChild(style);
        }

        // è®¾ç½®å³é”®èœå•
        function setupContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            
            // é˜»æ­¢é»˜è®¤å³é”®èœå• - items-grid
            document.querySelector('.items-grid').addEventListener('contextmenu', e => {
                e.preventDefault();
                
                // è·å–ç‚¹å‡»çš„item-card
                const card = e.target.closest('.item-card');
                
                // æ˜¾ç¤ºèœå•
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.top = `${e.clientY}px`;
                
                // è®°å½•å½“å‰æ“ä½œçš„item ID
                if (card) {
                    contextMenu.setAttribute('data-item-id', card.getAttribute('data-id'));
                } else {
                    contextMenu.removeAttribute('data-item-id');
                }
                
                // æ ¹æ®æ˜¯å¦åœ¨item-cardä¸Šç‚¹å‡»æ¥æ§åˆ¶èœå•é¡¹çš„æ˜¾ç¤º
                const deleteOption = contextMenu.querySelector('[data-action="delete"]');
                const editTitleOption = contextMenu.querySelector('[data-action="edit-title"]');
                if (card) {
                    deleteOption.style.display = 'block';
                    editTitleOption.style.display = 'block';
                } else {
                    deleteOption.style.display = 'none';
                    editTitleOption.style.display = 'none';
                }
            });
            
            // é˜»æ­¢é»˜è®¤å³é”®èœå• - tiers-list
            document.querySelector('.tier-list-container').addEventListener('contextmenu', e => {
                e.preventDefault();
                
                // è·å–ç‚¹å‡»çš„item-card
                const card = e.target.closest('.item-card');
                
                // æ˜¾ç¤ºèœå•
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.top = `${e.clientY}px`;
                
                // è®°å½•å½“å‰æ“ä½œçš„item ID
                if (card) {
                    contextMenu.setAttribute('data-item-id', card.getAttribute('data-id'));
                    
                    // å¯ç”¨åˆ é™¤å’Œç¼–è¾‘æ ‡é¢˜é€‰é¡¹
                    const deleteOption = contextMenu.querySelector('[data-action="delete"]');
                    const editTitleOption = contextMenu.querySelector('[data-action="edit-title"]');
                    deleteOption.style.display = 'block';
                    editTitleOption.style.display = 'block';
                } else {
                    contextMenu.removeAttribute('data-item-id');
                    
                    // ç¦ç”¨åˆ é™¤å’Œç¼–è¾‘æ ‡é¢˜é€‰é¡¹
                    const deleteOption = contextMenu.querySelector('[data-action="delete"]');
                    const editTitleOption = contextMenu.querySelector('[data-action="edit-title"]');
                    deleteOption.style.display = 'none';
                    editTitleOption.style.display = 'none';
                }
            });
            
        }

        // åˆå§‹åŒ–Items ManagementåŠŸèƒ½
        function initItemsManagement() {
            // æ·»åŠ å›¾ç‰‡æ¯”ä¾‹æ ·å¼
            addImageRatioStyles();
            
            // åˆå§‹åŒ–å›¾ç‰‡æ¯”ä¾‹è®¾ç½®
            initImageRatio();
            
            // åˆå§‹åŒ–items
            initItems();
            
            // è®¾ç½®å³é”®èœå•
            setupContextMenu();
            
            // ç»‘å®šChoose FilesæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('choose-files-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            
            // ç»‘å®šType TextsæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('type-texts-btn').addEventListener('click', () => {
                document.getElementById('modal-overlay').style.display = 'block';
                document.getElementById('text-input-modal').style.display = 'block';
                document.getElementById('text-input-area').value = ''; // æ¸…ç©ºæ–‡æœ¬åŒºåŸŸ
            });
            
            // Buy Me a CoffeeæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('buy-coffee-btn').addEventListener('click', () => {
                window.open('https://www.buymeacoffee.com/yourname', '_blank');
            });
            
            // ContactæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('contact-btn').addEventListener('click', () => {
                window.open('https://c-hri-sw-u.github.io/', '_blank');
            });
            
            // ç»‘å®šå–æ¶ˆæ–‡æœ¬è¾“å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('cancel-text-btn').addEventListener('click', () => {
                // æ›´æ–°itemsè®¡æ•°ï¼Œç¡®ä¿åœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶æ˜¾ç¤ºæ­£ç¡®
                forceUpdateItemsCount();
                
                // å…³é—­æ¨¡æ€çª—å£
                document.getElementById('modal-overlay').style.display = 'none';
                document.getElementById('text-input-modal').style.display = 'none';
            });
            
            // ç»‘å®šç”Ÿæˆå¡ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('generate-cards-btn').addEventListener('click', () => {
                const textInput = document.getElementById('text-input-area').value;
                createItemsFromText(textInput);
                document.getElementById('modal-overlay').style.display = 'none';
                document.getElementById('text-input-modal').style.display = 'none';
            });
            
            // ç»‘å®šæ¸…é™¤æ‰€æœ‰é¡¹ç›®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('clear-items-btn').addEventListener('click', () => {
                const clearBtn = document.getElementById('clear-items-btn');
                
                // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å¤„äºç¡®è®¤çŠ¶æ€
                if (clearBtn.getAttribute('data-confirm') === 'true') {
                    // å·²ç»åœ¨ç¡®è®¤çŠ¶æ€ï¼Œæ‰§è¡Œæ¸…é™¤æ“ä½œ
                    clearAllItems();
                    
                    // æ“ä½œå®Œæˆåæ¢å¤æŒ‰é’®çŠ¶æ€
                    clearBtn.textContent = i18n.t('clear');
                    clearBtn.style.background = '#333';
                    clearBtn.removeAttribute('data-confirm');
                } else {
                    // è¿›å…¥ç¡®è®¤çŠ¶æ€
                    clearBtn.textContent = i18n.t('confirm');
                    clearBtn.style.background = '#ff0000';
                    clearBtn.setAttribute('data-confirm', 'true');
                    
                    // ç‚¹å‡»å…¶ä»–åŒºåŸŸå–æ¶ˆç¡®è®¤çŠ¶æ€
                    const cancelConfirm = (e) => {
                        if (e.target !== clearBtn) {
                            clearBtn.textContent = i18n.t('clear');
                            clearBtn.style.background = '#333';
                            clearBtn.removeAttribute('data-confirm');
                            document.removeEventListener('click', cancelConfirm);
                        }
                    };
                    
                    // å»¶è¿Ÿä¸€ä¸‹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
                    setTimeout(() => {
                        document.addEventListener('click', cancelConfirm);
                    }, 10);
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            document.getElementById('file-input').addEventListener('change', e => {
                handleFileUpload(e.target.files);
                // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
                e.target.value = '';
            });
            
            // ç»‘å®šå›¾ç‰‡æ¯”ä¾‹é€‰æ‹©å˜åŒ–äº‹ä»¶
            document.getElementById('image-ratio-select').addEventListener('change', e => {
                applyImageRatio(e.target.value);
            });
        }

        // åˆå§‹åŒ–å›¾ç‰‡ç¼“å­˜
        function initImageCache() {
            imageCache = {}; // æ¸…ç©ºç¼“å­˜
            
            // ä¸ºæ‰€æœ‰é¡¹ç›®åˆ›å»ºç¼“å­˜æ¡ç›®
            items.forEach(item => {
                if (item && item.id !== undefined && item.img) {
                    // ç¡®ä¿IDä¸€è‡´æ€§ï¼Œè½¬ä¸ºå­—ç¬¦ä¸²
                    const itemId = String(item.id);
                    imageCache[itemId] = item.img;
                }
            });
            
            console.log(`å›¾ç‰‡ç¼“å­˜å·²åˆå§‹åŒ–ï¼Œå…± ${Object.keys(imageCache).length} ä¸ªé¡¹ç›®`);
        }

        // åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­è°ƒç”¨
        function init() {
            // åˆå§‹åŒ–IndexedDB
            dbManager.initDB().then(() => {
                console.log('IndexedDBåˆå§‹åŒ–æˆåŠŸ');
                
                // æ£€æŸ¥å­˜å‚¨ç©ºé—´
                return dbManager.checkStorage();
            }).then(storageInfo => {
                if (storageInfo.quota > 0) {
                    console.log(`å­˜å‚¨ç©ºé—´çŠ¶æ€: ${(storageInfo.usage/1024/1024).toFixed(2)}MB / ${(storageInfo.quota/1024/1024).toFixed(2)}MB (${storageInfo.usedPercentage.toFixed(2)}%)`);
                    
                    // å¦‚æœå­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œæ˜¾ç¤ºè­¦å‘Š
                    if (storageInfo.usedPercentage > 90) {
                        console.warn('å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œå¯èƒ½ä¼šå½±å“æ–°å›¾ç‰‡çš„ä¿å­˜');
                    }
                }
            }).catch(error => {
                console.error('IndexedDBåˆå§‹åŒ–å¤±è´¥:', error);
            });
            
            // åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ
            i18n.init();
            
            // æ¢å¤ä¿å­˜çš„æ ‡é¢˜
            const savedTitle = localStorage.getItem('tiermaker-custom-title');
            const mainTitle = document.getElementById('main-title');
            if (savedTitle && mainTitle) {
                mainTitle.textContent = savedTitle;
                console.log('Restored saved title:', savedTitle);
            }
            
            // æ¢å¤ä¿å­˜çš„åˆ›å»ºè€…åç§°
            const savedCreatorName = localStorage.getItem('tiermaker-creator-name');
            const creatorNameInput = document.getElementById('creator-name-input');
            if (savedCreatorName && creatorNameInput) {
                creatorNameInput.value = savedCreatorName;
                console.log('Restored saved creator name:', savedCreatorName);
            }
            
            // åˆå§‹åŒ–Items ManagementåŠŸèƒ½
            initItemsManagement();
            
            // ç¡®ä¿åŠ è½½è·³è¿‡çŠ¶æ€
            loadSkippedItems();
            console.log('åˆå§‹åŒ–æ—¶åŠ è½½è·³è¿‡çŠ¶æ€:', Array.from(skippedItems));
            
            // æ¸²æŸ“ç•Œé¢
            rerenderAll();
            
            // ç¡®ä¿itemsè®¡æ•°æ­£ç¡®
            updateItemsCount();
            
            // è®¾ç½®æ ‡é¢˜ç¼–è¾‘äº‹ä»¶
            setupTitleEditEvents();
            
            // åˆå§‹åŒ–å›¾ç‰‡ç¼“å­˜
            initImageCache();
            
            // ä¿®å¤è®¾ç½®æ ‡é¢˜
            setTimeout(fixSettingsLabels, 500);
            
            // å¼ºåˆ¶æ˜¾ç¤ºè®¾ç½®å…ƒç´ 
            setTimeout(forceDisplaySettingsElements, 1000);
            // å¼ºåˆ¶æ›´æ–°itemè®¡æ•°
            setTimeout(forceUpdateItemsCount, 1000);
            
            // è®¾ç½®é‡ç½®æŒ‰é’®
            setupResetButton();
            console.log('å·²è®¾ç½®ResetæŒ‰é’®');
        }

        // è°ƒç”¨åˆå§‹åŒ–
        init();

        // æ›´æ–°tiers-listä¸­çš„å›¾åƒ
        document.querySelectorAll('.tier-content .item-card').forEach(card => {
            // é‡æ–°è®¾ç½®å¡ç‰‡å°ºå¯¸æ¯”ä¾‹
            if (currentImageRatio === 'round' || currentImageRatio === 'square') {
                card.style.width = '60px';
                card.style.height = '60px';
            } else if (currentImageRatio === 'landscape') {
                card.style.width = '75px';
                card.style.height = '50px'; 
            } else { // portrait
                card.style.width = '40px';
                card.style.height = '60px';
            }
            
            // æ›´æ–°å›¾ç‰‡æ ·å¼
            const img = card.querySelector('img');
            if (img) {
                img.classList.remove('ratio-portrait', 'ratio-square', 'ratio-landscape', 'ratio-round');
                img.classList.add(`ratio-${currentImageRatio}`);
                
                if (currentImageRatio === 'round') {
                    img.style.borderRadius = '50%';
                } else {
                    img.style.borderRadius = '';
                }
                img.style.objectFit = 'cover';
                img.style.width = '100%';
                img.style.height = '100%';
            }
        });

        // é‡ç½®å’Œåˆ·æ–°æ‰€æœ‰å›¾ç‰‡
        function resetAllImages() {
            // å…ˆç¼“å­˜æ‰€æœ‰é¡¹ç›®çš„å›¾ç‰‡URLä»¥é˜²æ­¢é”™è¯¯å¼•ç”¨
            const localImageCache = {};
            items.forEach(item => {
                if (item && item.id) {
                    localImageCache[item.id] = item.img;
                }
            });
            
            // åˆ é™¤æ‰€æœ‰ç°æœ‰å›¾ç‰‡å…ƒç´ 
            document.querySelectorAll('.item-card').forEach(card => {
                // è·å–å¡ç‰‡ID
                const itemId = Number(card.getAttribute('data-id'));
                if (!itemId || !localImageCache[itemId]) return;
                
                // æ¸…ç©ºå¡ç‰‡å†…å®¹
                card.innerHTML = '';
                
                // è®¾ç½®åŠ è½½èƒŒæ™¯
                card.style.backgroundColor = '#333';
                
                // åˆ›å»ºå›¾ç‰‡
                const img = createImageElement(localImageCache[itemId], itemId, {
                    onLoad: function() {
                        card.style.backgroundColor = '';
                    }
                });
                
                // é™„åŠ å›¾ç‰‡åˆ°å¡ç‰‡
                card.appendChild(img);
                
                // æ£€æŸ¥æ˜¯å¦åœ¨items-gridä¸­å¹¶ä¸”æ˜¯è¢«è·³è¿‡çš„é¡¹ç›®
                if (card.parentNode && card.parentNode.className === 'items-grid') {
                    // å¦‚æœæ˜¯è¢«è·³è¿‡çš„é¡¹ç›®ï¼Œæ·»åŠ skippedç±»å’Œæ ‡ç­¾
                    if (skippedItems.has(itemId)) {
                        card.classList.add('skipped');
                        card.appendChild(createSkippedBadge());
                    } else {
                        // å¦‚æœä¸æ˜¯è¢«è·³è¿‡çš„é¡¹ç›®ï¼Œç¡®ä¿ç§»é™¤skippedç±»
                        card.classList.remove('skipped');
                    }
                }
            });
        }

        // ========== é€šç”¨å›¾ç‰‡å¤„ç†å‡½æ•° ==========

        // åˆ›å»ºå›¾ç‰‡å…ƒç´ å¹¶åº”ç”¨æ ·å¼
        function createImageElement(imageUrl, itemId, options = {}) {
            const img = new Image();
            img.className = options.className || 'item-image';
            img.alt = options.alt || 'Item ' + itemId;
            img.draggable = options.draggable === true; // é»˜è®¤ä¸å¯æ‹–åŠ¨
            
            // åº”ç”¨åŸºæœ¬æ ·å¼
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.objectPosition = 'center';
            
            // æ ¹æ®å›¾ç‰‡æ¯”ä¾‹åº”ç”¨ç‰¹å®šæ ·å¼
            if (currentImageRatio === 'round') {
                img.style.borderRadius = '50%';
            } else {
                img.style.borderRadius = '';
            }
            
            // å¦‚æœæä¾›äº†å›è°ƒå‡½æ•°ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            if (typeof options.onLoad === 'function') {
                img.onload = options.onLoad;
            }
            
            if (typeof options.onError === 'function') {
                img.onerror = options.onError;
            } else {
                // é»˜è®¤é”™è¯¯å¤„ç†
                img.onerror = function() {
                    console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ID=${itemId}`);
                    img.src = 'https://dummyimage.com/60x60/ff0000/ffffff&text=Error';
                };
            }
            
            // è®¾ç½®å›¾ç‰‡æº
            img.src = imageUrl;
            
            return img;
        }

        // æ¸…é™¤å®¹å™¨ä¸­çš„æ‰€æœ‰å›¾ç‰‡
        function clearImages(container) {
            if (typeof container === 'string') {
                container = document.querySelector(container);
            }
            
            if (container) {
                const images = container.querySelectorAll('.item-image');
                images.forEach(img => img.remove());
            }
        }

        // æ ¹æ®æ¯”ä¾‹è·å–å¡ç‰‡å°ºå¯¸
        function getCardDimensionsByRatio(ratio) {
            if (ratio === 'round' || ratio === 'square') {
                return { width: '60px', height: '60px' };
            } else if (ratio === 'landscape') {
                return { width: '75px', height: '50px' };
            } else { // portrait
                return { width: '40px', height: '60px' };
            }
        }

        // æ ¹æ®æ¯”ä¾‹è·å–é¢„è§ˆå›¾ç‰‡å°ºå¯¸
        function getPreviewDimensionsByRatio(ratio) {
            if (ratio === 'round' || ratio === 'square') {
                return { width: '220px', height: '220px' };
            } else if (ratio === 'landscape') {
                return { width: '220px', height: '147px' };
            } else { // portrait
                return { width: '150px', height: '220px' };
            }
        }

        // åˆ›å»ºè·³è¿‡æ ‡ç­¾
        function createSkippedBadge() {
            const badge = document.createElement('div');
            badge.className = 'skipped-badge';
            badge.textContent = 'Skipped';
            badge.style.position = 'absolute';
            badge.style.top = '0';
            badge.style.left = '0';
            badge.style.right = '0';
            badge.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
            badge.style.color = 'white';
            badge.style.textAlign = 'center';
            badge.style.padding = '2px';
            badge.style.fontSize = '12px';
            badge.style.fontWeight = 'bold';
            badge.style.zIndex = '10';
            return badge;
        }

        // ========== é€šç”¨æ‹–æ”¾å¤„ç†å‡½æ•° ==========

        // å¤„ç†æ‰€æœ‰ç±»å‹çš„æ‹–æ”¾æ“ä½œ
        function handleDragDrop(data) {
            const { id, sourceType, targetType, sourceTier, targetTier, dropIndex } = data;
            
            // å…ˆæŸ¥æ‰¾å®Œæ•´çš„itemæ•°æ®
            const originalItem = items.find(item => String(item.id) === String(id));
            if (!originalItem) {
                console.error(`æ‹–æ”¾é”™è¯¯: æ‰¾ä¸åˆ°IDä¸º${id}çš„é¡¹ç›®`);
                return;
            }
            
            // æ ¹æ®ä¸åŒçš„æ‹–æ”¾ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ
            if (sourceType === 'grid' && targetType === 'tier') {
                // ä»gridåˆ°tierçš„æ‹–æ”¾
                
                // æ£€æŸ¥tieré™åˆ¶
                const tierItems = classifiedItems.filter(ci => ci.tier === targetTier);
                const tierLimit = tierManager.getTierLimit(targetTier);
                if (tierLimit !== null && tierItems.length >= tierLimit) {
                    // è¾¾åˆ°é™åˆ¶ï¼Œé«˜äº®æ˜¾ç¤ºé™åˆ¶
                    highlightTierLimitReached(targetTier);
                    return;
                }
                
                // è®¡ç®—orderå€¼
                const order = getOrderForPosition(targetTier, dropIndex);
                
                // æ·»åŠ åˆ°classifiedItems
                classifiedItems.push({ id: originalItem.id, tier: targetTier, order });
                
                // ä»unclassifiedItemsä¸­ç§»é™¤
                unclassifiedItems = unclassifiedItems.filter(i => String(i) !== String(id));
                
                // é‡ç½®è·³è¿‡çŠ¶æ€
                skippedItems.delete(id);
                saveSkippedItems(); // ä¿å­˜è·³è¿‡çŠ¶æ€æ›´æ–°
                
                // é‡æ–°ç´¢å¼•è¯¥tierä¸­çš„items
                reindexTierItems(targetTier);
                
            } else if (sourceType === 'tier' && targetType === 'tier' && sourceTier === targetTier) {
                // åŒä¸€tierå†…çš„æ’åº
                
                // è·å–è¯¥tierä¸­çš„æ‰€æœ‰items
                const tierItems = classifiedItems
                    .filter(ci => ci.tier === targetTier)
                    .sort((a, b) => a.order - b.order);
                
                // æ‰¾åˆ°è¢«æ‹–æ‹½çš„item
                const draggedItem = tierItems.find(ti => String(ti.id) === String(id));
                if (!draggedItem) return;
                
                // å½“å‰ä½ç½®
                const oldIndex = tierItems.indexOf(draggedItem);
                
                // å¦‚æœä½ç½®æ²¡å˜ï¼Œä¸åšä»»ä½•æ“ä½œ
                if (oldIndex === dropIndex) return;
                
                // ç§»åŠ¨item
                tierItems.splice(oldIndex, 1);
                tierItems.splice(dropIndex, 0, draggedItem);
                
                // é‡æ–°è®¾ç½®order
                tierItems.forEach((item, index) => {
                    item.order = index + 1;
                });
                
            } else if (sourceType === 'tier' && targetType === 'tier' && sourceTier !== targetTier) {
                // ä»ä¸€ä¸ªtieråˆ°å¦ä¸€ä¸ªtierçš„æ‹–æ”¾
                
                // æ£€æŸ¥ç›®æ ‡tieré™åˆ¶
                const targetTierItems = classifiedItems.filter(ci => ci.tier === targetTier);
                const targetTierLimit = tierManager.getTierLimit(targetTier);
                if (targetTierLimit !== null && targetTierItems.length >= targetTierLimit) {
                    // è¾¾åˆ°é™åˆ¶ï¼Œé«˜äº®æ˜¾ç¤ºé™åˆ¶
                    highlightTierLimitReached(targetTier);
                    return;
                }
                
                // æ‰¾åˆ°è¢«æ‹–æ‹½çš„item
                const item = classifiedItems.find(ci => String(ci.id) === String(id));
                if (!item) return;
                
                // æ›´æ–°tier
                item.tier = targetTier;
                
                // è®¡ç®—æ–°çš„order
                item.order = getOrderForPosition(targetTier, dropIndex);
                
                // é‡æ–°ç´¢å¼•ä¸¤ä¸ªtierçš„items
                reindexTierItems(sourceTier);
                reindexTierItems(targetTier);
            }
            
            // ä¿å­˜åˆ°localStorageç¡®ä¿æŒä¹…åŒ–
            saveItemsToLocalStorage();
            
            // æ¸…é™¤é¢„è§ˆå›¾ç‰‡
            clearImages('.item-preview');
            
            // é‡æ–°æ¸²æŸ“
            rerenderAll();
        }


        // è®¾ç½®æ ‡é¢˜ç¼–è¾‘äº‹ä»¶
        function setupTitleEditEvents() {
            // å…è®¸ç¼–è¾‘ä¸»æ ‡é¢˜
            const mainTitle = document.getElementById('main-title');
            if (mainTitle) {
                // å¦‚æœå·²ç»æ˜¯å¯ç¼–è¾‘çš„ï¼Œä¸è¦å†è®¾ç½®
                if (!mainTitle.hasAttribute('contenteditable')) {
                    mainTitle.setAttribute('contenteditable', 'true');
                    mainTitle.style.cursor = 'pointer';
                    
                    // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨ï¼Œä¿å­˜æ›´æ”¹åˆ°localStorage
                    mainTitle.addEventListener('input', () => {
                        localStorage.setItem('tiermaker-custom-title', mainTitle.textContent);
                    });
                    
                    // æ·»åŠ å¤±å»ç„¦ç‚¹äº‹ä»¶ç›‘å¬å™¨
                    mainTitle.addEventListener('blur', () => {
                        if (mainTitle.textContent.trim() === '') {
                            mainTitle.textContent = i18n.t('mainTitle');
                        }
                    });
                }
            }
            
            // å…è®¸åŒå‡»ç¼–è¾‘é¢„è§ˆä¸­çš„itemæ ‡é¢˜
            setupItemTitleEditEvent();
        }

        // è®¾ç½®itemæ ‡é¢˜åŒå‡»ç¼–è¾‘äº‹ä»¶
        function setupItemTitleEditEvent() {
            const itemTitle = document.querySelector('.item-title');
            if (!itemTitle) return;
            
            // æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬å™¨
            itemTitle.addEventListener('dblclick', function() {
                // è·å–å½“å‰é¢„è§ˆçš„item
                const { previewId } = getPreviewInfo();
                if (!previewId) return;
                
                // æ‰¾åˆ°å¯¹åº”çš„itemå¯¹è±¡
                const item = items.find(i => i.id === previewId);
                if (!item) return;
                
                // è®¾ç½®ä¸ºå¯ç¼–è¾‘çŠ¶æ€
                this.setAttribute('contenteditable', 'true');
                this.style.cursor = 'text';
                this.style.border = '1px dashed #fff';
                this.style.padding = '4px';
                this.focus();
                
                // é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
                window.getSelection().selectAllChildren(this);
                
                // é˜»æ­¢æ‹–æ”¾æœŸé—´çš„ç¼–è¾‘
                if (isClassifying) {
                    this.setAttribute('contenteditable', 'false');
                    return;
                }
                
                // ä¿å­˜åŸå§‹æ ‡é¢˜ï¼Œç”¨äºå–æ¶ˆç¼–è¾‘æ—¶æ¢å¤
                this.setAttribute('data-original-title', this.textContent);
                
                // å¤„ç†ç¼–è¾‘å®Œæˆ
                const completeEdit = () => {
                    // ç§»é™¤ç¼–è¾‘çŠ¶æ€
                    this.removeAttribute('contenteditable');
                    this.style.cursor = '';
                    this.style.border = '';
                    this.style.padding = '';
                    
                    // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œæ¢å¤åŸå§‹æ ‡é¢˜
                    if (this.textContent.trim() === '') {
                        this.textContent = this.getAttribute('data-original-title') || item.title;
                        return;
                    }
                    
                    // å¦‚æœæ ‡é¢˜æœªå˜åŒ–ï¼Œæ— éœ€æ›´æ–°
                    if (this.textContent === item.title) return;
                    
                    // æ›´æ–°itemæ ‡é¢˜
                    const newTitle = this.textContent.trim();
                    item.title = newTitle;
                    
                    // æ›´æ–°æœ¬åœ°items
                    const localItem = localItems.find(i => i.id === previewId);
                    if (localItem) {
                        localItem.title = newTitle;
                    }
                    
                    // å¦‚æœæ˜¯æ–‡å­—å¡ç‰‡ï¼Œæ›´æ–°å›¾ç‰‡
                    if (item.isTextGenerated) {
                        updateTextCardImage(item);
                    }
                    
                    // ä¿å­˜åˆ°localStorage
                    saveItemsToLocalStorage();
                    
                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰UIä»¥åæ˜ æ›´æ”¹
                    rerenderAll();
                    
                    console.log(`Itemæ ‡é¢˜å·²æ›´æ–°: ID=${previewId}, æ–°æ ‡é¢˜="${newTitle}"`);
                };
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                const onBlur = () => {
                    completeEdit();
                    this.removeEventListener('blur', onBlur);
                };
                
                const onKeyDown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        completeEdit();
                        this.removeEventListener('keydown', onKeyDown);
                        this.blur();
                    } else if (e.key === 'Escape') {
                        // å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸå§‹æ ‡é¢˜
                        this.textContent = this.getAttribute('data-original-title') || item.title;
                        this.removeAttribute('contenteditable');
                        this.style.cursor = '';
                        this.style.border = '';
                        this.style.padding = '';
                        this.removeEventListener('keydown', onKeyDown);
                        this.blur();
                    }
                };
                
                this.addEventListener('blur', onBlur);
                this.addEventListener('keydown', onKeyDown);
            });
        }

        // ä¸ºæ–‡å­—å¡ç‰‡æ›´æ–°å›¾ç‰‡
        // ä¿®å¤æ ‡é¢˜æ˜¾ç¤ºé—®é¢˜
        function fixSettingsLabels() {
            // ç¡®ä¿æ‰€æœ‰è®¾ç½®çš„æ ‡é¢˜æ­£ç¡®æ˜¾ç¤º
            const settingModal = document.getElementById('setting-modal');
            if (settingModal) {
                const headings = settingModal.querySelectorAll('h3');
                if (headings.length >= 3) {
                    headings[0].textContent = i18n.t('basicSettings');
                    headings[1].textContent = i18n.t('tierManagement');
                    headings[2].textContent = i18n.t('itemsManagement');
                }
                
                // ç¡®ä¿æ‰€æœ‰æ ‡ç­¾ä¹Ÿæ­£ç¡®æ˜¾ç¤º
                const labels = settingModal.querySelectorAll('label');
                labels.forEach(label => {
                    const labelParent = label.parentElement;
                    const nextElement = labelParent.querySelector('select, input');
                    
                    if (nextElement && nextElement.id === 'access-select') {
                        label.textContent = i18n.t('access');
                    } else if (nextElement && nextElement.id === 'title-input') {
                        label.textContent = i18n.t('title');
                    } else if (nextElement && nextElement.id === 'image-ratio-select') {
                        label.textContent = i18n.t('imageRatio');
                    } else if (labelParent.querySelector('.file-selection')) {
                        label.textContent = i18n.t('items');
                    }
                });
                
                // ä¿®å¤itemé€‰æ‹©è®¡æ•°
                updateItemsCount();
                
                // ä¿®å¤tierç®¡ç†è¡¨æ ¼ä¸­çš„å›¾æ ‡æ˜¾ç¤º
                setTimeout(() => {
                    document.querySelectorAll('.tier-handle, .tier-delete-btn').forEach(el => {
                        el.style.display = el.tagName === 'TD' ? 'table-cell' : 'inline-block';
                    });
                }, 100);
            }
        }

        // å¼ºåˆ¶æ˜¾ç¤ºè®¾ç½®é¢æ¿ä¸­çš„å…ƒç´ 
        let settingsElementsForced = false; // æ·»åŠ æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤å¼ºåˆ¶æ˜¾ç¤º
        
        function forceDisplaySettingsElements() {
            // é¿å…çŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨
            if (settingsElementsForced) {
                return;
            }
            
            console.log('å¼ºåˆ¶æ˜¾ç¤ºè®¾ç½®é¢æ¿å…ƒç´ ');
            
            // å¼ºåˆ¶æ˜¾ç¤ºtier-handleå’Œtier-delete-btn
            document.querySelectorAll('.tier-handle').forEach(el => {
                el.classList.add('forced-tier-handle');
                const span = el.querySelector('span');
                if (span) {
                    span.classList.add('forced-tier-handle-span');
                } else {
                    el.innerHTML = '<span class="forced-tier-handle-span">â‰¡</span>';
                }
            });
            
            document.querySelectorAll('.tier-delete-btn').forEach(el => {
                el.classList.add('forced-tier-delete-btn');
                const span = el.querySelector('span');
                if (span) {
                    span.classList.add('forced-tier-delete-span');
                } else {
                    el.innerHTML = '<span class="forced-tier-delete-span">Ã—</span>';
                }
            });
            
            // å¼ºåˆ¶æ˜¾ç¤ºé€‰æ‹©ä¿¡æ¯
            const selectionInfo = document.querySelector('.selection-info');
            if (selectionInfo) {
                selectionInfo.classList.add('forced-selection-info');
            }
            
            // è®¾ç½®æ ‡å¿—ï¼Œé¿å…çŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨
            settingsElementsForced = true;
            setTimeout(() => {
                settingsElementsForced = false; // 1ç§’åé‡ç½®æ ‡å¿—
            }, 1000);
            
            // é‡æ–°æ¸²æŸ“tierè®¾ç½®
            renderTierSettings();
            
            console.log('å·²å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰è®¾ç½®å…ƒç´ ');
        }

        // å¼ºåˆ¶æ‰§è¡Œæ˜¾ç¤ºè®¡æ•°çš„æ›´æ–°ï¼Œå¹¶ç¡®ä¿é€‰æ‹©ä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®
        let itemsCountUpdateForced = false; // æ·»åŠ æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤æ›´æ–°
        
        function forceUpdateItemsCount() {
            // é¿å…çŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨
            if (itemsCountUpdateForced) {
                return;
            }
            
            // å¼ºåˆ¶åˆ›å»ºå’Œæ˜¾ç¤ºé€‰æ‹©ä¿¡æ¯å…ƒç´ 
            const selectionInfo = ensureSelectionInfoExists();
            
            const itemsCountEl = document.getElementById('items-count');
            if (itemsCountEl) {
                // ç¡®ä¿items-countå…ƒç´ æœ‰æ­£ç¡®çš„æ–‡æœ¬å†…å®¹
                itemsCountEl.textContent = items.length.toString();
            }
            
            // æ›´æ–°æ˜¾ç¤ºè®¡æ•°çš„ä¿¡æ¯
            if (selectionInfo) {
                // ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²æ˜¾ç¤ºé¡¹ç›®æ•°é‡ï¼Œè€Œä¸æ˜¯ä¾èµ–i18nçš„å‚æ•°æ›¿æ¢
                const selectedItemsText = i18n.t('selectedItems');
                selectionInfo.innerHTML = `${selectedItemsText} (${items.length})`;
                
                // ç¡®ä¿å…ƒç´ å¯è§
                selectionInfo.style.display = 'inline-block';
                selectionInfo.style.minWidth = '150px';
                selectionInfo.style.marginLeft = '10px';
                selectionInfo.style.color = 'var(--text-color)';
                selectionInfo.style.verticalAlign = 'middle';
                
                // æ·»åŠ å¼ºåˆ¶æ˜¾ç¤ºçš„ç±»
                selectionInfo.classList.add('forced-selection-info');
            }
            
            // è®¾ç½®æ ‡å¿—ï¼Œé¿å…çŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨
            itemsCountUpdateForced = true;
            setTimeout(() => {
                itemsCountUpdateForced = false; // 500msåé‡ç½®æ ‡å¿—
            }, 500);
        }

        // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
        let domInitialized = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            if (domInitialized) return;
            domInitialized = true;
            
            // åˆå§‹åŒ–i18n
            i18n.init();
            
            // è®¾ç½®è¯­è¨€åˆ‡æ¢äº‹ä»¶
            const langOptions = document.querySelectorAll('.language-option');
            langOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const lang = option.getAttribute('data-lang');
                    if (lang) {
                        i18n.setLanguage(lang);
                        // éšè—ä¸‹æ‹‰èœå•
                        document.getElementById('language-dropdown').style.display = 'none';
                        // é‡æ–°æ¸²æŸ“æ‰€æœ‰éœ€è¦ç¿»è¯‘çš„å†…å®¹
                        rerenderAll();
                    }
                });
            });
            
            // è®¾ç½®è¯­è¨€æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤º/éšè—ä¸‹æ‹‰èœå•
            const langBtn = document.getElementById('language-btn');
            const langDropdown = document.getElementById('language-dropdown');
            if (langBtn && langDropdown) {
                console.log('æ‰¾åˆ°è¯­è¨€æŒ‰é’®å’Œä¸‹æ‹‰èœå•');
                
                // ç¡®ä¿ä¸‹æ‹‰èœå•åˆå§‹éšè—
                langDropdown.style.display = 'none';
                
                // ç§»é™¤æ—§äº‹ä»¶å¤„ç†
                langBtn.onclick = null;
                
                // æ·»åŠ æ–°äº‹ä»¶å¤„ç†
                langBtn.addEventListener('click', function(event) {
                    console.log('è¯­è¨€æŒ‰é’®è¢«ç‚¹å‡»');
                    event.stopPropagation();
                    event.preventDefault();
                    
                    if (langDropdown.style.display === 'block') {
                        langDropdown.style.display = 'none';
                        console.log('å…³é—­è¯­è¨€ä¸‹æ‹‰èœå•');
                    } else {
                        langDropdown.style.display = 'block';
                        console.log('æ‰“å¼€è¯­è¨€ä¸‹æ‹‰èœå•');
                    }
                }, true);
                
                // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', (e) => {
                    if (e.target !== langBtn && !langDropdown.contains(e.target)) {
                        langDropdown.style.display = 'none';
                    }
                });
            }
            
            setTimeout(function() {
                forceDisplaySettingsElements();
                forceUpdateItemsCount();
                console.log('å·²å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰è®¾ç½®å…ƒç´ ');
            }, 500);
        });

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåé‡æ–°æ¸²æŸ“ä¸€æ¬¡æ‰€æœ‰å…ƒç´ 
        let pageLoadInitialized = false;
        
        window.addEventListener('load', function() {
            if (pageLoadInitialized) return;
            pageLoadInitialized = true;
            
            setTimeout(function() {
                forceDisplaySettingsElements();
                forceUpdateItemsCount();
                console.log('é¡µé¢åŠ è½½åå·²å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰è®¾ç½®å…ƒç´ ');
            }, 1000);
        });

        // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å…ƒç´ å­˜åœ¨
        let selectionInfoCreated = false; // æ·»åŠ æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤åˆ›å»º
        
        function ensureSelectionInfoExists() {
            // å¦‚æœå·²ç»åˆ›å»ºè¿‡ï¼Œç›´æ¥è¿”å›
            if (selectionInfoCreated) {
                return document.querySelector('.selection-info');
            }
            
            // æ£€æŸ¥.selection-infoæ˜¯å¦å­˜åœ¨
            let selectionInfo = document.querySelector('.selection-info');
            if (!selectionInfo) {
                // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                const fileSelection = document.querySelector('.file-selection');
                if (fileSelection) {
                    selectionInfo = document.createElement('span');
                    selectionInfo.className = 'selection-info forced-selection-info';
                    
                    // ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²æ˜¾ç¤ºé¡¹ç›®æ•°é‡ï¼Œä¸forceUpdateItemsCountä¿æŒä¸€è‡´
                    const selectedItemsText = i18n.t('selectedItems');
                    selectionInfo.innerHTML = `${selectedItemsText} (${items.length})`;
                    
                    // ç¡®ä¿å…ƒç´ å¯è§
                    selectionInfo.style.display = 'inline-block';
                    selectionInfo.style.minWidth = '150px';
                    selectionInfo.style.marginLeft = '10px';
                    selectionInfo.style.color = 'var(--text-color)';
                    selectionInfo.style.verticalAlign = 'middle';
                    
                    fileSelection.appendChild(selectionInfo);
                    console.log('åˆ›å»ºäº†.selection-infoå…ƒç´ ');
                    selectionInfoCreated = true; // æ ‡è®°ä¸ºå·²åˆ›å»º
                }
            } else {
                selectionInfoCreated = true; // æ ‡è®°ä¸ºå·²åˆ›å»º
            }
            return selectionInfo;
        }

        // åœ¨æ‰“å¼€è®¾ç½®å¯¹è¯æ¡†æ—¶ä¸“é—¨å¤„ç†é€‰æ‹©ä¿¡æ¯å…ƒç´ 
        document.getElementById('setting-btn').addEventListener('click', () => {
            // å…ˆæ˜¾ç¤ºæ¨¡æ€çª—å£
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('setting-modal').style.display = 'block';
            
            // æ›´æ–°æ ‡é¢˜è¾“å…¥æ¡†ï¼Œåæ˜ main-titleçš„å½“å‰å€¼
            const mainTitle = document.getElementById('main-title');
            const titleInput = document.getElementById('title-input');
            if (mainTitle && titleInput) {
                // ä»localStorageåŠ è½½ä¿å­˜çš„æ ‡é¢˜
                const savedTitle = localStorage.getItem('tiermaker-custom-title');
                if (savedTitle) {
                    mainTitle.textContent = savedTitle;
                    titleInput.value = savedTitle;
                } else {
                    titleInput.value = mainTitle.textContent.trim();
                }
                
                // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                titleInput.removeEventListener('input', titleInput._titleInputHandler);
                
                // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
                titleInput._titleInputHandler = function(e) {
                    const newTitle = e.target.value;
                    mainTitle.textContent = newTitle;
                    localStorage.setItem('tiermaker-custom-title', newTitle);
                    console.log('Title saved:', newTitle);
                };
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                titleInput.addEventListener('input', titleInput._titleInputHandler);
            }
            
            // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
            ensureSelectionInfoExists();
            
            // æ¸²æŸ“è®¾ç½®
            renderTierSettings();
            
            // ç¿»è¯‘è®¾ç½®é¢æ¿
            i18n.translateSettingsModal();
            
            // ä¿®å¤æ ‡é¢˜
            fixSettingsLabels();
            
            // å¼ºåˆ¶æ˜¾ç¤ºå…ƒç´ 
            setTimeout(() => {
                forceDisplaySettingsElements();
                forceUpdateItemsCount();
            }, 100);
        });

        // ç¬¬äºŒä¸ªè®¾ç½®æŒ‰é’®ä¹Ÿä½¿ç”¨ç›¸åŒå¤„ç†
        document.getElementById('setting-btn2').addEventListener('click', () => {
            // å…ˆæ˜¾ç¤ºæ¨¡æ€çª—å£
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('setting-modal').style.display = 'block';
            
            // æ›´æ–°æ ‡é¢˜è¾“å…¥æ¡†ï¼Œåæ˜ main-titleçš„å½“å‰å€¼
            const mainTitle = document.getElementById('main-title');
            const titleInput = document.getElementById('title-input');
            if (mainTitle && titleInput) {
                // ä»localStorageåŠ è½½ä¿å­˜çš„æ ‡é¢˜
                const savedTitle = localStorage.getItem('tiermaker-custom-title');
                if (savedTitle) {
                    mainTitle.textContent = savedTitle;
                    titleInput.value = savedTitle;
                } else {
                    titleInput.value = mainTitle.textContent.trim();
                }
                
                // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                titleInput.removeEventListener('input', titleInput._titleInputHandler);
                
                // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
                titleInput._titleInputHandler = function(e) {
                    const newTitle = e.target.value;
                    mainTitle.textContent = newTitle;
                    localStorage.setItem('tiermaker-custom-title', newTitle);
                    console.log('Title saved:', newTitle);
                };
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                titleInput.addEventListener('input', titleInput._titleInputHandler);
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åˆ›å»ºè€…åç§°
            const creatorNameInput = document.getElementById('creator-name-input');
            if (creatorNameInput) {
                const savedCreatorName = localStorage.getItem('tiermaker-creator-name') || '';
                creatorNameInput.value = savedCreatorName;
            }
            
            // tierManager.jså·²æä¾›reorderTiersæ–¹æ³•ï¼Œä¸éœ€è¦å†æ·»åŠ 
            // addTierManagerReorderMethod();
            
            // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
            ensureSelectionInfoExists();
            
            // æ¸²æŸ“è®¾ç½®
            renderTierSettings();
            
            // ç¿»è¯‘è®¾ç½®é¢æ¿
            i18n.translateSettingsModal();
            
            // ä¿®å¤æ ‡é¢˜
            fixSettingsLabels();
            
            // å¼ºåˆ¶æ˜¾ç¤ºå…ƒç´ 
            setTimeout(() => {
                forceDisplaySettingsElements();
                forceUpdateItemsCount();
            }, 100);
        });

        // åœ¨initå‡½æ•°ä¸­ä¹Ÿç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
        let initDone = false;
        const originalInit = init;
        init = function() {
            // é¿å…é‡å¤åˆå§‹åŒ–
            if (initDone) {
                return;
            }
            
            // è°ƒç”¨åŸå§‹init
            originalInit();
            
            // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
            setTimeout(() => {
                ensureSelectionInfoExists();
                forceUpdateItemsCount();
                setupResetButton(); // è®¾ç½®é‡ç½®æŒ‰é’®
                setupDownloadButton(); // è®¾ç½®ä¸‹è½½æŒ‰é’®
                // Call after a slight delay to ensure DOM is ready and dimensions are available
                dynamicItemPreviewPositioning(); // Changed from 200ms timeout to direct call after other setups
                initDone = true;
            }, 500); // Keep overall delay for setups
        };

        // åœ¨æ›´æ–°itemsè®¡æ•°çš„å‡½æ•°ä¸­ä¹Ÿç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
        const originalUpdateItemsCount = updateItemsCount;
        updateItemsCount = function() {
            // ç¡®ä¿é€‰æ‹©ä¿¡æ¯å­˜åœ¨
            ensureSelectionInfoExists();
            
            // è°ƒç”¨åŸå§‹å‡½æ•°
            originalUpdateItemsCount();
            
            // å¦‚æœè®¾ç½®å¯¹è¯æ¡†å¯è§ï¼Œç«‹å³æ›´æ–°å…¶ä¸­çš„è®¡æ•°
            updateSettingsItemCount();
        };

        // ä½¿ç”¨Canvas APIç”Ÿæˆæ–‡å­—å›¾ç‰‡
        function generateTextCardImage(text, width = 300, height = 450) {
            // æ ¹æ®å½“å‰å›¾åƒæ¯”ä¾‹è°ƒæ•´å®½é«˜
            let aspectRatio = getAspectRatioValues(currentImageRatio);
            if (aspectRatio) {
                // ä¿æŒæ€»é¢ç§¯å¤§è‡´ç›¸åŒ
                const area = width * height;
                const newHeight = Math.sqrt(area / aspectRatio);
                const newWidth = newHeight * aspectRatio;
                
                width = Math.round(newWidth);
                height = Math.round(newHeight);
                
                console.log(`ä¸º${currentImageRatio}æ¯”ä¾‹è°ƒæ•´å›¾ç‰‡å°ºå¯¸: ${width}x${height}`);
            }
            
            // åˆ›å»ºCanvaså…ƒç´ 
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            
            // è·å–ç»˜å›¾ä¸Šä¸‹æ–‡
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#ffffff';  // ç™½è‰²èƒŒæ™¯
            ctx.fillRect(0, 0, width, height);
            
            // è®¾ç½®æ–‡æœ¬æ ·å¼
            ctx.fillStyle = '#000000';  // é»‘è‰²æ–‡å­—
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // æ ¹æ®æ–‡æœ¬é•¿åº¦åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
            const maxTextLength = text.length;
            let fontSize = 60; // å¢å¤§é»˜è®¤å­—ä½“å¤§å°ï¼ˆåŸæ¥æ˜¯40ï¼‰
            
            // æ ¹æ®æ–‡æœ¬é•¿åº¦è°ƒæ•´å­—å·
            if (maxTextLength > 5) fontSize = 52;   // åŸæ¥æ˜¯36
            if (maxTextLength > 10) fontSize = 46;  // åŸæ¥æ˜¯32
            if (maxTextLength > 15) fontSize = 40;  // åŸæ¥æ˜¯28
            if (maxTextLength > 20) fontSize = 34;  // åŸæ¥æ˜¯24
            if (maxTextLength > 25) fontSize = 30;  // åŸæ¥æ˜¯20
            if (maxTextLength > 30) fontSize = 26;  // åŸæ¥æ˜¯18
            if (maxTextLength > 40) fontSize = 22;  // åŸæ¥æ˜¯16
            if (maxTextLength > 50) fontSize = 18;  // åŸæ¥æ˜¯14
            
            ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "å¾®è½¯é›…é»‘", "SimHei", "é»‘ä½“", sans-serif`;
            
            // å‡†å¤‡æ–‡æœ¬
            const maxCharsPerLine = Math.floor(width / (fontSize * 1.0)); // å¢å¤§ç³»æ•°ä»0.6åˆ°1.0ï¼Œå‡å°‘æ¯è¡Œå­—ç¬¦æ•°
            const lines = [];
            let currentLine = '';
            
            // åˆ†è¡Œå¤„ç†
            for (let i = 0; i < text.length; i++) {
                currentLine += text[i];
                
                // å½“è¾¾åˆ°æ¯è¡Œæœ€å¤§å­—ç¬¦æ•°æˆ–é‡åˆ°æ¢è¡Œç¬¦æ—¶åˆ›å»ºæ–°è¡Œ
                if (currentLine.length >= maxCharsPerLine || text[i] === '\n' || i === text.length - 1) {
                    lines.push(currentLine);
                    currentLine = '';
                }
            }
            
            // å¦‚æœæœ€åä¸€è¡Œæœ‰å†…å®¹ä½†æœªæ·»åŠ ï¼Œåˆ™æ·»åŠ 
            if (currentLine.length > 0) {
                lines.push(currentLine);
            }
            
            // ç»˜åˆ¶å¤šè¡Œæ–‡æœ¬
            const lineHeight = fontSize * 1.2;
            const totalTextHeight = lines.length * lineHeight;
            const startY = (height - totalTextHeight) / 2 + lineHeight / 2;
            
            // é€è¡Œç»˜åˆ¶æ–‡æœ¬
            lines.forEach((line, index) => {
                ctx.fillText(line, width / 2, startY + index * lineHeight);
            });
            
            // æ·»åŠ è¾¹æ¡†
            ctx.strokeStyle = '#dddddd';
            ctx.lineWidth = 2;
            ctx.strokeRect(2, 2, width - 4, height - 4);
            
            // å¦‚æœæ˜¯åœ†å½¢æ¯”ä¾‹ï¼Œè£å‰ªæˆåœ†å½¢
            if (currentImageRatio === 'round') {
                const tempCanvas = document.createElement('canvas');
                const size = Math.min(width, height);
                tempCanvas.width = size;
                tempCanvas.height = size;
                const tempCtx = tempCanvas.getContext('2d');
                
                // åˆ›å»ºåœ†å½¢è£å‰ªåŒºåŸŸ
                tempCtx.beginPath();
                tempCtx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
                tempCtx.closePath();
                tempCtx.clip();
                
                // ç»˜åˆ¶åŸå§‹canvaså†…å®¹
                tempCtx.drawImage(canvas, (width-size)/2, (height-size)/2, size, size, 0, 0, size, size);
                
                // è½¬æ¢ä¸ºdata URL
                return tempCanvas.toDataURL('image/png');
            }
            
            // è½¬æ¢ä¸ºdata URL
            return canvas.toDataURL('image/png');
        }
        
        // æ ¹æ®å›¾åƒæ¯”ä¾‹åç§°è·å–å®½é«˜æ¯”
        function getAspectRatioValues(ratioName) {
            switch(ratioName) {
                case 'portrait':
                    return 2/3; // å®½/é«˜
                case 'landscape':
                    return 3/2;
                case 'square':
                case 'round':
                    return 1/1;
                default:
                    return null;
            }
        }

        // ä¸ºæ–‡å­—å¡ç‰‡æ›´æ–°å›¾ç‰‡
        function updateTextCardImage(item) {
            if (!item || !item.isTextGenerated) return;
            
            // ä½¿ç”¨Canvas APIç”Ÿæˆæ–°å›¾ç‰‡
            const newImgUrl = generateTextCardImage(item.title);
            
            // æ›´æ–°å›¾ç‰‡URL
            item.img = newImgUrl;
            
            // æ›´æ–°æœ¬åœ°itemsä¸­çš„å›¾ç‰‡
            const localItem = localItems.find(i => i.id === item.id);
            if (localItem) {
                localItem.img = newImgUrl;
            }
            
            // æ›´æ–°å›¾ç‰‡ç¼“å­˜
            imageCache[item.id] = newImgUrl;
            
            console.log(`æ–‡å­—å¡ç‰‡å›¾ç‰‡å·²æ›´æ–°: ID=${item.id}, æ–‡æœ¬="${item.title}"`);
        }

        // ä»æ–‡æœ¬åˆ›å»ºitem
        function createItemsFromText(text) {
            if (!text) return;
            
            // æŒ‰è¡Œåˆ†å‰²è¾“å…¥
            const lines = text.trim().split('\n').filter(line => line.trim());
            console.log(`ä»æ–‡æœ¬åˆ›å»ºitems: ${lines.length}è¡Œ`);
            
            if (lines.length === 0) return;
            
            // ä¸ºæ¯è¡Œåˆ›å»ºä¸€ä¸ªitem
            const newItems = lines.map(line => {
                // åˆ›å»ºå”¯ä¸€ID
                const id = Date.now() + Math.floor(Math.random() * 10000);
                
                // ä½¿ç”¨Canvas APIç”Ÿæˆå›¾ç‰‡
                const imgUrl = generateTextCardImage(line);
                
                // åˆ›å»ºitemå¯¹è±¡
                return {
                    id,
                    title: line,
                    img: imgUrl,
                    isTextGenerated: true // æ ‡è®°ä¸ºæ–‡æœ¬ç”Ÿæˆçš„å¡ç‰‡
                };
            });
            
            // æ·»åŠ åˆ°itemså’ŒunclassifiedItemsæ•°ç»„
            newItems.forEach(item => {
                items.push(item);
                localItems.push(item);
                unclassifiedItems.push(item.id);
                
                // æ›´æ–°å›¾ç‰‡ç¼“å­˜
                imageCache[item.id] = item.img;
            });
            
            // ä¿å­˜åˆ°localStorage
            saveItemsToLocalStorage();
            
            // æ›´æ–°itemsè®¡æ•° - ç¡®ä¿å³ä½¿åœ¨è®¾ç½®å¯¹è¯æ¡†ä¸­ä¹Ÿæ›´æ–°
            updateItemsCount();
            forceUpdateItemsCount();
            
            // é‡æ–°æ¸²æŸ“
            rerenderAll();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage(i18n.t('cardsCreated', { count: newItems.length }));
        }

        // è®¾ç½®æ ‡é¢˜ç¼–è¾‘äº‹ä»¶
        function setupResetButton() {
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                resetBtn.onclick = showResetConfirmDialog;
                console.log('ResetæŒ‰é’®å·²è®¾ç½®');
            } else {
                console.warn('æ‰¾ä¸åˆ°ResetæŒ‰é’®');
            }
        }

        // æ˜¾ç¤ºé‡ç½®ç¡®è®¤å¯¹è¯æ¡†
        function showResetConfirmDialog() {
            // æ˜¾ç¤ºæ¨¡æ€çª—å£å’Œé®ç½©
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('reset-confirm-modal').style.display = 'block';
            
            // ç»‘å®šç¡®è®¤æŒ‰é’®äº‹ä»¶
            const confirmBtn = document.getElementById('confirm-reset-btn');
            const cancelBtn = document.getElementById('cancel-reset-btn');
            
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœ‰ï¼‰
            confirmBtn.removeEventListener('click', handleResetConfirm);
            cancelBtn.removeEventListener('click', handleResetCancel);
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            confirmBtn.addEventListener('click', handleResetConfirm);
            cancelBtn.addEventListener('click', handleResetCancel);
            
            // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç¿»è¯‘
            if (typeof i18n !== 'undefined' && i18n.applyTranslations) {
                document.getElementById('confirm-reset-btn').textContent = i18n.t('confirmReset');
            }
        }

        // å¤„ç†é‡ç½®ç¡®è®¤
        function handleResetConfirm() {
            // å…³é—­æ¨¡æ€çª—å£
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('reset-confirm-modal').style.display = 'none';
            
            // æ‰§è¡Œé‡ç½®æ“ä½œ
            performReset();
        }

        // å¤„ç†å–æ¶ˆé‡ç½®
        function handleResetCancel() {
            // å…³é—­æ¨¡æ€çª—å£
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('reset-confirm-modal').style.display = 'none';
        }

        // å®é™…æ‰§è¡Œé‡ç½®çš„å‡½æ•°
        function performReset() {
            console.log('é‡ç½®æ‰€æœ‰é¡¹ç›®åˆ†ç±»å’Œè·³è¿‡çŠ¶æ€');
            
            // ä¿å­˜åŸå§‹å¯¼å…¥é¡ºåºçš„å‰¯æœ¬
            const originalOrder = [...items.map(item => item.id)];
            console.log('åŸå§‹å¯¼å…¥é¡ºåº:', originalOrder);
            
            // å°†æ‰€æœ‰å·²åˆ†ç±»é¡¹ç›®ç§»å›æœªåˆ†ç±»
            let allItemsToUnclassify = [];
            
            // è·å–æ‰€æœ‰å·²åˆ†ç±»é¡¹ç›®ID
            classifiedItems.forEach(item => {
                if (!unclassifiedItems.includes(item.id)) {
                    allItemsToUnclassify.push(item.id);
                }
            });
            console.log('éœ€è¦å–æ¶ˆåˆ†ç±»çš„é¡¹ç›®:', allItemsToUnclassify);
            
            // æ¸…ç©ºclassifiedItems
            classifiedItems = [];
            
            // å°†æ‰€æœ‰é¡¹ç›®æ·»åŠ åˆ°æœªåˆ†ç±»åˆ—è¡¨
            unclassifiedItems = unclassifiedItems.concat(allItemsToUnclassify);
            
            // æ ¹æ®åŸå§‹é¡ºåºé‡æ–°æ’åºæœªåˆ†ç±»é¡¹ç›®
            unclassifiedItems.sort((a, b) => {
                return originalOrder.indexOf(a) - originalOrder.indexOf(b);
            });
            
            // æ¸…ç©ºè·³è¿‡çŠ¶æ€
            skippedItems.clear();
            saveSkippedItems();
            console.log('æ¸…ç©ºå¹¶ä¿å­˜è·³è¿‡çŠ¶æ€');
            
            // é‡ç½®é¢„è§ˆçŠ¶æ€
            previewIdx = 0;
            previewMode = 'unclassified';
            
            // ä¿å­˜åˆ†ç±»çŠ¶æ€ - æ›¿æ¢ä¸ºæ›´å…¨é¢çš„ä¿å­˜å‡½æ•°
            saveItemsToLocalStorage();
            console.log('ä¿å­˜æ‰€æœ‰æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨');
            
            // é‡æ–°æ¸²æŸ“
            rerenderAll();
            console.log('é‡ç½®å®Œæˆï¼Œæœªåˆ†ç±»é¡¹ç›®:', unclassifiedItems);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage(i18n.t('resetSuccess') || 'é‡ç½®æˆåŠŸ');
        }

        // ä¿®æ”¹åŸæœ‰çš„resetAllItemså‡½æ•°ä¸ºshowResetConfirmDialog
        function resetAllItems() {
            showResetConfirmDialog();
        }

        // å•ç‹¬æ›´æ–°tierè®¾ç½®é¢æ¿ä¸­çš„é¢œè‰²ï¼Œä¸é‡æ–°åˆ›å»ºSortable
        function updateTierSettingsColors() {
            // éå†è®¾ç½®é¢æ¿ä¸­çš„æ‰€æœ‰tierè¡Œ
            const rows = document.querySelectorAll('#tier-settings-body tr');
            rows.forEach(row => {
                const tier = row.getAttribute('data-tier');
                if (!tier) return;
                
                // æ‰¾åˆ°é¢œè‰²é¢„è§ˆå…ƒç´ 
                const colorPreview = row.querySelector('.tier-color-preview');
                if (colorPreview) {
                    // æ›´æ–°é¢œè‰²
                    const tierColor = tierManager.getTierColor(tier);
                    colorPreview.style.backgroundColor = tierColor;
                }
            });
        }

        // è®¾ç½®ä¸‹è½½æŒ‰é’®äº‹ä»¶
        function setupDownloadButton() {
            const downloadBtn = document.getElementById('download-btn');
            if (downloadBtn) {
                downloadBtn.onclick = downloadAllItems;
                console.log('DownloadæŒ‰é’®å·²è®¾ç½®');
            } else {
                console.warn('æ‰¾ä¸åˆ°DownloadæŒ‰é’®');
            }
        }

        // è·å–å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®
        async function getImageBinary(url) {
            try {
                // å¦‚æœæ˜¯Data URLï¼Œç›´æ¥è½¬æ¢ä¸ºBlob
                if (url.startsWith('data:')) {
                    const response = await fetch(url);
                    return await response.blob();
                }
                
                // å¦‚æœæ˜¯å¤–éƒ¨URLï¼Œé€šè¿‡fetchè·å–
                const response = await fetch(url, { mode: 'cors' });
                return await response.blob();
            } catch (error) {
                console.error('è·å–å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®å¤±è´¥:', error);
                // è¿”å›ä¸€ä¸ªç©ºçš„Blobä½œä¸ºé”™è¯¯çš„æ›¿ä»£
                return new Blob(['Error loading image'], {type: 'text/plain'});
            }
        }

        // æå–æ–‡ä»¶æ‰©å±•å
        function getExtensionFromUrl(url) {
            if (url.startsWith('data:image/')) {
                // ä»data URLæå–MIMEç±»å‹
                const match = url.match(/data:image\/([a-zA-Z0-9]+);/);
                return match ? match[1] : 'png';
            } else {
                // ä»URLæå–æ‰©å±•å
                const match = url.match(/\.([a-zA-Z0-9]+)(?:\?|$)/);
                return match ? match[1] : 'jpg';
            }
        }

        // ä¸‹è½½æ‰€æœ‰æœªè·³è¿‡çš„é¡¹ç›®å›¾ç‰‡
        async function downloadAllItems() {
            console.log("downloadAllItemså‡½æ•°è¢«è°ƒç”¨");
            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator();
                
                // ç¡®ä¿itemså˜é‡å­˜åœ¨ä¸”ä¸ºæ•°ç»„
                if (!items || !Array.isArray(items)) {
                    console.error("itemså˜é‡ä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„:", items);
                    alert("æ— æ³•è®¿é—®é¡¹ç›®æ•°æ®ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•");
                    hideLoadingIndicator();
                    return;
                }
                
                // ç¡®ä¿skippedItemså˜é‡å­˜åœ¨
                if (!skippedItems) {
                    console.error("skippedItemså˜é‡ä¸å­˜åœ¨");
                    skippedItems = new Set(); // åˆ›å»ºä¸€ä¸ªç©ºSetä½œä¸ºåå¤‡
                }
                
                // æ”¶é›†æ‰€æœ‰æœªè·³è¿‡çš„é¡¹ç›®
                const itemsToDownload = items.filter(item => !skippedItems.has(item.id));
                console.log(`å‡†å¤‡ä¸‹è½½ ${itemsToDownload.length} ä¸ªé¡¹ç›®çš„å›¾ç‰‡:`, itemsToDownload);
                
                if (itemsToDownload.length === 0) {
                    console.log("æ²¡æœ‰é¡¹ç›®å¯ä¸‹è½½");
                    
                    // ç¡®ä¿i18nå¯ç”¨
                    let message = "æ²¡æœ‰é¡¹ç›®å¯ä¸‹è½½ï¼Œæ‰€æœ‰é¡¹ç›®éƒ½å·²è¢«è·³è¿‡ã€‚";
                    try {
                        message = i18n.t('noItemsToDownload');
                    } catch (e) {
                        console.error("i18nè°ƒç”¨å¤±è´¥:", e);
                    }
                    
                    alert(message);
                    hideLoadingIndicator();
                    return;
                }
                
                // æ£€æŸ¥JSZipæ˜¯å¦å¯ç”¨
                if (typeof JSZip !== 'function') {
                    console.error("æ‰¾ä¸åˆ°JSZipåº“ï¼Œè¯·ç¡®ä¿å·²åŠ è½½JSZip");
                    alert("æ‰¾ä¸åˆ°å‹ç¼©åŠŸèƒ½ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸å¹¶åˆ·æ–°é¡µé¢");
                    hideLoadingIndicator();
                    return;
                }
                
                // åˆ›å»ºä¸€ä¸ªæ–°çš„JSZipå®ä¾‹
                const zip = new JSZip();
                
                // åˆ›å»ºè¿›åº¦è®¡æ•°å™¨
                let processedCount = 0;
                
                // æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
                const MAX_CONCURRENT = 5;
                
                // åˆ†æ‰¹å¤„ç†å›¾ç‰‡
                for (let i = 0; i < itemsToDownload.length; i += MAX_CONCURRENT) {
                    const batch = itemsToDownload.slice(i, i + MAX_CONCURRENT);
                    console.log(`å¤„ç†æ‰¹æ¬¡ ${i/MAX_CONCURRENT + 1}/${Math.ceil(itemsToDownload.length/MAX_CONCURRENT)}`);
                    
                    // å¹¶å‘å¤„ç†å½“å‰æ‰¹æ¬¡
                    await Promise.all(batch.map(async (item, index) => {
                        try {
                            // è·å–å›¾ç‰‡æ‰©å±•å
                            const extension = getExtensionFromUrl(item.img);
                            
                            // æ„å»ºå®‰å…¨çš„æ–‡ä»¶å - ç›´æ¥ä½¿ç”¨itemçš„æ ‡é¢˜ï¼Œä¸æ·»åŠ item_å’ŒIDå‰ç¼€
                            const title = item.title || "æ— æ ‡é¢˜";
                            const fileName = `${title.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5]/g, '_').substring(0, 100)}.${extension}`;
                            console.log(`å¤„ç†é¡¹ç›®: ${item.id}, æ–‡ä»¶å: ${fileName}`);
                            
                            // è·å–å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®
                            const imageBlob = await getImageBinary(item.img);
                            
                            // æ£€æŸ¥blobæ˜¯å¦æœ‰æ•ˆ
                            if (!imageBlob || imageBlob.size === 0) {
                                console.error(`é¡¹ç›® ${item.id} çš„å›¾ç‰‡æ— æ•ˆ`);
                                return;
                            }
                            
                            // å°†å›¾ç‰‡æ·»åŠ åˆ°zip
                            zip.file(fileName, imageBlob);
                            console.log(`é¡¹ç›® ${item.id} å·²æ·»åŠ åˆ°zip`);
                            
                            // æ›´æ–°è¿›åº¦
                            processedCount++;
                            updateLoadingProgress(processedCount, itemsToDownload.length);
                            
                        } catch (err) {
                            console.error(`å¤„ç†é¡¹ç›® ${item.id} å¤±è´¥:`, err);
                        }
                    }));
                }
                
                // ç”Ÿæˆzipæ–‡ä»¶
                console.log("æ­£åœ¨ç”Ÿæˆzipæ–‡ä»¶...");
                let generatingZipText = "ç”Ÿæˆå‹ç¼©æ–‡ä»¶ä¸­";
                try {
                    generatingZipText = i18n.t('generatingZip');
                } catch (e) {
                    console.warn("i18næŸ¥æ‰¾ç¿»è¯‘å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡æœ¬");
                }
                
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 6
                    }
                }, (metadata) => {
                    updateLoadingProgress(metadata.percent | 0, 100, generatingZipText);
                });
                
                console.log("zipæ–‡ä»¶ç”Ÿæˆå®Œæˆï¼Œå¤§å°:", content.size);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(content);
                const link = document.createElement("a");
                link.href = url;
                
                // è®¾ç½®æ–‡ä»¶å
                const mainTitle = document.getElementById('main-title');
                const title = mainTitle ? mainTitle.textContent : "TierMaker";
                const safeTitle = title.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5]/g, '_').substring(0, 50);
                link.download = `tiermaker_${safeTitle}_${new Date().toISOString().slice(0,10)}.zip`;
                
                console.log("å‡†å¤‡ä¸‹è½½æ–‡ä»¶:", link.download);
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // æ¸…ç†URLå¯¹è±¡
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 100);
                
                console.log("ä¸‹è½½å®Œæˆ!");
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                let completeMessage = "ä¸‹è½½å®Œæˆ";
                try {
                    completeMessage = i18n.t('downloadComplete');
                } catch (e) {
                    console.warn("i18næŸ¥æ‰¾ç¿»è¯‘å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡æœ¬");
                }
                showSuccessMessage(completeMessage);
                
            } catch (error) {
                console.error("ä¸‹è½½å¤±è´¥:", error);
                
                let errorMessage = "ä¸‹è½½å¤±è´¥";
                try {
                    errorMessage = i18n.t('downloadError');
                } catch (e) {
                    console.warn("i18næŸ¥æ‰¾ç¿»è¯‘å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡æœ¬");
                }
                
                alert(errorMessage + ": " + (error.message || "æœªçŸ¥é”™è¯¯"));
            } finally {
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideLoadingIndicator();
            }
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator() {
            console.log("æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨");
            let loadingOverlay = document.getElementById('loading-overlay');
            
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.position = 'fixed';
                loadingOverlay.style.top = '0';
                loadingOverlay.style.left = '0';
                loadingOverlay.style.width = '100%';
                loadingOverlay.style.height = '100%';
                loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.flexDirection = 'column';
                loadingOverlay.style.justifyContent = 'center';
                loadingOverlay.style.alignItems = 'center';
                loadingOverlay.style.zIndex = '9999';
                
                const spinner = document.createElement('div');
                spinner.className = 'loading-spinner';
                spinner.style.border = '5px solid #f3f3f3';
                spinner.style.borderTop = '5px solid #3498db';
                spinner.style.borderRadius = '50%';
                spinner.style.width = '50px';
                spinner.style.height = '50px';
                spinner.style.animation = 'spin 2s linear infinite';
                
                const loadingText = document.createElement('div');
                loadingText.id = 'loading-text';
                loadingText.style.color = 'white';
                loadingText.style.marginTop = '20px';
                loadingText.style.fontSize = '18px';
                
                // è·å–ç¿»è¯‘æ–‡æœ¬ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
                let preparingText = "å‡†å¤‡ä¸‹è½½...";
                try {
                    preparingText = i18n.t('preparingDownload');
                } catch (e) {
                    console.warn("i18nç¿»è¯‘è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡æœ¬:", e);
                }
                loadingText.textContent = preparingText;
                
                const progressBar = document.createElement('div');
                progressBar.style.width = '300px';
                progressBar.style.height = '20px';
                progressBar.style.backgroundColor = '#444';
                progressBar.style.marginTop = '15px';
                progressBar.style.borderRadius = '10px';
                progressBar.style.overflow = 'hidden';
                
                const progressFill = document.createElement('div');
                progressFill.id = 'progress-fill';
                progressFill.style.width = '0%';
                progressFill.style.height = '100%';
                progressFill.style.backgroundColor = '#3498db';
                progressFill.style.transition = 'width 0.3s';
                
                progressBar.appendChild(progressFill);
                loadingOverlay.appendChild(spinner);
                loadingOverlay.appendChild(loadingText);
                loadingOverlay.appendChild(progressBar);
                
                // æ·»åŠ CSSåŠ¨ç”»
                const style = document.createElement('style');
                style.innerHTML = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(loadingOverlay);
                console.log("åŠ è½½æŒ‡ç¤ºå™¨å·²åˆ›å»º");
            } else {
                // è·å–ç¿»è¯‘æ–‡æœ¬ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
                let preparingText = "å‡†å¤‡ä¸‹è½½...";
                try {
                    preparingText = i18n.t('preparingDownload');
                } catch (e) {
                    console.warn("i18nç¿»è¯‘è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡æœ¬:", e);
                }
                
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = preparingText;
                }
                
                const progressFill = document.getElementById('progress-fill');
                if (progressFill) {
                    progressFill.style.width = '0%';
                }
                
                loadingOverlay.style.display = 'flex';
                console.log("åŠ è½½æŒ‡ç¤ºå™¨å·²æ˜¾ç¤º");
            }
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // æ›´æ–°åŠ è½½è¿›åº¦
        function updateLoadingProgress(current, total, customMessage = null) {
            console.log(`æ›´æ–°è¿›åº¦: ${current}/${total} (${Math.floor((current/total)*100)}%)`);
            const percentage = Math.min(100, Math.floor((current / total) * 100));
            const progressFill = document.getElementById('progress-fill');
            const loadingText = document.getElementById('loading-text');
            
            if (progressFill) {
                progressFill.style.width = `${percentage}%`;
            } else {
                console.warn('æ‰¾ä¸åˆ°è¿›åº¦æ¡å…ƒç´  progress-fill');
            }
            
            if (loadingText) {
                try {
                    if (customMessage) {
                        loadingText.textContent = `${customMessage} (${percentage}%)`;
                    } else {
                        let processingText = "å¤„ç†å›¾ç‰‡ä¸­";
                        try {
                            processingText = i18n.t('processingImages');
                        } catch (e) {
                            console.warn('i18nç¿»è¯‘è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡æœ¬');
                        }
                        loadingText.textContent = `${processingText}: ${current}/${total} (${percentage}%)`;
                    }
                } catch (e) {
                    console.error('æ›´æ–°åŠ è½½æ–‡æœ¬æ—¶å‡ºé”™:', e);
                }
            } else {
                console.warn('æ‰¾ä¸åˆ°åŠ è½½æ–‡æœ¬å…ƒç´  loading-text');
            }
        }
        
        // æ·»åŠ ç›´æ¥äº‹ä»¶ç»‘å®šï¼Œç¡®ä¿ä¸‹è½½æŒ‰é’®äº‹ä»¶è¢«æ­£ç¡®è®¾ç½®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - å‡†å¤‡ç»‘å®šä¸‹è½½æŒ‰é’®');
            const downloadBtn = document.getElementById('download-btn');
            if (downloadBtn) {
                console.log('æ‰¾åˆ°ä¸‹è½½æŒ‰é’®ï¼Œæ­£åœ¨ç»‘å®šäº‹ä»¶');
                downloadBtn.addEventListener('click', function() {
                    console.log('ä¸‹è½½æŒ‰é’®è¢«ç‚¹å‡»');
                    downloadAllItems();
                });
            } else {
                console.error('æ‰¾ä¸åˆ°ä¸‹è½½æŒ‰é’®å…ƒç´ !');
            }
        });

        // æ·»åŠ åœ¨document.addEventListener('DOMContentLoaded', function() { åé¢

        // è®¾ç½®item-previewæµ®åŠ¨å±…ä¸­
        // function setupItemPreviewFloat() { // This function is now replaced/enhanced by dynamicItemPreviewPositioning
        //     // åªåœ¨éæ‰‹æœºå±å¹•ä¸Šåº”ç”¨
        //     if (window.innerWidth < 768) return;
            
        //     const mainContainer = document.querySelector('.main-container');
        //     const itemPreview = document.querySelector('.item-preview');
            
        //     if (!mainContainer || !itemPreview) return;
            
        //     // ç¡®ä¿ä¸»å®¹å™¨æœ‰æ­£ç¡®çš„æ ·å¼
        //     mainContainer.style.display = 'flex';
        //     mainContainer.style.alignItems = 'flex-start';
        //     mainContainer.style.position = 'relative';
            
        //     // è®¾ç½®tierListContainer
        //     const tierListContainer = document.querySelector('.tier-list-container');
        //     if (tierListContainer) {
        //         tierListContainer.style.flex = '1';
        //         tierListContainer.style.marginRight = '10px';
        //     }
            
        //     // è®¾ç½®itemPreview
        //     itemPreview.style.position = 'sticky';
        //     itemPreview.style.top = '50vh';
        //     itemPreview.style.transform = 'translateY(-50%)';
        //     itemPreview.style.maxHeight = '90vh';
        //     itemPreview.style.width = '300px';
        //     itemPreview.style.flexShrink = '0';
        //     itemPreview.style.zIndex = '5';
            
        //     console.log('Item Preview æµ®åŠ¨è®¾ç½®å·²åº”ç”¨');
        // }
        
        // é¡µé¢åŠ è½½å’Œçª—å£è°ƒæ•´å¤§å°æ—¶éƒ½åº”ç”¨è®¾ç½®
        // window.addEventListener('load', setupItemPreviewFloat); // Replaced by dynamicItemPreviewPositioning listeners
        // window.addEventListener('resize', setupItemPreviewFloat); // Replaced by dynamicItemPreviewPositioning listeners


        // ========== New JavaScript for dynamic item preview positioning ==========
        function dynamicItemPreviewPositioning() {
            const itemPreview = document.querySelector('.item-preview');
            const tierListContainer = document.querySelector('.tier-list-container'); // Needed for horizontal positioning
            const itemsContainer = document.querySelector('.items-container');
            const header = document.querySelector('.header');

            if (!itemPreview || !tierListContainer || !itemsContainer || !header) {
                console.warn('DynamicPositioning: Missing one or more required elements.');
                return;
            }

            if (window.innerWidth < 768) {
                // For smaller screens, reset styles if it was fixed, or rely on base CSS
                itemPreview.style.position = ''; // Revert to default (likely from base.css or layout.css)
                itemPreview.style.top = '';
                itemPreview.style.left = '';
                itemPreview.style.transform = '';
                return;
            } else {
                // Ensure it's fixed for larger screens if previously reset
                itemPreview.style.position = 'fixed';
                itemPreview.style.transform = 'translateY(-50%)'; // Re-apply transform if cleared
            }
            
            const viewportHeight = window.innerHeight;
            const itemPreviewHeight = itemPreview.offsetHeight;
            const headerRect = header.getBoundingClientRect();
            const itemsContainerRect = itemsContainer.getBoundingClientRect();
            const tierListContainerRect = tierListContainer.getBoundingClientRect();

            if (itemPreviewHeight === 0) {
                console.warn('DynamicPositioning: itemPreviewHeight is 0, skipping.');
                return; 
            }

            // Vertical Positioning
            const gap = 10; // Universal gap
            const idealCenterY = viewportHeight / 2;

            // Define bounds for the center of itemPreview
            const lowerBoundFromHeader = headerRect.bottom + (itemPreviewHeight / 2) + gap;
            const upperBoundFromItemsContainer = itemsContainerRect.top - (itemPreviewHeight / 2) - gap;

            let effectiveLowerBound = lowerBoundFromHeader;
            const absMinTop = 20;
            if (headerRect.bottom < absMinTop) {
                // If header is scrolled out, there's an additional effective lower bound 
                // to keep the top of itemPreview at least at absMinTop.
                const lowerBoundFromAbsMinTop = absMinTop + (itemPreviewHeight / 2);
                effectiveLowerBound = Math.max(lowerBoundFromHeader, lowerBoundFromAbsMinTop);
            }

            let targetCenterY = idealCenterY;
            targetCenterY = Math.max(targetCenterY, effectiveLowerBound); // Apply the most restrictive lower bound
            targetCenterY = Math.min(targetCenterY, upperBoundFromItemsContainer); // Always respect the upper bound from items container
            
            itemPreview.style.top = targetCenterY + 'px';

            // Horizontal Positioning
            itemPreview.style.left = tierListContainerRect.right + gap + 'px';

            const calculatedTopEdge = targetCenterY - (itemPreviewHeight / 2);
            const calculatedBottomEdge = targetCenterY + (itemPreviewHeight / 2);

            console.log('[Debug] Final Positioning:', {
                targetCenterY_final: targetCenterY,
                styleTopApplied: itemPreview.style.top,
                calculatedTopEdge_viewport: calculatedTopEdge,
                calculatedBottomEdge_viewport: calculatedBottomEdge,
                itemsContainer_actualTop_viewport: itemsContainerRect.top,
                header_actualBottom_viewport: headerRect.bottom,
                itemPreviewHeight_used: itemPreviewHeight,
                viewportHeight_used: viewportHeight,
                minCenterY_calc: effectiveLowerBound, // Updated to show the actual lower bound used
                maxCenterY_calc: upperBoundFromItemsContainer,
                idealCenterY_calc: idealCenterY
            });
        }

        window.addEventListener('scroll', dynamicItemPreviewPositioning, { passive: true });
        window.addEventListener('resize', dynamicItemPreviewPositioning);

        window.addEventListener('load', () => {
            setTimeout(dynamicItemPreviewPositioning, 200); 
        });

        const existingRerenderAll = rerenderAll; 
        rerenderAll = function() {
            existingRerenderAll();
            setTimeout(dynamicItemPreviewPositioning, 0);
        }
        // ========== End of new JavaScript ==========


        // ========== åˆ†äº«åŠŸèƒ½å®ç° ==========

        // è®¾ç½®åˆ†äº«æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('share-btn').addEventListener('click', () => {
            openShareModal();
        });

        // æ‰“å¼€åˆ†äº«æ¨¡æ€çª—å£åç›´æ¥ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.close-share-modal').forEach(btn => {
            btn.onclick = closeShareModal;
        });

        // æ‰“å¼€åˆ†äº«æ¨¡æ€çª—å£
        function openShareModal() {
            // æ˜¾ç¤ºæ¨¡æ€çª—å£å’Œé®ç½©
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('share-modal').style.display = 'block';
            
            // ç”Ÿæˆé¢„è§ˆ
            generateTierListPreview();
            
            // æ›´æ–°åˆ†äº«é“¾æ¥
            updateShareLink();
            
            // ç¿»è¯‘ç•Œé¢
            translateShareModal();
            
            // ç»‘å®šäº‹ä»¶
            setupShareEvents();
        }

        // ç”Ÿæˆé¢„è§ˆå›¾
        function generateTierListPreview() {
            const previewContainer = document.getElementById('tierlist-preview');
            previewContainer.innerHTML = '<p data-i18n="previewGenerating">Generating preview...</p>';
            
            // é˜²æ­¢åœ¨æœªæ¸²æŸ“å®Œæˆå‰è¿›è¡Œæ“ä½œ
            setTimeout(() => {
                try {
                    // å…‹éš†tier-list-containerçš„å†…å®¹
                    const tierList = document.querySelector('.tier-list-container');
                    if (!tierList) {
                        previewContainer.innerHTML = '<p>Error: Tier list not found.</p>';
                        return;
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªåŒ…å«æ ‡é¢˜å’Œtier listçš„æ–°å®¹å™¨
                    const previewContent = document.createElement('div');
                    previewContent.className = 'preview-content';
                    previewContent.style.width = '100%';
                    
                    // æ·»åŠ æ ‡é¢˜
                    const titleClone = document.createElement('h2');
                    titleClone.textContent = document.getElementById('main-title').textContent;
                    titleClone.style.textAlign = 'center';
                    titleClone.style.margin = '0 0 15px 0';
                    titleClone.style.padding = '5px';
                    titleClone.style.color = 'white';
                    previewContent.appendChild(titleClone);
                    
                    // å…‹éš†tier listï¼ˆæ·±åº¦å…‹éš†ä»¥åŒ…å«å­å…ƒç´ ï¼‰
                    const tierListClone = tierList.cloneNode(true);
                    tierListClone.style.width = '100%';
                    tierListClone.style.maxWidth = '700px';
                    tierListClone.style.margin = '0 auto';
                    
                    // æ·»åŠ æ°´å°
                    const watermarkTop = document.createElement('div');
                    watermarkTop.className = 'watermark watermark-top';
                    watermarkTop.textContent = 'Made by TierMaster';

                    // æ£€æŸ¥æ˜¯å¦æœ‰åˆ›å»ºè€…åç§°
                    const creatorName = localStorage.getItem('tiermaker-creator-name');
                    if (creatorName && creatorName.trim() !== '') {
                        const creatorLabelTop = document.createElement('div');
                        creatorLabelTop.className = 'watermark watermark-top';
                        creatorLabelTop.style.top = '30px';
                        creatorLabelTop.textContent = i18n.t('createdBy', {name: '@' + creatorName.trim()});
                        previewContent.appendChild(creatorLabelTop);
                    }
                    
                    // æ·»åŠ å³ä¸‹è§’æ°´å°
                    const watermarkBottom = document.createElement('div');
                    watermarkBottom.className = 'watermark watermark-bottom';
                    watermarkBottom.textContent = 'Made by TierMaster';

                    // æ·»åŠ åˆ›å»ºè€…ä¿¡æ¯åˆ°å³ä¸‹è§’
                    if (creatorName && creatorName.trim() !== '') {
                        const creatorLabelBottom = document.createElement('div');
                        creatorLabelBottom.className = 'watermark watermark-bottom';
                        creatorLabelBottom.style.bottom = '30px';
                        creatorLabelBottom.textContent = i18n.t('createdBy', {name: '@' + creatorName.trim()});
                        previewContent.appendChild(creatorLabelBottom);
                    }
                    
                    // æ·»åŠ åˆ°é¢„è§ˆå†…å®¹ - æ³¨æ„é¡ºåºï¼šå…ˆæ·»åŠ tier list
                    previewContent.appendChild(tierListClone);
                    previewContent.appendChild(watermarkTop);
                    previewContent.appendChild(watermarkBottom);
                    
                    // æ·»åŠ è¯„è®ºéƒ¨åˆ† - åœ¨tier listä¹‹å
                    const commentsWithItems = Object.entries(itemComments).filter(([id, comment]) => comment.trim());
                    const commentElements = [];

                    if (commentsWithItems.length > 0) {
                        commentsWithItems.forEach(([id, comment]) => {
                            const item = items.find(i => String(i.id) === String(id));
                            if (!item) return; // Skip if item not found for this comment

                            const commentItem = document.createElement('div');
                            commentItem.className = 'preview-comment-item';
                            
                            // æ·»åŠ ç¼©ç•¥å›¾
                            const thumbnail = document.createElement('div');
                            thumbnail.className = 'preview-comment-thumbnail';
                            const thumbnailImg = document.createElement('img');
                            thumbnailImg.src = item.img;
                            thumbnailImg.alt = item.title || 'Untitled';
                            thumbnail.appendChild(thumbnailImg);
                            
                            // æ·»åŠ è¯„è®ºå†…å®¹å®¹å™¨
                            const content = document.createElement('div');
                            content.className = 'preview-comment-content';
                            
                            const title = document.createElement('div');
                            title.className = 'preview-comment-title';
                            title.textContent = item.title || 'Untitled';
                            
                            const text = document.createElement('div');
                            text.className = 'preview-comment-text';
                            text.textContent = comment;

                            content.appendChild(title);
                            content.appendChild(text);
                            
                            commentItem.appendChild(thumbnail);
                            commentItem.appendChild(content);
                            commentElements.push(commentItem);
                        });
                    }

                    if (commentElements.length > 0) { // Only add section if there are actual elements
                        const commentsSection = document.createElement('div');
                        commentsSection.className = 'preview-comments';
                        
                        const commentsTitle = document.createElement('h3');
                        commentsTitle.textContent = i18n.t('comments') || 'Comments';
                        commentsTitle.style.color = '#fff';
                        commentsTitle.style.marginBottom = '15px';
                        commentsSection.appendChild(commentsTitle);

                        commentElements.forEach(el => commentsSection.appendChild(el));
                        
                        previewContent.appendChild(commentsSection);
                    }
                    
                    // æ¸…ç©ºå¹¶æ·»åŠ åˆ°é¢„è§ˆå®¹å™¨
                    previewContainer.innerHTML = '';
                    previewContainer.appendChild(previewContent);
                    
                    // è°ƒæ•´é¢„è§ˆé«˜åº¦
                    previewContainer.style.height = 'auto';
                    previewContainer.style.maxHeight = '400px';
                    
                    // ç¡®ä¿é¢„è§ˆå®¹å™¨æ»šåŠ¨åˆ°é¡¶éƒ¨
                    previewContainer.scrollTop = 0;
                    
                    console.log('Tier list preview generated with comments');
                } catch (e) {
                    console.error('Error generating preview:', e);
                    previewContainer.innerHTML = '<p>Error generating preview.</p>';
                }
            }, 100);
        }

        // æ›´æ–°åˆ†äº«é“¾æ¥
        function updateShareLink() {
            const linkInput = document.getElementById('share-link-input');
            if (linkInput) {
                // ä½¿ç”¨å½“å‰URLï¼Œæœªæ¥å¯ä»¥æ”¹ä¸ºç”Ÿæˆå”¯ä¸€åˆ†äº«é“¾æ¥
                linkInput.value = window.location.href;
            }
        }

        // ç¿»è¯‘åˆ†äº«æ¨¡æ€çª—å£
        function translateShareModal() {
            if (typeof i18n !== 'undefined' && i18n.applyTranslations) {
                try {
                    i18n.applyTranslations(document.getElementById('share-modal'));
                } catch (e) {
                    console.error('Error translating share modal:', e);
                }
            }
        }

        // è®¾ç½®åˆ†äº«ç›¸å…³äº‹ä»¶
        function setupShareEvents() {
            // ä¸‹è½½å›¾ç‰‡æŒ‰é’®
            const downloadBtn = document.getElementById('download-image-btn');
            if (downloadBtn) {
                downloadBtn.onclick = downloadTierListAsImage;
            }
            
            // å¤åˆ¶é“¾æ¥æŒ‰é’®
            const copyBtn = document.getElementById('copy-link-btn');
            if (copyBtn) {
                copyBtn.onclick = copyShareLink;
            }
            
            // ç¤¾äº¤åª’ä½“åˆ†äº«æŒ‰é’®
            document.querySelectorAll('.social-btn').forEach(btn => {
                btn.onclick = () => shareToSocialMedia(btn.getAttribute('data-platform'));
            });
            
            // å…³é—­æŒ‰é’®
            document.querySelector('.close-share-modal').onclick = closeShareModal;
        }

        // å…³é—­åˆ†äº«æ¨¡æ€çª—å£
        function closeShareModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('share-modal').style.display = 'none';
        }

        // å°†Tier Listä¸‹è½½ä¸ºå›¾ç‰‡
        async function downloadTierListAsImage() {
            try {
                showLoadingIndicator('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...');
                
                // è·å–é¢„è§ˆå†…å®¹
                const previewContent = document.querySelector('.preview-content');
                if (!previewContent) {
                    console.error('Preview content not found');
                    hideLoadingIndicator();
                    return;
                }
                
                // ä½¿ç”¨html2canvasåº“è½¬æ¢ä¸ºCanvas
                // å¦‚æœhtml2canvasåº“æœªåŠ è½½ï¼Œæ·»åŠ åº“
                if (typeof html2canvas !== 'function') {
                    await loadHtml2Canvas();
                }
                
                // ä½¿ç”¨html2canvasæ•è·å†…å®¹
                const canvas = await html2canvas(previewContent, {
                    backgroundColor: '#1a1a1a',
                    scale: 2, // æé«˜æ¸…æ™°åº¦
                    logging: false,
                    useCORS: true // å…è®¸åŠ è½½è·¨åŸŸå›¾ç‰‡
                });
                
                // è½¬æ¢ä¸ºå›¾ç‰‡
                const imgData = canvas.toDataURL('image/png');
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = imgData;
                link.download = `TierList_${document.getElementById('main-title').textContent.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5]/g, '_')}_${new Date().toISOString().slice(0,10)}.png`;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                hideLoadingIndicator();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showSuccessMessage(i18n.t('downloadSuccess') || 'Image downloaded successfully');
            } catch (error) {
                console.error('Error downloading image:', error);
                hideLoadingIndicator();
                alert('Error generating image. Please try again.');
            }
        }

        // åŠ è½½html2canvasåº“
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load html2canvas'));
                document.head.appendChild(script);
            });
        }

        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            const linkInput = document.getElementById('share-link-input');
            if (!linkInput) return;
            
            // é€‰æ‹©å¹¶å¤åˆ¶
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                // ä½¿ç”¨æ–°API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(linkInput.value)
                        .then(() => {
                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            const copyBtn = document.getElementById('copy-link-btn');
                            const originalText = copyBtn.textContent;
                            copyBtn.textContent = i18n.t('copied') || 'Copied!';
                            
                            // æ¢å¤åŸæ–‡æœ¬
                            setTimeout(() => {
                                copyBtn.textContent = originalText;
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy: ', err);
                            // å›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
                            document.execCommand('copy');
                        });
                } else {
                    // ä¼ ç»Ÿæ–¹æ³•
                    document.execCommand('copy');
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const copyBtn = document.getElementById('copy-link-btn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = i18n.t('copied') || 'Copied!';
                    
                    // æ¢å¤åŸæ–‡æœ¬
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy link');
            }
        }

        // åˆ†äº«åˆ°ç¤¾äº¤åª’ä½“
        async function shareToSocialMedia(platform) {
            try {
                // é¦–å…ˆç”Ÿæˆå›¾ç‰‡
                showLoadingIndicator(i18n.t('preparingShare') || 'Preparing to share...');
                
                // è·å–é¢„è§ˆå†…å®¹
                const previewContent = document.querySelector('.preview-content');
                if (!previewContent) {
                    hideLoadingIndicator();
                    alert('Error: Preview content not found');
                    return;
                }
                
                // åŠ è½½html2canvasåº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (typeof html2canvas !== 'function') {
                    await loadHtml2Canvas();
                }
                
                // æ•è·å†…å®¹ä¸ºå›¾ç‰‡
                const canvas = await html2canvas(previewContent, {
                    backgroundColor: '#1a1a1a',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                // è·å–å›¾ç‰‡æ•°æ®
                const imgData = canvas.toDataURL('image/png');
                
                hideLoadingIndicator();
                
                // è·å–åˆ†äº«æ–‡æœ¬
                const shareTitle = document.getElementById('main-title').textContent;
                const shareText = `Check out my tier list: ${shareTitle}`;
                const shareUrl = window.location.href;
                
                // æ ¹æ®å¹³å°è¿›è¡Œåˆ†äº«
                switch (platform) {
                    case 'twitter':
                        // Twitter/X åˆ†äº«
                        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
                        break;
                        
                    case 'facebook':
                        // Facebook åˆ†äº«
                        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
                        break;
                        
                    case 'reddit':
                        // Reddit åˆ†äº«
                        window.open(`https://www.reddit.com/submit?url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(shareTitle)}`, '_blank');
                        break;
                        
                    case 'weibo':
                        // å¾®åšåˆ†äº«
                        window.open(`http://service.weibo.com/share/share.php?url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(shareText)}`, '_blank');
                        break;
                        
                    case 'wechat':
                        // å¾®ä¿¡åˆ†äº«éœ€è¦æ˜¾ç¤ºäºŒç»´ç 
                        showWeChatQRCode(shareUrl);
                        break;
                        
                    default:
                        alert('Sharing to ' + platform + ' is not supported yet.');
                }
            } catch (error) {
                console.error('Error sharing to social media:', error);
                hideLoadingIndicator();
                alert('Error sharing. Please try again.');
            }
        }

        // æ˜¾ç¤ºå¾®ä¿¡åˆ†äº«äºŒç»´ç 
        function showWeChatQRCode(url) {
            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€çª—å£æ˜¾ç¤ºäºŒç»´ç 
            const qrModal = document.createElement('div');
            qrModal.className = 'qr-modal';
            qrModal.style.position = 'fixed';
            qrModal.style.top = '50%';
            qrModal.style.left = '50%';
            qrModal.style.transform = 'translate(-50%, -50%)';
            qrModal.style.backgroundColor = 'white';
            qrModal.style.padding = '20px';
            qrModal.style.borderRadius = '10px';
            qrModal.style.zIndex = '10000';
            qrModal.style.textAlign = 'center';
            
            // æ·»åŠ æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = i18n.t('wechatScan') || 'Scan with WeChat';
            title.style.marginBottom = '15px';
            title.style.color = 'black';
            qrModal.appendChild(title);
            
            // ç”ŸæˆäºŒç»´ç çš„å®¹å™¨
            const qrContainer = document.createElement('div');
            qrContainer.id = 'qrcode-container';
            qrContainer.style.width = '200px';
            qrContainer.style.height = '200px';
            qrContainer.style.margin = '0 auto';
            qrContainer.style.backgroundColor = '#f0f0f0';
            qrModal.appendChild(qrContainer);
            
            // æ·»åŠ è¯´æ˜æ–‡å­—
            const desc = document.createElement('p');
            desc.textContent = i18n.t('wechatShareTip') || 'Open WeChat and scan this QR code to share';
            desc.style.marginTop = '15px';
            desc.style.fontSize = '14px';
            desc.style.color = '#666';
            qrModal.appendChild(desc);
            
            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.textContent = i18n.t('close') || 'Close';
            closeBtn.style.marginTop = '15px';
            closeBtn.style.padding = '8px 15px';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.backgroundColor = '#333';
            closeBtn.style.color = 'white';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = () => {
                document.body.removeChild(qrModal);
                document.body.removeChild(overlay);
            };
            qrModal.appendChild(closeBtn);
            
            // åˆ›å»ºåŠé€æ˜é®ç½©
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.zIndex = '9999';
            overlay.onclick = () => {
                document.body.removeChild(qrModal);
                document.body.removeChild(overlay);
            };
            
            // æ·»åŠ åˆ°body
            document.body.appendChild(overlay);
            document.body.appendChild(qrModal);
            
            // åŠ è½½QRCodeåº“ï¼Œç„¶åç”ŸæˆäºŒç»´ç 
            if (typeof QRCode !== 'function') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
                script.onload = () => {
                    new QRCode(document.getElementById('qrcode-container'), {
                        text: url,
                        width: 200,
                        height: 200,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                };
                script.onerror = () => {
                    document.getElementById('qrcode-container').textContent = 'Failed to load QR code generator.';
                };
                document.head.appendChild(script);
            } else {
                new QRCode(document.getElementById('qrcode-container'), {
                    text: url,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }
    </script>
</body>
</html>